<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset=utf-8 /> 
    <meta name=viewport content="width=device-width" /> 
    <meta name="generator" content="Emacs Muse Blog" /> 
    <meta description="blog de Dimitri Fontaine, Expert PostgreSQL - 2ndQuadrant France" />
    <meta property="og:title" content="tapoueh.org"/>
    <meta property="og:type" content="non_profit"/>
    <meta property="og:url" content="http://tapoueh.org/blog/2013/02/08-PGQ-Live-Upgrade.html"/>
    <meta property="og:image" content="http://tapoueh.org/static/2ndQuadrant-cross.png"/>
    <meta property="og:site_name" content="Tapoueh"/>
    <meta property="fb:admins" content="545062436"/>

    <title>Expertise PostgreSQL</title>
    <link rel='stylesheet' type='text/css' media='all' href='../../../static/styles.css' />
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/bootstrap/css/bootstrap.min.css' />
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/FontAwesome/css/font-awesome.min.css' />

    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/highlight.js/styles/sunburst.css' />
    <script type='text/javascript' src='../../../static/highlight.js/highlight.pack.js'></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script type='text/javascript' src='../../../static/jquery-1.9.1.min.js'></script>
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/jqcloud.css' />
    <script type='text/javascript' src='../../../static/jqcloud-1.0.4.min.js'></script>

    <!-- <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/static/FontAwesome/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="/static/highlight.js/styles/sunburst.css">
    <script src="/static/highlight.js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script src="/static/jquery-1.9.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/jqcloud.css" />
    <script type="text/javascript" src="/static/jqcloud-1.0.4.min.js"></script>
    -->

    <script type="text/javascript" src="http://apis.google.com/js/plusone.js">{lang: 'fr'}</script>
    
  </head>
  <body>

   <div id="wrap">

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="nav-collapse collapse">
	<p class="pull-right">
	  <a href="http://2ndquadrant.com">
	    <img alt="logo" src="/static/2ndQuadrant-cross.png"
		 style="margin-right: 8px; margin-top: 4px; height: 32px;"/>
	  </a>
	</p>
	<div class="navbar-inner">
	 <a class="brand" style="margin-left: 0.2em; margin-top: -4px;"
	    href="http://expert-postgresql.fr/">
	  <img src="/static/expert-postgresql.png"></a>
	 <ul class="nav">
	   <li><a href="../../../blog/index.html">
               <i class="icon-book"></i> blog</a>
           </li>
	   <li><a href="../../../projects.html">
               <i class="icon-suitcase"></i> projects</a>
           </li>
	   <li><a href="../../../conferences.html">
               <i class="icon-plane"></i> confs</a>
           </li>
	   <li><a href="../../../about.html">
               <i class="icon-beer"></i> about</a>
           </li>
	   <li><a href="../../../rss/tapoueh.xml">
               <i class="icon-rss"></i> rss</a>
           </li>
	 </ul>
	</div>
      </div>
    </div>

    <div class="container">
      <div class="row">
	<div class="span4">
	  <div><ul class='breadcrumb'><li><span class='divider'><i class='icon-sitemap'></i></span></li><li><a href='../../../'>/dev/dim</a><span class='divider'>/</span></li><li><a href='../../../blog'>blog</a><span class='divider'>/</span></li><li><a href='../../../blog/2013'>2013</a><span class='divider'>/</span></li><li><a href='../../../blog/2013/02'>02</a></li></ul></div>
	  <div class='date'>Friday, February 08 2013 <i class='icon-calendar'></i></div>
	  <div style='text-align: right;'><span><a href='../../../tags/postgresql'>PostgreSQL</a>, <a href='../../../tags/skytools'>Skytools</a>, <a href='../../../tags/pgq'>PGQ</a>, <a href='../../../tags/debian'>debian</a></span> <i class='icon-tags'></i></div>
	  

	  <div style="margin-top: 1em;">
	    <div class='span2 pull-left'><a class='thumbnail' href='../../../tags/debian'><img class='img-polaroid' style='width: 160px; height: 120px;' src='../../../thumbnails/debian-logo.png' /></a></div>
	    <div id='social' class='span1 pull-right social'><ul><li><g:plusone size='tall' href='http://tapoueh.org/blog/2013/02/08-PGQ-Live-Upgrade'></g:plusone></li><li><a href='http://twitter.com/share' class='twitter-share-button' data-via='tapoueh' data-count='vertical'>Tweet</a><script type='text/javascript' src='http://platform.twitter.com/widgets.js'></script></li></ul></div>
	  </div>

	  <div id="prevnext">
	    <h3 class='prevnext'>Recent Articles</h3>
	    <div><a class='previous' href='../../../blog/2013/02/04-Another-great-FOSDEM.html'>« Another Great FOSDEM</a></div>
	    <div><a class='next pull-right' href='../../../blog/2013/02/04-Emacs-mark-word.html'>Marking whole word »</a></div>
	  </div>
	  
	  <div>
	    <div id="left-tag-cloud" class="jqcloud"
		 style="width: 300px; height: 650px; position: absolute; top: 475px;">
	    </div>
            <script>
            var word_list;
            
            $.ajax({
                type: 'GET',
                url: '/cloud.json',
                dataType: 'json',
                success: function(response) { word_list = response; },
                data: {},
                async: false
            });
             
            $(document).ready(function() {
               $("#left-tag-cloud").jQCloud(word_list,
	                {shape: "rectangular",
	                 removeOverflowing: false});
            });
            </script>
	  </div>

	</div>

	<div id="title" class="span8">
	  <h1>Live Upgrading PGQ</h1>
	</div>
	
	<div id="content" class="span8">
<p>Some 
<a href='http://skytools.projects.pgfoundry.org/skytools-3.0/doc/'>skytools</a> related new today, it's been a while. For those who where at
my 
<a href='http://tapoueh.org/blog/2013/02/04-Another-great-FOSDEM.html'>FOSDEM's talk</a> about 
<a href='https://fosdem.org/2013/schedule/event/postgresql_implementing_high_availability/'>Implementing High Availability</a> you might have heard
that I really like working with 
<a href='http://wiki.postgresql.org/wiki/Skytools#PgQ'>PGQ</a>. A new version has been released a while
ago, and the most recent verion is now 
<code>3.1.3</code>, as announced in the
<a href='http://www.postgresql.org/message-id/CACMqXCLD2je5VFqUCzjwC2s5QQVYLe6-4awJaRvqLSBEVw8_MQ@mail.gmail.com'>Skytools 3.1.3</a> email.
</p><center><img src='../../../images/software-upgrade.320.png' /></center><center><em>Upgrade time!</em></center><h2>Skytools 3.1.3 enters debian</h2><p>First news is that 
<em>Skytools 3.1.3</em> has been entering 
<a href='http://packages.debian.org/search?keywords=skytools3'>debian</a> today (I hope
that by the time you reach that URL, it's been updated to show information
according to the news here, but I might be early). As there's current a
<em>debian freeze</em> to release 
<em>wheezy</em> (and you can help 
<a href='http://www.debian.org/News/2012/20121110'>squash some bugs</a>), this
version is only getting uploaded to 
<em>experimental</em> for now. Thanks to the
tireless work of 
<a href='http://www.df7cb.de/blog/2012/apt.postgresql.org.html'>Christoph Berg</a> though, this version is already available
from 
<a href='https://wiki.postgresql.org/wiki/Apt'>apt.postgresql.org</a>.
</p><h2>Upgrading to PGQ 3</h2><p>The other news is that I've been testing 
<em>live upgrade</em> scenario where we want
to upgrade from 
<code>PGQ</code> to 
<code>PGQ3</code>, and it works pretty well, and it's quite simple
to achieve too. Here's how.
</p><p>So the first thing is to shut down the current 
<em>ticker</em> process. Then we
install the new packages, assuming that you did follow the step in the wiki
pointed above, please go read 
<a href='https://wiki.postgresql.org/wiki/Apt'>apt.postgresql.org</a> again now if needs be.
</p><pre><code>pgqadm.py ticker.ini -s
sudo apt-get install postgresql-9.1-pgq3 skytools3-ticker skytools3
</code></pre><p>The ticker is not running anymore, we have the right version of the software
installed. Next step is to upgrade the database parts of PGQ:
</p><pre><code>psql -f /usr/share/skytools3/pgq.upgrade_2.1_to_3.0.sql ...
psql -1 -f /usr/share/postgresql/9.1/contrib/pgq.upgrade.sql ...
</code></pre><p>Of course replace those 
<code>...</code> with options such as your actual connection
string. I tend to always add 
<code>-vON_ERROR_STOP=1</code> to all these
commands, so that I don't depend on having the right 
<code>.psqlrc</code> on the
particular server I'm connected to. Also remember that if you want to do
that for more than one database, you need to actually run that pair of
commands for each of them.
</p><p>Now it's time to restart the new ticker. The main changes from the previous
one is that it is now a 
<code>C</code> program called 
<code>pgqd</code> that knows how to tick for any
number of 
<em>databases</em>, so that you only have to have 
<em>one instance</em> around 
<em>per
cluster</em> now.
</p><pre><code>sudo /etc/init.d/skytools3 start
tail -f /var/log/skytools/pgqd.log
</code></pre><p>Those two commands are taking for granted that you did prepare the 
<code>pgqd</code>
setup the 
<em>debian</em> and 
<em>skytools</em> way, by adding your config in
<code>/etc/skytools3/pgqd.ini</code> and editing 
<code>/etc/skytools.ini</code> accordingly, so that
it's automatically taken into account at machine boot.
</p><p>Note that I did actually exercised the procedure above while running a
<a href='http://www.postgresql.org/docs/9.2/static/pgbench.html'>pgbench</a> test replicated with 
<code>londiste</code>. Of course the replication has been
lagging a little while no 
<em>ticker</em> was running, and then it catched-up as fast
as it could, in that case:
</p><pre><code>INFO {count: 245673, ignored: 0, duration: 422.104366064}
</code></pre><h2>Happy Hacking!</h2><p>So if you have any 
<em>batch processing</em> needs, remember to consider what PGQ has
to offer. And yes if you're running some cron job to compute things out of
the database for you, you are doing some 
<em>batch processing</em>.
</p><center><img src='../../../images/hayseed.jpg' /></center><center><em>Yes, I did search for Transactional Batch Processing</em></center>  </div>
  </div>
  </div>
  <div id="push"></div>
  </div>

<footer>
  <p>
    <small>Unless otherwise specified, the contents of
    <a href=../../../index.html>this website</a> are Copyright
    &#169;&#160; 2008-2013 <a href=/about>Dimitri Fontaine</a>, and are
    licensed for use under
    <a href=http://creativecommons.org/licenses/by-sa/3.0/
    rel=license><abbr title="Creative
    Commons">CC</abbr>&#160;<abbr title=Attribution>BY</abbr>-<abbr title=Share-Alike>SA</abbr>&#160;3.0</a>.</small>
  </p> 
</footer> 

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-47059482-1', 'tapoueh.org');
  ga('send', 'pageview');

</script>

</body>
</html>
