<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset=utf-8 /> 
    <meta name=viewport content="width=device-width" /> 
    <meta name="generator" content="Emacs Muse Blog" /> 
    <meta description="blog de Dimitri Fontaine, Expert PostgreSQL - 2ndQuadrant France" />
    <meta property="og:title" content="tapoueh.org"/>
    <meta property="og:type" content="non_profit"/>
    <meta property="og:url" content="http://tapoueh.org/blog/2013/01/08-Extensions-Templates.html"/>
    <meta property="og:image" content="http://tapoueh.org/static/2ndQuadrant-cross.png"/>
    <meta property="og:site_name" content="Tapoueh"/>
    <meta property="fb:admins" content="545062436"/>

    <title>Expertise PostgreSQL</title>
    <link rel='stylesheet' type='text/css' media='all' href='../../../static/styles.css' />
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/bootstrap/css/bootstrap.min.css' />
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/FontAwesome/css/font-awesome.min.css' />

    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/highlight.js/styles/sunburst.css' />
    <script type='text/javascript' src='../../../static/highlight.js/highlight.pack.js'></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script type='text/javascript' src='../../../static/jquery-1.9.1.min.js'></script>
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/jqcloud.css' />
    <script type='text/javascript' src='../../../static/jqcloud-1.0.4.min.js'></script>

    <!-- <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/static/FontAwesome/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="/static/highlight.js/styles/sunburst.css">
    <script src="/static/highlight.js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script src="/static/jquery-1.9.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/jqcloud.css" />
    <script type="text/javascript" src="/static/jqcloud-1.0.4.min.js"></script>
    -->

    <script type="text/javascript" src="http://apis.google.com/js/plusone.js">{lang: 'fr'}</script>
    
  </head>
  <body>

   <div id="wrap">

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="nav-collapse collapse">
	<p class="pull-right">
	  <a href="http://2ndquadrant.com">
	    <img alt="logo" src="/static/2ndQuadrant-cross.png"
		 style="margin-right: 8px; margin-top: 4px; height: 32px;"/>
	  </a>
	</p>
	<div class="navbar-inner">
	 <a class="brand" style="margin-left: 0.2em; margin-top: -4px;"
	    href="http://expert-postgresql.fr/">
	  <img src="/static/expert-postgresql.png"></a>
	 <ul class="nav">
	   <li><a href="../../../blog/index.html">
               <i class="icon-book"></i> blog</a>
           </li>
	   <li><a href="../../../projects.html">
               <i class="icon-suitcase"></i> projects</a>
           </li>
	   <li><a href="../../../conferences.html">
               <i class="icon-plane"></i> confs</a>
           </li>
	   <li><a href="../../../about.html">
               <i class="icon-beer"></i> about</a>
           </li>
	   <li><a href="../../../rss/tapoueh.xml">
               <i class="icon-rss"></i> rss</a>
           </li>
	 </ul>
	</div>
      </div>
    </div>

    <div class="container">
      <div class="row">
	<div class="span4">
	  <div><ul class='breadcrumb'><li><span class='divider'><i class='icon-sitemap'></i></span></li><li><a href='../../../index.html'>/dev/dim</a><span class='divider'>/</span></li><li><a href='../../../blog/index.html'>blog</a><span class='divider'>/</span></li><li><a href='../../../blog/2013/index.html'>2013</a><span class='divider'>/</span></li><li><a href='../../../blog/2013/01/index.html'>01</a></li></ul></div>
	  <div class='date'>Tuesday, January 08 2013 <i class='icon-calendar'></i></div>
	  <div style='text-align: right;'><span><a href='../../../tags/postgresql'>PostgreSQL</a>, <a href='../../../tags/extensions'>Extensions</a>, <a href='../../../tags/9.3'>9.3</a>, <a href='../../../tags/templates'>Templates</a></span> <i class='icon-tags'></i></div>
	  

	  <div style="margin-top: 1em;">
	    <div class='span2 pull-left'><a class='thumbnail' href='../../../tags/postgresql.html'><img class='img-polaroid' style='width: 160px; height: 120px;' src='../../../thumbnails/postgresql-elephant.small.png' /></a></div>
	    <div id='social' class='span1 pull-right social'><ul><li><g:plusone size='tall' href='http://tapoueh.org/blog/2013/01/08-Extensions-Templates'></g:plusone></li><li><a href='http://twitter.com/share' class='twitter-share-button' data-via='tapoueh' data-count='vertical'>Tweet</a><script type='text/javascript' src='http://platform.twitter.com/widgets.js'></script></li></ul></div>
	  </div>

	  <div id="prevnext">
	    <h3 class='prevnext'>Recent Articles</h3>
	    <div><a class='previous' href='../../../blog/2012/12/13-Inline-Extensions.html'>« Inline Extensions</a></div>
	    <div><a class='next pull-right' href='../../../blog/2013/01/09-Lost-in-scope.html'>Lost in scope »</a></div>
	  </div>
	  
	  <div>
	    <div id="left-tag-cloud" class="jqcloud"
		 style="width: 300px; height: 650px; position: absolute; top: 475px;">
	    </div>
            <script>
            var word_list;
            
            $.ajax({
                type: 'GET',
                url: '/cloud.json',
                dataType: 'json',
                success: function(response) { word_list = response; },
                data: {},
                async: false
            });
             
            $(document).ready(function() {
               $("#left-tag-cloud").jQCloud(word_list,
	                {shape: "rectangular",
	                 removeOverflowing: false});
            });
            </script>
	  </div>

	</div>

	<div id="title" class="span8">
	  <h1>Extensions Templates</h1>
	</div>
	
	<div id="content" class="span8">
<p>In a recent article titled 
<a href='../../2012/12/13-Inline-Extensions.html'>Inline Extensions</a> we detailed the problem of how
to distribute an extension's 
<em>package</em> to a remote server without having
access to its file system at all. The solution to that problem is non
trivial, let's say. But thanks to the awesome 
<a href='http://www.postgresql.org/community/'>PostgreSQL Community</a> we finaly
have some practical ideas on how to address the problem as discussed on
<a href='http://archives.postgresql.org/pgsql-hackers/'>pgsql-hackers</a>, our development mailing list.
</p><center><img src='../../../images/community.jpg' /></center><center><em>PostgreSQL is first an Awesome Community</em></center><p>The solution we talked about is to use 
<em>templates</em>, and so I've been working
on a patch to bring 
<em>templates for extensions</em> to PostgreSQL. As we're talking
about 3 new system catalogs, that's a big patch in term of lines of code. In
term of features though, it's quite an easy one.
</p><p>Here's how it goes. Let's say you want to prepare the system to be able to
<code>CREATE EXTENSION pair;</code> without having to install it as an 
<em>OS package</em> for
which you would need to get 
<code>root</code> access on the server where your PostgreSQL
instance is running, which is not always easy, and sometimes not a good
idea.
</p><h2>Installing an extension template</h2><p>With the 
<a href='http://www.postgresql.org/message-id/m2wqvoha0p.fsf%402ndQuadrant.fr'>template patch</a> I just sent on the lists, what you can do is prepare
a template with your extension's script and properties, then use it to
install the extensions.
</p><pre><code>create template
   for extension pair default version &#039;1.0&#039;
  with (nosuperuser, norelocatable, schema public)
as $$
  CREATE TYPE pair AS ( k text, v text );
  
  CREATE OR REPLACE FUNCTION pair(anyelement, text)
  RETURNS pair LANGUAGE SQL AS &#039;SELECT ROW($1, $2)::pair&#039;;
  
  CREATE OR REPLACE FUNCTION pair(text, anyelement)
  RETURNS pair LANGUAGE SQL AS &#039;SELECT ROW($1, $2)::pair&#039;;
  
  CREATE OR REPLACE FUNCTION pair(anyelement, anyelement)
  RETURNS pair LANGUAGE SQL AS &#039;SELECT ROW($1, $2)::pair&#039;;
  
  CREATE OR REPLACE FUNCTION pair(text, text)
  RETURNS pair LANGUAGE SQL AS &#039;SELECT ROW($1, $2)::pair;&#039;;      
$$;
</code></pre><h2>Installing an extension from a template</h2><p>With the template installed in the catalogs, now you can go and install your
extension:
</p><pre><code>foo&gt; create extension pair;
CREATE EXTENSION

foo&gt; \dx pair
     List of installed extensions
 Name | Version | Schema | Description 
------+---------+--------+-------------
 pair | 1.0     | public | 
(1 row)

foo&gt; \dx+ pair
     Objects in extension &quot;pair&quot;
          Object Description          
--------------------------------------
 function pair(anyelement,anyelement)
 function pair(anyelement,text)
 function pair(text,anyelement)
 function pair(text,text)
 type pair
(5 rows)
</code></pre><p>The extension installation is now happening from the catalog templates
rather than the file system, which means you didn't need to be 
<code>root</code> on the
system where the server is running. Also note that this example above did
happen when connected as the 
<em>database owner</em>, a user who is not the
<em>superuser</em>. Requiring less privileges is always good news, right?
</p><h2>Managing upgrade scripts and extension update</h2><p>Now that the extension is installed, you might want to update it with some
new awesome features. Let's have a look at that.
</p><center><img src='../../../images/extension-update.png' /></center><center><em>Upload your Extension Update Scripts</em></center><p>Rather than make a new version of the extension package with the new files
in there, then asking the operations team to make the new package available
on the internal repositories then install them on the servers, you could now
prepare and 
<em>QA</em> the new setup that way:
</p><pre><code>create template for extension pair from &#039;1.0&#039; to &#039;1.1&#039;
as $$
  CREATE OPERATOR ~&gt; (LEFTARG = text,
                      RIGHTARG = anyelement,
                      PROCEDURE = pair);
                      
  CREATE OPERATOR ~&gt; (LEFTARG = anyelement,
                      RIGHTARG = text,
                      PROCEDURE = pair);

  CREATE OPERATOR ~&gt; (LEFTARG = anyelement,
                      RIGHTARG = anyelement,
                      PROCEDURE = pair);
                      
  CREATE OPERATOR ~&gt; (LEFTARG = text,
                      RIGHTARG = text,
                      PROCEDURE = pair);           
$$;

create template
   for extension pair from &#039;1.1&#039; to &#039;1.2&#039;
as $$
	    comment on extension pair is &#039;Simple Key Value Text Type&#039;;
$$;
</code></pre><p>Of course it's not the most realistic example when you look at the content.
In particular the 
<code>1.2</code> version that only adds a comment to the extension. I
needed another version to test the automatic upgrade path with more than one
step though, so here we go.
</p><pre><code>foo&gt; alter extension pair update to &#039;1.2&#039;;
ALTER EXTENSION

foo&gt; \dx pair
             List of installed extensions
 Name | Version | Schema |        Description         
------+---------+--------+----------------------------
 pair | 1.2     | public | Simple Key Value Text Type
(1 row)

foo&gt; \dx+ pair
     Objects in extension &quot;pair&quot;
          Object Description          
--------------------------------------
 function pair(anyelement,anyelement)
 function pair(anyelement,text)
 function pair(text,anyelement)
 function pair(text,text)
 operator ~&gt;(anyelement,anyelement)
 operator ~&gt;(anyelement,text)
 operator ~&gt;(text,anyelement)
 operator ~&gt;(text,text)
 type pair
(9 rows)
</code></pre><p>We did it!
</p><h2>Internals</h2><p>Let's have a look at those new catalogs:
</p><center><img src='../../../images/octopus-anatomy.jpg' /></center><center><em>Oh, that's not quite the internals I expected...</em></center><p>Here we go now:
</p><pre><code>foo&gt; select * from pg_extension_control;
select * from pg_extension_control;
-[ RECORD 1 ]--+-------
ctlname        | pair
ctlowner       | 32926
ctldefault     | t
ctlrelocatable | f
ctlsuperuser   | f
ctlnamespace   | public
ctlversion     | 1.0
ctlrequires    | 

foo&gt; select * from pg_extension_template;
select * from pg_extension_template;
-[ RECORD 1 ]-----------------------------------------------------------------
tplname    | pair
tplowner   | 32926
tplversion | 1.0
tplscript  | 
           |   CREATE TYPE pair AS ( k text, v text );
           |   
           |   CREATE OR REPLACE FUNCTION pair(anyelement, text)
           |   RETURNS pair LANGUAGE SQL AS &#039;SELECT ROW($1, $2)::pair&#039;;
           |   
           |   CREATE OR REPLACE FUNCTION pair(text, anyelement)
           |   RETURNS pair LANGUAGE SQL AS &#039;SELECT ROW($1, $2)::pair&#039;;
           |   
           |   CREATE OR REPLACE FUNCTION pair(anyelement, anyelement)
           |   RETURNS pair LANGUAGE SQL AS &#039;SELECT ROW($1, $2)::pair&#039;;
           |   
           |   CREATE OR REPLACE FUNCTION pair(text, text)
           |   RETURNS pair LANGUAGE SQL AS &#039;SELECT ROW($1, $2)::pair;&#039;;      
           | 

foo&gt; select * from pg_extension_uptmpl;
select * from pg_extension_uptmpl;
-[ RECORD 1 ]-------------------------------------------------------------
uptname   | pair
uptowner  | 32926
uptfrom   | 1.0
uptto     | 1.1
uptscript | 
          |   CREATE OPERATOR ~&gt; (LEFTARG = text,
          |                       RIGHTARG = anyelement,
          |                       PROCEDURE = pair);
          |                       
          |   CREATE OPERATOR ~&gt; (LEFTARG = anyelement,
          |                       RIGHTARG = text,
          |                       PROCEDURE = pair);
          | 
          |   CREATE OPERATOR ~&gt; (LEFTARG = anyelement,
          |                       RIGHTARG = anyelement,
          |                       PROCEDURE = pair);
          |                       
          |   CREATE OPERATOR ~&gt; (LEFTARG = text,
          |                       RIGHTARG = text,
          |                       PROCEDURE = pair);           
          | 
-[ RECORD 2 ]-------------------------------------------------------------
uptname   | pair
uptowner  | 32926
uptfrom   | 1.1
uptto     | 1.2
uptscript | 
          |     comment on extension pair is &#039;Simple Key Value Text Type&#039;;
          | 
</code></pre><p>As you can see there's nothing too complex here, it's quite straightforward.
We need to separate away the 
<em>creating</em> templates from the 
<em>updating</em> templates
because we need 
<em><strong>unique</strong></em> keys and we can't have that on 
<code>NULL</code> columns.
</p><pre><code>foo&gt; \d pg_extension_template
\d pg_extension_template
Table &quot;pg_catalog.pg_extension_template&quot;
   Column   | Type | Modifiers 
------------+------+-----------
 tplname    | name | not null
 tplowner   | oid  | not null
 tplversion | text | 
 tplscript  | text | 
Indexes:
    &quot;pg_extension_template_name_version_index&quot; UNIQUE, btree (tplname, tplversion)
    &quot;pg_extension_template_oid_index&quot; UNIQUE, btree (oid)

foo&gt; \d pg_extension_uptmpl
\d pg_extension_uptmpl
Table &quot;pg_catalog.pg_extension_uptmpl&quot;
  Column   | Type | Modifiers 
-----------+------+-----------
 uptname   | name | not null
 uptowner  | oid  | not null
 uptfrom   | text | 
 uptto     | text | 
 uptscript | text | 
Indexes:
    &quot;pg_extension_uptmpl_name_from_to_index&quot; UNIQUE, btree (uptname, uptfrom, uptto)
    &quot;pg_extension_uptmpl_oid_index&quot; UNIQUE, btree (oid)
</code></pre><h2>Next steps</h2><p>Now that we have the basics in place, the patch is far from finished still.
It needs 
<code>pg_dump</code> and 
<code>psql</code> support, support for the function
<code>pg_available_extension_versions()</code>, implementing some 
<code>ALTER TEMPLATE FOR
EXTENSION</code> commands for which I only sketched the syntax in the grammar, and
some more infrastructure to be able to have 
<code>ALTER OWNER</code> and 
<code>ALTER RENAME</code>
commands.
</p><center><img src='../../../images/patch-brewing.jpg' /></center><center><em>Warning: patch brewing here! Syntax and other key elements will change.</em></center><p>All that is pretty technical though, the real thing that patch needs is some
quality review and maybe some adjustments. I would be surprised if it didn't
need adjustments, really. Because the way the community works, we always
need some. That's why the PostgreSQL product is so good!
</p>  </div>
  </div>
  </div>
  <div id="push"></div>
  </div>

<footer>
  <p>
    <small>Unless otherwise specified, the contents of
    <a href=../../../index.html>this website</a> are Copyright
    &#169;&#160; 2008-2013 <a href=/about>Dimitri Fontaine</a>, and are
    licensed for use under
    <a href=http://creativecommons.org/licenses/by-sa/3.0/
    rel=license><abbr title="Creative
    Commons">CC</abbr>&#160;<abbr title=Attribution>BY</abbr>-<abbr title=Share-Alike>SA</abbr>&#160;3.0</a>.</small>
  </p> 
</footer> 

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-47059482-1', 'tapoueh.org');
  ga('send', 'pageview');

</script>

</body>
</html>
