

  
    
  


  




  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.31.1">
    <meta name="theme" content="Tranquilpeak 0.3.1-BETA">
    <title>How far is the nearest pub?</title>
    <meta name="author" content="Dimitri Fontaine">
    <meta name="keywords" content="">

    <link rel="icon" href="/favicon.ico">
    

    
    <meta name="description" content="In our recent article
about The Most Popular Pub Names we did
have a look at how to find the pubs nearby, but didn&rsquo;t compute the
distance in between that pub and us. That&rsquo;s because how to compute a
distance given a position on the earth expressed as longitude and
latitude is not that easy. Today, we are going to solve that problem
nonetheless, thanks
to
PostgreSQL Extensions.">
    <meta property="og:description" content="In our recent article
about The Most Popular Pub Names we did
have a look at how to find the pubs nearby, but didn&rsquo;t compute the
distance in between that pub and us. That&rsquo;s because how to compute a
distance given a position on the earth expressed as longitude and
latitude is not that easy. Today, we are going to solve that problem
nonetheless, thanks
to
PostgreSQL Extensions.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="How far is the nearest pub?">
    <meta property="og:url" content="/blog/2013/08/how-far-is-the-nearest-pub/">
    <meta property="og:site_name" content="Dimitri Fontaine, PostgreSQL Expert">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="How far is the nearest pub?">
    <meta name="twitter:description" content="In our recent article
about The Most Popular Pub Names we did
have a look at how to find the pubs nearby, but didn&rsquo;t compute the
distance in between that pub and us. That&rsquo;s because how to compute a
distance given a position on the earth expressed as longitude and
latitude is not that easy. Today, we are going to solve that problem
nonetheless, thanks
to
PostgreSQL Extensions.">
    
      <meta name="twitter:creator" content="@tapoueh">
    
    

    
    

    
      <meta property="og:image" content="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=640">
    

    
      <meta property="og:image" content="http://tapoueh.org/img/old/latitude_and_longitude.jpg">
    
    
      <meta property="og:image" content="http://tapoueh.org/img/old/latitude_and_longitude.jpg">
    
    

    

    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" />
    
    
    <link rel="stylesheet" href="/css/style-jsjn0006wyhpyzivf6yceb31gvpjatbcs3qzjvlumobfnugccvobqwxnnaj8.min.css" />
    
    
      <link rel="stylesheet" href="http://tapoueh.org//css/dim.css">
    
      <link rel="stylesheet" href="http://tapoueh.org//css/nav.css">
    

    
      
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-47059482-1', 'auto');
ga('send', 'pageview');
</script>

    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="navbar-collapse collapse header-title" id="navigation">
    <ul class="nav navbar-nav navbar-right">
      
      <li class="dropdown">
        
        <a href="/">blog</a>
        
      </li>
      
      <li class="dropdown">
        
        <a href="/conf/">talks</a>
        
      </li>
      
      <li class="dropdown">
        
        <a href="http://pgloader.io/">pgloader</a>
        
      </li>
      
      <li class="dropdown">
        
        <a href="http://masteringpostgresql.com/">Mastering PostgreSQL</a>
        
      </li>
      
    </ul>
  </div>

  
    
      <a class="header-right-icon "
         href="http://masteringpostgresql.com" target="_blank">
    
    
      <i class="fa fa-lg fa-book"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about">
          <img class="sidebar-profile-picture" src="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=110" alt="" />
        </a>
        <h4 class="sidebar-profile-name">Dimitri Fontaine</h4>
        
          <h5 class="sidebar-profile-bio">PostgreSQL Major Contributor</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/">
    
      <i class="sidebar-button-icon fa fa-lg fa-pagelines"></i>
      
      <span class="sidebar-button-desc">Blog</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/about/">
    
      <i class="sidebar-button-icon fa fa-lg fa-beer"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories/yesql/">
    
      <i class="sidebar-button-icon fa fa-lg fa-database"></i>
      
      <span class="sidebar-button-desc">YeSQL</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://masteringpostgresql.com" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-book"></i>
      
      <span class="sidebar-button-desc">Mastering PostgreSQL</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/dimitri" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/tapoueh" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      
  <div class="post-header-cover
              text-left
              post-header-cover--partial"
       style="background-image:url('/img/old/latitude_and_longitude.jpg')"
       data-behavior="5">
    
      <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      How far is the nearest pub?
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2013-08-05T08:11:00&#43;02:00">
        
  
  
  
  
    Monday 05 Aug 2013
  

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="/categories/postgresql">PostgreSQL</a>, 
    
      <a class="category-link" href="/categories/yesql">YeSQL</a>
    
  

  </div>

</div>
    
  </div>


      <div id="main" data-behavior="5"
        class="hasCover
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>In our recent article
about <a href="/blog/2013/08/02-pub-names-knn">The Most Popular Pub Names</a> we did
have a look at how to find the pubs nearby, but didn&rsquo;t compute the
<strong>distance</strong> in between that pub and us. That&rsquo;s because how to compute a
distance given a position on the earth expressed as <em>longitude</em> and
<em>latitude</em> is not that easy. Today, we are going to solve that problem
nonetheless, thanks
to
<a href="http://www.postgresql.org/docs/9.2/interactive/extend-extensions.html">PostgreSQL Extensions</a>.</p>

<p>
<h1 id="table-of-contents"></h1><nav id="TableOfContents">
<ul>
<li><a href="#the-earthdistance-postgresql-contrib">The earthdistance PostgreSQL contrib</a></li>
<li><a href="#pubs-and-cities">Pubs and cities</a></li>
<li><a href="#the-most-popular-pub-names-per-city">The Most Popular Pub Names, per City</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</nav></p>

<h1 id="the-earthdistance-postgresql-contrib">The earthdistance PostgreSQL contrib</h1>

<p>As the maths are complex enough to easily make mistakes when implementing
them again, we want to find an existing implementation that&rsquo;s been tested
already. PostgreSQL provides
several <a href="http://www.postgresql.org/docs/9.2/static/contrib.html">contrib</a>
extensions, one of those is
named
<a href="http://www.postgresql.org/docs/9.2/static/earthdistance.html">earthdistance</a> and
is made to solve our problem. Time to try it!</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"># <span style="color:#00a">create</span> extension <span style="color:#00a">cube</span>;
# <span style="color:#00a">create</span> extension earthdistance;</code></pre></div>
<p>Equiped with that extension we can now use its <code>&lt;@&gt;</code> operator and compute a
distance in miles at the surface of the earth, given points as <em>(longitude,
latitude)</em>. So I had to import our data set again with points in the right
representation, then I could run this query:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">&gt;  <span style="color:#00a">select</span> id, name, pos,
          round((pos &lt;@&gt; point(-<span style="color:#099">0</span>.<span style="color:#099">12</span>,<span style="color:#099">51</span>.<span style="color:#099">516</span>))::<span style="color:#0aa">numeric</span>, <span style="color:#099">3</span>) <span style="color:#00a">as</span> miles
     <span style="color:#00a">from</span> pubnames
 <span style="color:#00a">order</span> <span style="color:#00a">by</span> pos &lt;-&gt; point(-<span style="color:#099">0</span>.<span style="color:#099">12</span>,<span style="color:#099">51</span>.<span style="color:#099">516</span>)
    <span style="color:#00a">limit</span> <span style="color:#099">10</span>;</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-psql" data-lang="psql">     id     |          name          |           pos           | miles 
------------+------------------------+-------------------------+-------
   21593238 | All Bar One            | (-0.1192746,51.5163499) | 0.039
   26848690 | The Shakespeare&#39;s Head | (-0.1194731,51.5167871) | 0.059
  371049718 | The Newton Arms        | (-0.1209811,51.5163032) | 0.047
  438488621 | Marquis Cornwallis     | (-0.1199612,51.5146691) | 0.092
   21593236 | Ship Tavern            | (-0.1192378,51.5172525) | 0.093
  312156665 | The Prince of Wales    | (-0.121732,51.5145794)  | 0.123
  312156722 | O&#39;Neills               | (-0.1220195,51.5149538) | 0.113
   25508632 | Friend at Hand         | (-0.1224717,51.5148694) | 0.132
  338507304 | The Square Pig         | (-0.1191744,51.5187089) | 0.191
 1975855516 | Holborn Whippet        | (-0.1216925,51.5185189) | 0.189
(10 rows)

Time: 1.335 ms</code></pre></div>
<p>So the nearest pub is <em>All Bar One</em>, 0.039 miles away, or 68.64 yards
apparently. And we can see that adding the computation to get the distance
in <em>miles</em> didn&rsquo;t add that much to the query timing.</p>

<h1 id="pubs-and-cities">Pubs and cities</h1>

<p>Just as easily as we have
<em>nearest</em> pubs we can also of course query for pubs
<em>farthest</em> away from any location.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">&gt;   <span style="color:#00a">select</span> name, round((pos &lt;@&gt; point(-<span style="color:#099">0</span>.<span style="color:#099">12</span>,<span style="color:#099">51</span>.<span style="color:#099">516</span>))::<span style="color:#0aa">numeric</span>, <span style="color:#099">3</span>) <span style="color:#00a">as</span> miles
      <span style="color:#00a">from</span> pubnames
  <span style="color:#00a">order</span> <span style="color:#00a">by</span> pos &lt;-&gt; point(-<span style="color:#099">0</span>.<span style="color:#099">12</span>,<span style="color:#099">51</span>.<span style="color:#099">516</span>) <span style="color:#00a">desc</span>
     <span style="color:#00a">limit</span> <span style="color:#099">5</span>;</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-psql" data-lang="psql">      name       |  miles  
-----------------+---------
 Tig Bhric       | 440.194
 TP&#39;s            | 439.779
 Begley&#39;s        | 439.752
 Ventry Inn      | 438.962
 Fisherman&#39;s Bar | 439.153
(5 rows)

Time: 74.780 ms</code></pre></div>
<p>Now we want to know what city are those pubs in right? With the following
URL and using the <a href="http://www.openstreetmap.org/">Open Street Map</a> APIs,
I&rsquo;ve been able to download a list of cities in the same area as where the
pub names were fetched in:
<code>http://www.overpass-api.de/api/xapi?*[place=city][bbox=-10.5,49.78,1.78,59]</code>.</p>

<p>Tweaking the parser and import code
at
<a href="https://github.com/dimitri/pubnames">https://github.com/dimitri/pubnames</a>
was easy, and allowed to import those city names and locations in <em>0.087
seconds of real time</em>, with the following schema:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"># <span style="color:#00a">create</span> <span style="color:#00a">table</span> <span style="color:#00a">if</span> <span style="color:#00a">not</span> <span style="color:#00a">exists</span> cities (id <span style="color:#0aa">bigint</span>, pos point, name <span style="color:#0aa">text</span>);
# <span style="color:#00a">create</span> <span style="color:#00a">index</span> <span style="color:#00a">on</span> cities <span style="color:#00a">using</span> gist(pos);</code></pre></div>
<p>Now let&rsquo;s see where are those far away pubs:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">&gt;   <span style="color:#00a">select</span> name,
          (<span style="color:#00a">select</span> name <span style="color:#00a">from</span> cities <span style="color:#00a">c</span> <span style="color:#00a">order</span> <span style="color:#00a">by</span> <span style="color:#00a">c</span>.pos &lt;-&gt; p.pos <span style="color:#00a">limit</span> <span style="color:#099">1</span>) <span style="color:#00a">as</span> city,
          round((pos &lt;@&gt; point(-<span style="color:#099">0</span>.<span style="color:#099">12</span>,<span style="color:#099">51</span>.<span style="color:#099">516</span>))::<span style="color:#0aa">numeric</span>, <span style="color:#099">3</span>) <span style="color:#00a">as</span> miles
     <span style="color:#00a">from</span> pubnames p
 <span style="color:#00a">order</span> <span style="color:#00a">by</span> pos &lt;-&gt; point(-<span style="color:#099">0</span>.<span style="color:#099">12</span>,<span style="color:#099">51</span>.<span style="color:#099">516</span>) <span style="color:#00a">desc</span>
    <span style="color:#00a">limit</span> <span style="color:#099">5</span>;</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-psql" data-lang="psql">      name       |  city  |  miles  
-----------------+--------+---------
 Tig Bhric       | Galway | 440.194
 TP&#39;s            | Galway | 439.779
 Begley&#39;s        | Galway | 439.752
 Ventry Inn      | Galway | 438.962
 Fisherman&#39;s Bar | Cork   | 439.153
(5 rows)

Time: 686.444 ms</code></pre></div>
<p>As you can see we are fetching the pubs at a distance from our given point
and then the nearest city from where the pub is. The way it&rsquo;s implemented
here is called a <em>correlated subquery</em>, and starting with 9.3 we will be
able to use
the
<a href="http://www.postgresql.org/docs/devel/static/queries-table-expressions.html#QUERIES-LATERAL">LATERAL</a> standard
join construct, as in the following example:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">&gt;   <span style="color:#00a">select</span> <span style="color:#00a">c</span>.name <span style="color:#00a">as</span> city, p.name,
           round((pos &lt;@&gt; point(-<span style="color:#099">0</span>.<span style="color:#099">12</span>,<span style="color:#099">51</span>.<span style="color:#099">516</span>))::<span style="color:#0aa">numeric</span>, <span style="color:#099">3</span>) <span style="color:#00a">as</span> miles
      <span style="color:#00a">from</span> pubnames p,
           <span style="color:#00a">lateral</span> (<span style="color:#00a">select</span> name
                      <span style="color:#00a">from</span> cities <span style="color:#00a">c</span>
                  <span style="color:#00a">order</span> <span style="color:#00a">by</span> <span style="color:#00a">c</span>.pos &lt;-&gt; p.pos
                     <span style="color:#00a">limit</span> <span style="color:#099">1</span>) <span style="color:#00a">c</span>
  <span style="color:#00a">order</span> <span style="color:#00a">by</span> pos &lt;-&gt; point(-<span style="color:#099">0</span>.<span style="color:#099">12</span>,<span style="color:#099">51</span>.<span style="color:#099">516</span>) <span style="color:#00a">desc</span>
     <span style="color:#00a">limit</span> <span style="color:#099">5</span>;</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-psql" data-lang="psql">  city  |      name       |  miles  
--------+-----------------+---------
 Galway | Tig Bhric       | 440.194
 Galway | TP&#39;s            | 439.779
 Galway | Begley&#39;s        | 439.752
 Galway | Ventry Inn      | 438.962
 Cork   | Fisherman&#39;s Bar | 439.153
(5 rows)

Time: 636.445 ms</code></pre></div>
<p>So apparently the <em>bounded box</em> that we&rsquo;ve been given (
<code>[bbox=-10.5,49.78,1.78,59]</code>) includes Ireland too&hellip; and more importantly
the query execution penalty is quite important. That&rsquo;s because the planner
only know how to solve that query by doing <code>Index Scan using cities_pos_idx
on public.cities c (cost=0.14..9.60 rows=73 width=25) (actual
time=0.016..0.016 rows=1 loops=27878)</code>, which means scanning the position
index of the cities 27878 times (once per pubnames entry).</p>

<p>It&rsquo;s possible to force the planner into doing it the obvious way though:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">&gt;   <span style="color:#00a">with</span> pubs <span style="color:#00a">as</span> (
        <span style="color:#00a">select</span> name, pos,
               round((pos &lt;@&gt; point(-<span style="color:#099">0</span>.<span style="color:#099">12</span>,<span style="color:#099">51</span>.<span style="color:#099">516</span>))::<span style="color:#0aa">numeric</span>, <span style="color:#099">3</span>) <span style="color:#00a">as</span> miles
          <span style="color:#00a">from</span> pubnames
      <span style="color:#00a">order</span> <span style="color:#00a">by</span> pos &lt;-&gt; point(-<span style="color:#099">0</span>.<span style="color:#099">12</span>,<span style="color:#099">51</span>.<span style="color:#099">516</span>) <span style="color:#00a">desc</span>
         <span style="color:#00a">limit</span> <span style="color:#099">5</span>
    )
    <span style="color:#00a">select</span> <span style="color:#00a">c</span>.name <span style="color:#00a">as</span> city, p.name, p.miles
      <span style="color:#00a">from</span> pubs p, <span style="color:#00a">lateral</span> (<span style="color:#00a">select</span> name
                              <span style="color:#00a">from</span> cities <span style="color:#00a">c</span>
                          <span style="color:#00a">order</span> <span style="color:#00a">by</span> <span style="color:#00a">c</span>.pos &lt;-&gt; p.pos
                             <span style="color:#00a">limit</span> <span style="color:#099">1</span>) <span style="color:#00a">c</span>;</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-psql" data-lang="psql">  city  |      name       |  miles  
--------+-----------------+---------
 Galway | Tig Bhric       | 440.194
 Galway | TP&#39;s            | 439.779
 Galway | Begley&#39;s        | 439.752
 Galway | Ventry Inn      | 438.962
 Cork   | Fisherman&#39;s Bar | 439.153
(5 rows)

Time: 76.467 ms</code></pre></div>
<h1 id="the-most-popular-pub-names-per-city">The Most Popular Pub Names, per City</h1>

<p>Let&rsquo;s now find which cities have the highest count of pubs, considering that
a pub is affiliated to a city if it&rsquo;s within 5 miles of the single point we
have as city location in our data set.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">&gt;   <span style="color:#00a">select</span> <span style="color:#00a">c</span>.name, <span style="color:#00a">count</span>(cp)
      <span style="color:#00a">from</span> cities <span style="color:#00a">c</span>,
           <span style="color:#00a">lateral</span> (<span style="color:#00a">select</span> name
                      <span style="color:#00a">from</span> pubnames p
                     <span style="color:#00a">where</span> (p.pos &lt;@&gt; <span style="color:#00a">c</span>.pos) &lt; <span style="color:#099">5</span>
                   )
                   <span style="color:#00a">as</span> cp
  <span style="color:#00a">group</span> <span style="color:#00a">by</span> <span style="color:#00a">c</span>.name
  <span style="color:#00a">order</span> <span style="color:#00a">by</span> <span style="color:#00a">count</span>(cp) <span style="color:#00a">desc</span>
  <span style="color:#00a">limit</span> <span style="color:#099">10</span>;</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-psql" data-lang="psql">    name     | count 
-------------+-------
 London      |  1388
 Westminster |  1383
 Dublin      |   402
 Manchester  |   306
 Bristol     |   292
 Leeds       |   292
 Edinburgh   |   286
 Liverpool   |   258
 Nottingham  |   218
 Glasgow     |   217
(10 rows)

Time: 562.678 ms</code></pre></div>
<p>If we look at a map we see that <em>Westminster</em> is in fact within <em>London</em>
given our arbitrary rule of <em>within 5 miles</em>, so in the next query we will
simply filter it out. Exercise left to the reader: write a query allowing to
remove from London&rsquo;s count the pubs that are actually in Westminster (when
within 1 mile of the location we have for it). Then extend that query to
address any other situation like that in the whole data set.</p>

<p>And now what about the most popular pub names per city? Of course we want to
normalize again our pub names here but only for counting: we still display
all the names we did count.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">&gt;   <span style="color:#00a">select</span> <span style="color:#00a">c</span>.name,
           array_to_string(array_agg(<span style="color:#00a">distinct</span>(cp.name) <span style="color:#00a">order</span> <span style="color:#00a">by</span> cp.name), <span style="color:#a50">&#39;, &#39;</span>),
           <span style="color:#00a">count</span>(*)
      <span style="color:#00a">from</span> cities <span style="color:#00a">c</span>,
           <span style="color:#00a">lateral</span> (<span style="color:#00a">select</span> name
                      <span style="color:#00a">from</span> pubnames p
                     <span style="color:#00a">where</span> (p.pos &lt;@&gt; <span style="color:#00a">c</span>.pos) &lt; <span style="color:#099">5</span>) <span style="color:#00a">as</span> cp
     <span style="color:#00a">where</span> <span style="color:#00a">c</span>.name &lt;&gt; <span style="color:#a50">&#39;Westminster&#39;</span>
  <span style="color:#00a">group</span> <span style="color:#00a">by</span> <span style="color:#00a">c</span>.name, <span style="color:#00a">replace</span>(<span style="color:#00a">replace</span>(cp.name, <span style="color:#a50">&#39;The &#39;</span>, <span style="color:#a50">&#39;&#39;</span>), <span style="color:#a50">&#39;And&#39;</span>, <span style="color:#a50">&#39;&amp;&#39;</span>)
  <span style="color:#00a">order</span> <span style="color:#00a">by</span> <span style="color:#00a">count</span>(*) <span style="color:#00a">desc</span>
     <span style="color:#00a">limit</span> <span style="color:#099">10</span>;</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-psql" data-lang="psql">   name   |            array_to_string             | count 
----------+----------------------------------------+-------
 London   | Prince of Wales, The Prince of Wales   |    15
 London   | All Bar One                            |    12
 London   | The Beehive                            |     8
 London   | O&#39;Neills                               |     7
 London   | The Crown                              |     7
 London   | The Windmill                           |     7
 London   | Red Lion, The Red Lion                 |     6
 Bradford | New Inn, The New Inn                   |     6
 London   | Coach and Horses, The Coach and Horses |     6
 London   | The White Horse, White Horse           |     6
(10 rows)

Time: 729.866 ms</code></pre></div>
<h1 id="conclusion">Conclusion</h1>




<div class="figure fig25 right dim-margin" >
  
    <img class="fig-img" src="/img/sql-logo.png"  alt="Often the most powerful tool you have to make sense of your data...">
  
   
    <span class="caption">Often the most powerful tool you have to make sense of your data...</span>
  
</div>


<p>As said in the previous article on the same theme, SQL when using
<a href="http://www.postgresql.org/">PostgreSQL</a>
is indeed quite powerful! We&rsquo;ve been able to easily add an implementation of
the earth distance computation from
<em>longitude</em> and
<em>latitude</em> as found in the
<a href="http://www.postgresql.org/docs/9.2/static/earthdistance.html">earthdistance</a> contrib extension (already packaged for your Operating System
of choice, be sure to install
<em>contribs</em> by default), then to use it to solve
some interesting problems with our data set.</p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small"></span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/postgresql/">PostgreSQL</a>

  <a class="tag tag--primary tag--small" href="/tags/extensions/">Extensions</a>

  <a class="tag tag--primary tag--small" href="/tags/earthdistance/">earthdistance</a>

  <a class="tag tag--primary tag--small" href="/tags/yesql/">YeSQL</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  <div class="post-footer-tags">
    
    <script async id="_ck_252762" src="https://forms.convertkit.com/252762?v=6"></script>
    
  </div>
  <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/08/migrating-from-mysql-to-postgresql/" data-tooltip="Migrating from MySQL to PostgreSQL">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml"></span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/08/the-most-popular-pub-names/" data-tooltip="The Most Popular Pub Names">
          
            <span class="hide-xs hide-sm text-small icon-mr"></span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f08%2fhow-far-is-the-nearest-pub%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f08%2fhow-far-is-the-nearest-pub%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=How%20far%20is%20the%20nearest%20pub%3f with @tapoueh: http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f08%2fhow-far-is-the-nearest-pub%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#table-of-contents">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2017 Dimitri Fontaine. 
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        <div class="post-actions-wrap">
  <div class="post-footer-tags">
    
    <script async id="_ck_252762" src="https://forms.convertkit.com/252762?v=6"></script>
    
  </div>
  <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/08/migrating-from-mysql-to-postgresql/" data-tooltip="Migrating from MySQL to PostgreSQL">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml"></span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/08/the-most-popular-pub-names/" data-tooltip="The Most Popular Pub Names">
          
            <span class="hide-xs hide-sm text-small icon-mr"></span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f08%2fhow-far-is-the-nearest-pub%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f08%2fhow-far-is-the-nearest-pub%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=How%20far%20is%20the%20nearest%20pub%3f with @tapoueh: http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f08%2fhow-far-is-the-nearest-pub%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#table-of-contents">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <ul class="share-options">
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f08%2fhow-far-is-the-nearest-pub%2f">
        <i class="fa fa-google-plus"></i><span></span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f08%2fhow-far-is-the-nearest-pub%2f">
        <i class="fa fa-facebook-official"></i><span></span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=How%20far%20is%20the%20nearest%20pub%3f with @tapoueh: http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f08%2fhow-far-is-the-nearest-pub%2f">
        <i class="fa fa-twitter"></i><span></span>
      </a>
    </li>
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=110" alt="" />
    
    <h4 id="about-card-name">Dimitri Fontaine</h4>
    
      <div id="about-card-bio">PostgreSQL Major Contributor</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Open Source Software Engineer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        France
      </div>
    
  </div>
</div>

    <div id="algolia-search-modal" class="modal-container">
  <div class="modal">
    <div class="modal-header">
      <span class="close-button"><i class="fa fa-close"></i></span>
      <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
        <span class="searchby-algolia-text text-color-light text-small">by</span>
        <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
      </a>
      <i class="search-icon fa fa-search"></i>
      <form id="algolia-search-form">
        <input type="text" id="algolia-search-input" name="search"
          class="form-control input--large search-input" placeholder="" />
      </form>
    </div>
    <div class="modal-body">
      <div class="no-result text-color-light text-center"></div>
      <div class="results">
        
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/12/setting-up-psql-the-postgresql-cli/">
                <h3 class="media-heading">Setting up psql, the PostgreSQL CLI</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Dec 12, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>PostgreSQL ships with an interactive console with the command line tool
named <a href="https://www.postgresql.org/docs/current/static/app-psql.html">psql</a>.
It can be used both for scripting and interactive usage and is moreover
quite a powerful tool. Interactive features includes <em>autocompletion</em>,
<em>readline</em> support (history searches, modern keyboard movements, etc), input
and output redirection, formatted output, and more.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/12/mastering-postgresql-a-readers-interview/">
                <h3 class="media-heading">Mastering PostgreSQL: a reader&#39;s interview</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Dec 12, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p><strong><em>Florent Fourcot</em></strong> has read <a href="http://masteringpostgresql.com">Mastering PostgreSQL in Application
Development</a> and has seen tremendous
inprovements in his production setup from reading the first chapters and
applying the book advices to his use case.</p>

<p>Here&rsquo;s an interview run with Florent where he explains the context in which
such improvements has been made!</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/12/mastering-postgresql-more-about-the-docker-image/">
                <h3 class="media-heading">Mastering PostgreSQL: more about the docker image</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Dec 12, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>The Enterprise Edition of <a href="https://masteringpostgresql.com">Mastering PostgreSQL in Application
Development</a> ships with a docker image that
hosts both a PostgreSQL server instance with a pre-loaded database, the one
that&rsquo;s used throughout the book examples, and also with a Jupyter Network
notebook that hosts SQL queries thanks to the
<a href="https://github.com/pivotal/sql_magic">sql_magic</a> plugin.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/12/queen-princesses-and-workers/">
                <h3 class="media-heading">Queen, Princesses, and Workers</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Dec 12, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>The <a href="https://postgresql.org">PostgreSQL</a> community made the explicit choice
some times ago that they would not use the infamous <em>master</em> and <em>slave</em>
terminology. Instead, the documentation introduces the concepts of <a href="https://www.postgresql.org/docs/current/static/high-availability.html">High
Availability, Load Balancing, and
Replication</a>
with the terms <em>Primary</em> and <em>Standby</em>, and the even more generic term
<em>Replica</em> is used in contexts when only the data flow is considered, rather
than the particular role of a node.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/12/scaling-python-released/">
                <h3 class="media-heading">Scaling Python released</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Dec 12, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Today I am very pleased to announce the release of the book <a href="https://scaling-python.com">Scaling
Python</a> from my good friend <a href="https://julien.danjou.info/">Julien
Danjou</a>!</p>

<p>As Julien says, <strong>Python applications can handle millions of requests.</strong>
Well, we know here that it&rsquo;s easier on them when they are using PostgreSQL
of course!</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/11/simple-data-modeling-with-a-test-data-set/">
                <h3 class="media-heading">Simple Data Modeling with a Test Data Set</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Nov 11, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>In <a href="/blog/2017/06/how-to-write-sql/">How to Write SQL</a> we saw how to write
SQL queries as separate <code>.sql</code> files, and we learnt about using query
parameters with the <em>psql</em> syntax for that (<code>:variable</code>, <code>:'variable'</code>, and
<code>:&quot;identifier&quot;</code>).</p>

<p>For writing our database model, the same tooling is all we need. An
important aspect of using <em>psql</em> is its capacity to provide immediate
feedback, and we can also have that with modeling too.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/11/the-mode-ordered-set-aggregate-function/">
                <h3 class="media-heading">The Mode Ordered-Set Aggregate Function</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Nov 11, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>In our article <a href="/blog/2017/06/exploring-a-data-set-in-sql/">Exploring a Data Set in
SQL</a> we discovered a data set
related to music: the <a href="https://github.com/lerocha/chinook-database">Chinook</a>
sample database.</p>

<p>Our discovery led us to find albums containing tracks of multiple genres,
and for the analytics we were then pursuing, we wanted to <em>clean</em> the data
set and assign a single genre per album. We did that in SQL of course, and
didn&rsquo;t actually edit the data.</p>

<p>Finding the most frequent input value in a group is a job for the <code>mode()
WITHIN GROUP (ORDER BY sort_expression)</code> Ordered-Set Aggregate Function, as
documented in the PostgreSQL page about <a href="https://www.postgresql.org/docs/current/static/functions-aggregate.html#FUNCTIONS-ORDEREDSET-TABLE">Aggregate
Functions</a>.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/11/whats-in-a-name-mastering/">
                <h3 class="media-heading">What&#39;s in a name: “Mastering”</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Nov 11, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Now that my book <a href="https://masteringpostgresql.com">Mastering PostgreSQL in Application
Development</a> is released (and selling well,
thanks guys!), I&rsquo;ve had some questions about the title.</p>

<p>The idea is that to become good at anything, we need to practice. We
practice a lot, and it&rsquo;s even better when we are actively trying to learn,
following what&rsquo;s named <a href="https://en.wikipedia.org/wiki/Practice_(learning_method)#Deliberate_practice">deliberate
practice</a>.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/11/mastering-postgresql-in-application-development-launches/">
                <h3 class="media-heading">Mastering PostgreSQL in Application Development launches!</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Nov 11, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">Today is the day my book Mastering PostgreSQL in Application Development launches! I&rsquo;m all excited that everybody interested is now able to actually read my book!
Mastering PostgreSQL in Application Development targets application developers who want to learn SQL properly, and actually master this programming language. Most developers don&rsquo;t think of SQL as a programming language, mainly because they don&rsquo;t have full control of the execution plan of their queries.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/10/set-returning-functions-and-postgresql-10/">
                <h3 class="media-heading">Set Returning Functions and PostgreSQL 10</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Oct 10, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>PostgreSQL 10 is now available for everyone to use, and hinted by <a href="http://fetter.org">David
Fetter</a> I had to review my previous article <a href="/blog/2017/09/on-json-and-sql/">on Json and
SQL</a> to adapt to <em>Set Returning Functions</em>
changes.</p>

<p>A <em>Set Returning Function</em> is a PostgreSQL <em>Stored Procedure</em> that can be
used as a relation: from a single call it returns an entire result set, much
like a subquery or a table.</p>

<p>It used to be possible to use <em>SRF</em> in the <em>SELECT</em> clause, with dubious
(but useful at times) semantics, and also in <em>scalar</em> contexts. The
semantics have been fixed and are now much clearer, and the uses in scalar
contexts are forbidden — they were a hack and never made sense anyway.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
      </div>
    </div>
    <div class="modal-footer">
      <p class="results-count text-medium"
         data-message-zero=""
         data-message-one=""
         data-message-other="">
         251 posts found
      </p>
    </div>
  </div>
</div>
    
  
    
    <div id="cover" style="background-image:url('http://tapoueh.org/images/mayan-calendar.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="/js/script-qi9wbxp2ya2j6p7wx1i6tgavftewndznf4v0hy2gvivk1rxgc3lm7njqb6bz.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'http:\/\/tapoueh.org\/blog\/2013\/08\/how-far-is-the-nearest-pub\/';
          
            this.page.identifier = '\/blog\/2013\/08\/how-far-is-the-nearest-pub\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'tapoueh';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  



    
  </body>
</html>

