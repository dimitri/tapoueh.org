

  
    
  


  




  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.26">
    <meta name="theme" content="Tranquilpeak 0.3.1-BETA">
    <title>Loading Geolocation Data</title>
    <meta name="author" content="Dimitri Fontaine">
    <meta name="keywords" content="">

    <link rel="icon" href="/favicon.ico">
    

    
    <meta name="description" content="As I&rsquo;ve been mentionning in the past already, I&rsquo;m currently rewriting
pgloader from scratch in
Common Lisp. In terms of
technical debt that&rsquo;s akin
to declaring
bankrupcy, which is both sad news and good news as there&rsquo;s
suddenly new hope of doing it right this time.

">
    <meta property="og:description" content="As I&rsquo;ve been mentionning in the past already, I&rsquo;m currently rewriting
pgloader from scratch in
Common Lisp. In terms of
technical debt that&rsquo;s akin
to declaring
bankrupcy, which is both sad news and good news as there&rsquo;s
suddenly new hope of doing it right this time.

">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Loading Geolocation Data">
    <meta property="og:url" content="/blog/2013/10/loading-geolocation-data/">
    <meta property="og:site_name" content="Dimitri Fontaine, PostgreSQL Expert">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Loading Geolocation Data">
    <meta name="twitter:description" content="As I&rsquo;ve been mentionning in the past already, I&rsquo;m currently rewriting
pgloader from scratch in
Common Lisp. In terms of
technical debt that&rsquo;s akin
to declaring
bankrupcy, which is both sad news and good news as there&rsquo;s
suddenly new hope of doing it right this time.

">
    
      <meta name="twitter:creator" content="@tapoueh">
    
    

    
    

    
      <meta property="og:image" content="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=640">
    

    
      <meta property="og:image" content="http://tapoueh.org/img/old/lisp-python.png">
    
    
      <meta property="og:image" content="http://tapoueh.org/img/old/lisp-python.png">
    
    

    

    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" />
    
    
    <link rel="stylesheet" href="/css/style-u6mk0ojoywresbx8iepslrmmhl4stuhrsxuwhkpwrkrx7mryjcaimasnk4pi.min.css" />
    
    
      <link rel="stylesheet" href="http://tapoueh.org//css/dim.css">
    
      <link rel="stylesheet" href="http://tapoueh.org//css/nav.css">
    

    
      
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-47059482-1', 'auto');
ga('send', 'pageview');
</script>

    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="navbar-collapse collapse header-title" id="navigation">
    <ul class="nav navbar-nav navbar-right">
      
      <li class="dropdown">
        
        <a href="/">blog</a>
        
      </li>
      
      <li class="dropdown">
        
        <a href="/conf/">talks</a>
        
      </li>
      
      <li class="dropdown">
        
        <a href="http://pgloader.io/">pgloader</a>
        
      </li>
      
      <li class="dropdown">
        
        <a href="http://masteringpostgresql.com/">the book</a>
        
      </li>
      
    </ul>
  </div>

  
    
      <a class="header-right-icon "
         href="http://masteringpostgresql.com" target="_blank">
    
    
      <i class="fa fa-lg fa-book"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about">
          <img class="sidebar-profile-picture" src="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=110" alt="" />
        </a>
        <h4 class="sidebar-profile-name">Dimitri Fontaine</h4>
        
          <h5 class="sidebar-profile-bio">PostgreSQL Major Contributor</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/">
    
      <i class="sidebar-button-icon fa fa-lg fa-pagelines"></i>
      
      <span class="sidebar-button-desc">Blog</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/about/">
    
      <i class="sidebar-button-icon fa fa-lg fa-beer"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories/yesql/">
    
      <i class="sidebar-button-icon fa fa-lg fa-database"></i>
      
      <span class="sidebar-button-desc">YeSQL</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://masteringpostgresql.com" target="_blank">
    
      <i class="sidebar-button-icon fa fa-lg fa-book"></i>
      
      <span class="sidebar-button-desc">Mastering PostgreSQL</span>
    </a>
  </li>

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/dimitri" target="_blank">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/tapoueh" target="_blank">
    
      <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

    </ul>
  </div>
</nav>

      
  <div class="post-header-cover
              text-left
              post-header-cover--partial"
       style="background-image:url('/img/old/lisp-python.png')"
       data-behavior="5">
    
  </div>


      <div id="main" data-behavior="5"
        class="hasCover
               hasCoverMetaOut
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Loading Geolocation Data
    </h1>
  
  <div class="postShorten-meta post-meta">
  
    <time itemprop="datePublished" datetime="2013-10-01T16:52:00&#43;02:00">
      
  
  
  
  
    Tuesday 01 Oct 2013
  

    </time>
  
  
  
  
    <span></span>
    
      <a class="category-link" href="/categories/projects">Projects</a>, 
    
      <a class="category-link" href="/categories/pgloader">pgloader</a>
    
  


</div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>As I&rsquo;ve been mentionning in the past already, I&rsquo;m currently rewriting
pgloader from scratch in
<a href="/tags/common-lisp">Common Lisp</a>. In terms of
<a href="http://en.wikipedia.org/wiki/Technical_debt">technical debt</a> that&rsquo;s akin
to declaring
<em>bankrupcy</em>, which is both sad news and good news as there&rsquo;s
suddenly new hope of doing it right this time.</p>

<p></p>

<p><center><em>Let&rsquo;s dive into the python to common lisp rewrite</em></center></p>

<h1 id="table-of-contents"></h1><nav id="TableOfContents">
<ul>
<li><a href="#why-rewriting-pgloader">Why rewriting pgloader?</a></li>
<li><a href="#a-test-case">A Test case</a></li>
<li><a href="#the-new-pgloader-command-language">The new pgloader command language</a></li>
<li><a href="#transforming-and-projecting">Transforming and Projecting</a></li>
<li><a href="#simple-benchmarking">Simple benchmarking</a>
<ul>
<li><a href="#python-version">Python version</a></li>
<li><a href="#common-lisp-version-no-projection">Common Lisp version, no projection</a></li>
<li><a href="#common-lisp-version-with-fields-to-columns-projection">Common Lisp version with fields to columns projection</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#can-i-use-that-new-software-today">Can I use that new software today?</a></li>
</ul>
</nav>

<h1 id="why-rewriting-pgloader">Why rewriting pgloader?</h1>

<p>Several problems hinted me into doing something other than maintaining the
code I had for
<a href="/projects/pgloader">pgloader</a>.</p>

<p>First, the configuration file format was already used well beyond its
capacities: it&rsquo;s quite hard to express advanced fine grained options when
using the infamous
<a href="http://en.wikipedia.org/wiki/INI_file">INI file format</a>. Continuing with python I did consider
using the
<a href="http://pyparsing.wikispaces.com/">pyparsing</a> library and even went as far as writing a prototype
command language with it. While the lib was working great for that, at the
time at least it wasn&rsquo;t available for
<em>Python 3</em> and not to be found in some
OS vendors.
<em>pgloader</em> is available today for Debian and derivatives, RedHat
and derivatives, FreeBSD, OpenBSD, and some more. And you can easily enough
use it on Windows too, because it only depends on
<a href="http://initd.org/psycopg/">Psycopg</a>, basically, so
that I wanted to keep things simple for the end user. Basically, integrating
that lib was a problem.</p>

<p>Then again, the performances were a bigger and bigger worry for me as the
size of files one want to load into its database grew bigger. The real
problem was not perceived as the current performance characteristics but
rather how to improve them, and I didn&rsquo;t see many ways forward. The most
obvious one was to rewrite critical parts in C, but if I need to switch away
from python I&rsquo;d rather find a better compromse than writing python modules
in C.</p>

<p>That&rsquo;s in short what lead me to consider alternatives. And as I had some
really good preliminary performances results with a programming language I
can actually like, I decided to go with Common Lisp.</p>

<h1 id="a-test-case">A Test case</h1>

<p>The blog post I actually wanted to write would have been about the awesome
<a href="https://github.com/RhodiumToad/ip4r">ip4r</a> extension, which is about indexing IP range searches as mostly used
nowadays in
<em>geoip location</em>. The first step here is to find some data to use
and load them, and wanting to do that I realised we were lacking an
all-integrated tool easy enough to use.</p>




<div class="figure fig25 right dim-margin" >
  
    <img class="fig-img" src="/img/old/toy-loader.320.jpg" >
  
  
</div>


<p>And that&rsquo;s exactly the reason why I&rsquo;m working on
<em>pgloader</em> in the first
place, to make it really easy to load data, converting it on the fly and all
the jazz. And that
<em>ip4r</em> test case actually has been a very good excuse at
improving what I already had.</p>

<h1 id="the-new-pgloader-command-language">The new pgloader command language</h1>

<p>Here&rsquo;s the current way of doing things with the new
<em>pgloader</em> written in
Common-Lisp, then I&rsquo;ll tell you why using a
<em>parser generator library</em> in that
language is less of a burden than doing the same thing in Python:</p>

<pre><code>LOAD FROM ARCHIVE http://geolite.maxmind.com/download/geoip/database/GeoLiteCity_CSV/GeoLiteCity-latest.zip
   INTO postgresql://dim@localhost:54393/dim

BEFORE LOAD DO
   $$ create extension if not exists ip4r; $$,
   $$ create schema if not exists geolite; $$,
   $$ create table if not exists geolite.location
     (
        locid      integer primary key,
        country    text,
        region     text,
        city       text,
        postalcode text,
        location   point,
        metrocode  text,
        areacode   text
     );
   $$,
   $$ create table if not exists geolite.blocks
     (
        iprange    ip4r,
        locid      integer
     );
   $$,
   $$ drop index if exists geolite.blocks_ip4r_idx; $$,
   $$ truncate table geolite.blocks, geolite.location cascade; $$

    LOAD CSV FROM FILENAME MATCHING ~/GeoLiteCity-Location.csv/
             WITH ENCODING iso-8859-1
             (
                locId,
                country,
                region     null if blanks,
                city       null if blanks,
                postalCode null if blanks,
                latitude,
                longitude,
                metroCode  null if blanks,
                areaCode   null if blanks
             )
        INTO postgresql://dim@localhost:54393/ip4r?geolite.location
             (
                locid,country,region,city,postalCode,
                location point using (format nil &quot;(~a,~a)&quot; longitude latitude),
                metroCode,areaCode
             )
        WITH skip header = 2,
             fields optionally enclosed by '&quot;',
             fields escaped by double-quote,
             fields terminated by ','

AND LOAD CSV FROM FILENAME MATCHING ~/GeoLiteCity-Blocks.csv/
             WITH ENCODING iso-8859-1
             (
                startIpNum, endIpNum, locId
             )
        INTO postgresql://dim@localhost:54393/ip4r?geolite.blocks
             (
                iprange ip4r using (ip-range startIpNum endIpNum),
                locId
             )
        WITH skip header = 2,
             fields optionally enclosed by '&quot;',
             fields escaped by double-quote,
             fields terminated by ','

FINALLY DO
   $$
     create index blocks_ip4r_idx on geolite.blocks using gist(iprange);
   $$;
</code></pre>

<p>What you see here looks quite complex and heavy. That&rsquo;s because it&rsquo;s
addressing the full needs, let&rsquo;s see about that:</p>

<ul>
<li><p>the source of the data loading is a <em>zip archive</em> that we have to download from a <em>http url</em>,</p></li>

<li><p>the <em>zip archive</em> contains a single directory entry wherein we find the data files we want to load, currently <code>GeoLiteCity_20130903</code>&hellip; as we want to be able to update the data without having to edit the command, you will note the support for matching the file name against a full path name: <code>FILENAME MATCHING ~/GeoLiteCity-Blocks.csv/</code> is applying a regular expression,</p></li>

<li><p>we want the loading process to take care about creating the database schema we&rsquo;re going to use, and even drop the current index if any before loading, because we know that loading the data in bulk and then creating the index is way faster than keeping the index around,</p></li>

<li><p>there&rsquo;s no out of band place where to register whether a field value is null in a plain text CSV file, even if technically that could be done, so we have to provide per field instructions on what a <code>NULL</code> will look like in the data itself,</p></li>

<li><p>the files we&rsquo;re using don&rsquo;t have the exact definition we want: rather than a pair of <em>double precision</em> fields for hosting the location we want a <a href="http://www.postgresql.org/docs/9.3/static/datatype-geometric.html#AEN6542">PostgreSQL point</a> datatype column; and rather than a pair of <em>bigint</em> fields we want an <em>ip4r</em> column in PostgreSQL,</p></li>

<li><p>and of course as soon as the data loading is done we want to create the shiny <em>ip4r</em> <strong>GiST</strong> index.</p></li>
</ul>

<p>And as we are using an attribution licence for the data here, let me tell
you that: This article includes
<strong>GeoLite</strong> data created by
<strong>MaxMind</strong>, available
from
<a href="http://www.maxmind.com">http://www.maxmind.com</a>.</p>

<h1 id="transforming-and-projecting">Transforming and Projecting</h1>




<div class="figure fig25 left dim-margin" >
  
    <img class="fig-img" src="/img/old/huge-full-outer-join.gif"  alt="Traditionnaly used for Full Outer Join, but I liked the symbol">
  
   
    <span class="caption">Traditionnaly used for Full Outer Join, but I liked the symbol</span>
  
</div>


<p>The former <em>pgloader</em> was capable of using dynamic python code to reformat
fields on the fly, which was already quite good, but not up to the task
described just above. What we really want to be able to do here is <em>project</em>
any number of fields into a <em>possibly different</em> number of columns that are
dependant on the fields.</p>

<p>In the simplest case possible, each field ends up into a column of the same
name, and that&rsquo;s still supported of course, it looks like this:</p>

<pre><code>LOAD CSV FROM FILENAME MATCHING ~/GeoLiteCity-Blocks.csv/
         WITH ENCODING iso-8859-1
    INTO postgresql://dim@localhost:54393/ip4r?geonumip.blocks
    WITH skip header = 2,
         fields optionally enclosed by '\&quot;',
         fields escaped by double-quote,
         fields terminated by ',';
</code></pre>

<p>That&rsquo;s a very simple processing actually, with no added processing when
reading the file.</p>

<p>In the previous example though, we&rsquo;re using a
<em>transformation</em> function that I
included in
<em>pgloader</em> to transform a couple of integers into an
<em>iprange</em>.
Here&rsquo;s the Common Lisp sources for that function:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>(<span style="color: #00aaaa">defun</span> <span style="color: #aa0000">ip-range</span> (<span style="color: #aa0000">start-integer-string</span> <span style="color: #aa0000">end-integer-string</span>)
  <span style="color: #aa5500">&quot;Transform a couple of integers to an IP4R ip range notation.&quot;</span>
  (<span style="color: #0000aa">declare</span> (<span style="color: #0000aa">inline</span>)
	   (<span style="color: #0000aa">optimize</span> <span style="color: #aa0000">speed</span>)
	   (<span style="color: #0000aa">type</span> <span style="color: #00aaaa">string</span> <span style="color: #aa0000">start-integer-string</span> <span style="color: #aa0000">end-integer-string</span>))
  (<span style="color: #0000aa">flet</span> ((<span style="color: #aa0000">integer-to-ip-string</span> (<span style="color: #aa0000">int</span>)
	   <span style="color: #aa5500">&quot;see http://dev.maxmind.com/geoip/legacy/csv/&quot;</span>
	   (<span style="color: #0000aa">declare</span> (<span style="color: #0000aa">inline</span>) (<span style="color: #0000aa">optimize</span> <span style="color: #aa0000">speed</span>) (<span style="color: #0000aa">type</span> <span style="color: #00aaaa">fixnum</span> <span style="color: #aa0000">int</span>))
	   (<span style="color: #00aaaa">format</span> <span style="color: #aa0000">nil</span> <span style="color: #aa5500">&quot;~a.~a.~a.~a&quot;</span>
		   (<span style="color: #00aaaa">mod</span> (<span style="color: #00aaaa">truncate</span> <span style="color: #aa0000">int</span> #. (<span style="color: #00aaaa">expt</span> <span style="color: #009999">2</span> <span style="color: #009999">24</span>)) <span style="color: #009999">256</span>)
		   (<span style="color: #00aaaa">mod</span> (<span style="color: #00aaaa">truncate</span> <span style="color: #aa0000">int</span> #. (<span style="color: #00aaaa">expt</span> <span style="color: #009999">2</span> <span style="color: #009999">16</span>)) <span style="color: #009999">256</span>)
		   (<span style="color: #00aaaa">mod</span> (<span style="color: #00aaaa">truncate</span> <span style="color: #aa0000">int</span> #. (<span style="color: #00aaaa">expt</span> <span style="color: #009999">2</span> <span style="color: #009999">8</span>)) <span style="color: #009999">256</span>)
		   (<span style="color: #00aaaa">mod</span> <span style="color: #aa0000">int</span> <span style="color: #009999">256</span>))))
    (<span style="color: #0000aa">let</span> ((<span style="color: #aa0000">ip-start</span> (<span style="color: #aa0000">integer-to-ip-string</span> (<span style="color: #00aaaa">parse-integer</span> <span style="color: #aa0000">start-integer-string</span>)))
	  (<span style="color: #aa0000">ip-end</span>   (<span style="color: #aa0000">integer-to-ip-string</span> (<span style="color: #00aaaa">parse-integer</span> <span style="color: #aa0000">end-integer-string</span>))))
      (<span style="color: #00aaaa">format</span> <span style="color: #aa0000">nil</span> <span style="color: #aa5500">&quot;~a-~a&quot;</span> <span style="color: #aa0000">ip-start</span> <span style="color: #aa0000">ip-end</span>))))
</pre></div>

<p>And here&rsquo;s how it&rsquo;s used:</p>

<pre><code>INTO postgresql://dim@localhost:54393/ip4r?geolite.blocks
     (
        iprange ip4r using (ip-range startIpNum endIpNum),
        locId
     )
</code></pre>

<p>Internally, pgloader generates a
<em>lambda</em> expression to process each row, in
that very case the expression looks like this:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>(<span style="color: #0000aa">lambda</span> (<span style="color: #aa0000">row</span>)
  (<span style="color: #00aaaa">destructuring-bind</span> (<span style="color: #aa0000">startIpNum</span> <span style="color: #aa0000">endIpNum</span> <span style="color: #aa0000">locId</span>) <span style="color: #aa0000">row</span>
    (<span style="color: #00aaaa">list</span> (<span style="color: #aa0000">pgloader.transforms::ip-range</span> <span style="color: #aa0000">startIpNum</span> <span style="color: #aa0000">endIpNum</span>)
          <span style="color: #aa0000">locId</span>)))
</pre></div>




<div class="figure fig25 right dim-margin" >
  
    <img class="fig-img" src="/img/old/lisplogo_fancy_256.png" >
  
  
</div>


<p>That generated lambda expression is then
<strong><em>compiled</em></strong> on the fly into machine
code that is then executed for each row input. That&rsquo;s the kind of things
allowing Common Lisp programmers not to resort to C.</p>

<p>Note that as in the previous
<em>location</em> example you can also directly write
the Lisp expressions within the command itself:</p>

<pre><code>INTO postgresql://dim@localhost:54393/ip4r?geolite.location
     (
        locid,country,region,city,postalCode,
        location point using (format nil &quot;(~a,~a)&quot; longitude latitude),
        metroCode,areaCode
     )
</code></pre>

<h1 id="simple-benchmarking">Simple benchmarking</h1>

<p>Enough presenting the software already, let&rsquo;s run it!</p>

<h2 id="python-version">Python version</h2>

<p>First, let&rsquo;s run the current python pgloader code against our dataset. Note
that you will have to download and unzip the data yourself here, then
prepare that kind of configuration file:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #0000aa">[pgsql]</span>
<span style="color: #1e90ff">base</span> = <span style="color: #aa5500">pgloader</span>

<span style="color: #1e90ff">log_file</span>            = <span style="color: #aa5500">/tmp/pgloader.log</span>
<span style="color: #1e90ff">log_min_messages</span>    = <span style="color: #aa5500">INFO</span>
<span style="color: #1e90ff">client_min_messages</span> = <span style="color: #aa5500">WARNING</span>

<span style="color: #1e90ff">client_encoding</span> = <span style="color: #aa5500">&#39;latin1&#39;</span>
<span style="color: #1e90ff">lc_messages</span>         = <span style="color: #aa5500">C</span>
<span style="color: #1e90ff">pg_option_standard_conforming_strings</span> = <span style="color: #aa5500">on</span>
<span style="color: #aaaaaa; font-style: italic">; This setting has no effect other than allowing to check option precedence</span>
<span style="color: #1e90ff">pg_option_work_mem</span> = <span style="color: #aa5500">12MB</span>

<span style="color: #1e90ff">copy_every</span>      = <span style="color: #aa5500">25000</span>
<span style="color: #1e90ff">commit_every</span>    = <span style="color: #aa5500">25000</span>
<span style="color: #aaaaaa; font-style: italic">#copy_delimiter  = %</span>

<span style="color: #1e90ff">null</span>         = <span style="color: #aa5500">&quot;&quot;</span>
<span style="color: #1e90ff">empty_string</span> = <span style="color: #aa5500">&quot;\ &quot;</span>

<span style="color: #0000aa">[tmpl]</span>
<span style="color: #1e90ff">template</span>        = <span style="color: #aa5500">True</span>
<span style="color: #1e90ff">format</span>          = <span style="color: #aa5500">csv</span>
<span style="color: #1e90ff">field_sep</span>       = <span style="color: #aa5500">,</span>
<span style="color: #1e90ff">skip_head_lines</span> = <span style="color: #aa5500">2</span>

<span style="color: #0000aa">[location]</span>
<span style="color: #1e90ff">use_template</span>    = <span style="color: #aa5500">tmpl</span>
<span style="color: #1e90ff">table</span>           = <span style="color: #aa5500">location</span>
<span style="color: #1e90ff">filename</span>        = <span style="color: #aa5500">/tmp/GeoLiteCity-latest/GeoLiteCity_20130903/GeoLiteCity-Location.csv</span>
<span style="color: #1e90ff">columns</span>         = <span style="color: #aa5500">*</span>

<span style="color: #0000aa">[blocks]</span>
<span style="color: #1e90ff">use_template</span>    = <span style="color: #aa5500">tmpl</span>
<span style="color: #1e90ff">table</span>           = <span style="color: #aa5500">blocks</span>
<span style="color: #1e90ff">filename</span>        = <span style="color: #aa5500">/tmp/GeoLiteCity-latest/GeoLiteCity_20130903/GeoLiteCity-Blocks.csv</span>
<span style="color: #1e90ff">columns</span>         = <span style="color: #aa5500">*</span>
<span style="color: #1e90ff">skip_head_lines</span> = <span style="color: #aa5500">2</span>
</pre></div>

<p>And with that we can do:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>./pgloader.py -R reformat -sTv -c ~/dev/temp/pgloader.geolite.conf
   ... edited ...
Table name        |    duration |    size |  copy rows |     <span style="color: #aa0000">errors</span> 
====================================================================
blocks            |  01m18.979s |       - |    <span style="color: #009999">1790461</span> |          <span style="color: #009999">0</span>
location          |     <span style="color: #009999">35</span>.710s |       - |     <span style="color: #009999">438386</span> |          <span style="color: #aa0000">0</span>
====================================================================
Total             |  01m54.713s |       - |    <span style="color: #009999">2228847</span> |          <span style="color: #009999">0</span>
</pre></div>

<h2 id="common-lisp-version-no-projection">Common Lisp version, no projection</h2>

<p>With a command doing the same amount of work as the previous one for the
<em>blocks</em> table (I still kept the longitude and latitude to point formating):</p>

<pre><code>                    table name       read   imported     errors       time
------------------------------  ---------  ---------  ---------  ---------
                       extract          0          0          0      1.007
                   before load          0          0          0      0.024
------------------------------  ---------  ---------  ---------  ---------
             geonumip.location     438386     438386          0      8.868
               geonumip.blocks    1790461    1790461          0     17.425
------------------------------  ---------  ---------  ---------  ---------
             Total import time    2228847    2228847          0    27.324s
</code></pre>

<p>We can see new sections, as the command is now actually extracting the
archive (at the size and given how many tests I wanted to do, the fetching
step as been avoided in the tests here), then preparing the load with all
the
<code>CREATE TABLE IF NOT EXISTS</code> steps, and then actually parsing the files
and loading the data.</p>




<div class="figure fig25 left dim-margin" >
  
    <img class="fig-img" src="/img/old/made-with-lisp.320.png" >
  
  
</div>


<p>So for doing the same work, we went from nearly
<strong><em>2 minutes</em></strong> with the previous
solution down to less than
<strong><em>30 seconds</em></strong>, including the zip archive extraction
and the create table steps. Another way to look at it is that
<em>pgloader</em> here
spent
<code>9.73213 µs</code> to process each row. Yeah, less than 10
<strong><em>microseconds</em></strong> per
row.</p>

<p>Declaring bankrupcy on the previous code base was maybe not the worst
decision I made this year, finally&hellip;</p>

<p>I want to note here that the python importing code is actually using the
<em>csv</em>
module for reading the files, and that module is already written in C in
fact. So we&rsquo;re actually comparing python and C on the one hand to Common
Lisp alone on the other hand.</p>

<h2 id="common-lisp-version-with-fields-to-columns-projection">Common Lisp version with fields to columns projection</h2>

<p>Now, as we have some time budget left, let&rsquo;s have the loader actually do
more work for us and convert on the fly to the data representation we are
interested into:</p>

<pre><code>                    table name       read   imported     errors       time
------------------------------  ---------  ---------  ---------  ---------
                       extract          0          0          0      1.008
                   before load          0          0          0      0.134
------------------------------  ---------  ---------  ---------  ---------
              geolite.location     438386     438386          0      9.521
                geolite.blocks    1790461    1790461          0     31.546
------------------------------  ---------  ---------  ---------  ---------
                       finally          0          0          0     31.134
------------------------------  ---------  ---------  ---------  ---------
             Total import time    2228847    2228847          0  1m13.343s
</code></pre>

<p>So this time with the extra work we&rsquo;re going from about 18 seconds up to
about 32 seconds. The projection of integers to ip ranges is costly, but we
are still so much ahead from the old solution than we have enough time to
run the command
<code>create index blocks_ip4r_idx on geolite.blocks using
gist(iprange);</code> and still finish about 40 seconds earlier.</p>

<p>This time 31,456,000 microseconds where spent loading 1,790,461 rows, and
that gives us
<code>17.568659 µs</code> per row in average, including the
<em>two bigint as
text to iprange as text</em> transformation calls. Not too bad.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Earlier in the article I said I would tell you why it&rsquo;s ok to use a
<em>parser
generator library</em> such as
<a href="http://nikodemus.github.io/esrap/">esrap</a> here, whereas in the python case it was a
burden. The first part is that we don&rsquo;t have the major
<em>platform</em> problem that
python has with version 2 against version 3:
<a href="http://www.lispworks.com/documentation/HyperSpec/Front/">the Common Lisp Specs</a> are a
really
<strong><em>stable</em></strong> base to develop libs, and so even decade old untouched code
has a really good chance to work as-is.</p>

<p><center>


 
  
  
  
  
    
      
    
  
    
  
    
      
    
  

<div class="figure fig50 dim-margin" >
  
    <a class="fancybox" href="/img/old/morland_a_carriers_stable2.jpg" data-fancybox-group="">
  
    <img class="fig-img" src="/img/old/morland_a_carriers_stable2.jpg" >
  
    </a>
  
  
</div>

</center></p>

<p><center>
<em>Another kind of <strong><em>stable</em></strong>, here</em>
</center></p>

<p>It&rsquo;s also possible and should be easy enough with
<a href="http://www.xach.com/lisp/buildapp/">cl-buildapp</a> to produce a
static all-included binary image of the application so that users don&rsquo;t have
to care about which programming language and libraires are used when
developping
<em>pgloader</em>.</p>

<p>And of course the proficiency and interactivity of using Common Lisp is so
much better than when using python than you almost wonder why, given the
performances characteristics we&rsquo;re seeing here and in almost any other test,
o why are so much people still using python?</p>

<h1 id="can-i-use-that-new-software-today">Can I use that new software today?</h1>

<p>Yes you can, be aware that it&rsquo;s not for the faint of heart in the current
shape of things. Most of the development time has been spent on features
development and testing, integration with a
<em>nice</em> enough command language and
things like that, and very few consideration has been made yet to ease of
use and advanced error management.</p>

<p>If you&rsquo;re a Common Lisp user already, you can fetch the code and look
around, the
<em>docstrings</em> and the code generated by the
<em>parser</em> should help you
figure out the API and use it. Of course, any feedback is welcome!</p>

<p>If you&rsquo;re not a Common Lisp user already, then the
<em>README.md</em> file has
instructions to get you started with the software, and you can hack your way
around with the command language from examples in that blog post. Proper
documentation of the supported commands and their options is still on the
to-do list.</p>

<p>The
<em>pgloader</em> software is distributed under the same Licence as PostgreSQL
itself, a licence in between MIT and two clauses BSD ones.</p>

<p>As I don&rsquo;t consider the software ready for the general public (mainly
because of the lack of proper docs), it&rsquo;s not yet published at the usual
place within
<a href="http://github.com/dimitri">my github repositories</a>, instead you can find it at its interm
place:
<a href="http://git.tapoueh.org/?p=pgloader.git;a=summary">http://git.tapoueh.org/?p=pgloader.git;a=summary</a>.</p>

<p>Any contributions are welcome to help polish
<em>pgloader</em>, have fun!</p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small"></span><br/>
                    
  <a class="tag tag--primary tag--small" href="http://tapoueh.org//tags/postgresql/">PostgreSQL</a>

  <a class="tag tag--primary tag--small" href="http://tapoueh.org//tags/pgloader/">pgloader</a>

  <a class="tag tag--primary tag--small" href="http://tapoueh.org//tags/ip4r/">ip4r</a>

  <a class="tag tag--primary tag--small" href="http://tapoueh.org//tags/extensions/">Extensions</a>

  <a class="tag tag--primary tag--small" href="http://tapoueh.org//tags/common-lisp/">Common-Lisp</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  <div class="post-footer-tags">
    
    
    <script async id="_ck_218061" src="https://forms.convertkit.com/218061?v=6"></script>
    
    
  </div>
  <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/10/a-worthwile-micro-optimisation/" data-tooltip="A Worthwile Micro Optimisation">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml"></span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/09/open-world-forum-2013/" data-tooltip="Open World Forum 2013">
          
            <span class="hide-xs hide-sm text-small icon-mr"></span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Loading%20Geolocation%20Data with @tapoueh: http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#table-of-contents">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2017 Dimitri Fontaine. 
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        <div class="post-actions-wrap">
  <div class="post-footer-tags">
    
    
    <script async id="_ck_218061" src="https://forms.convertkit.com/218061?v=6"></script>
    
    
  </div>
  <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/10/a-worthwile-micro-optimisation/" data-tooltip="A Worthwile Micro Optimisation">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml"></span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/09/open-world-forum-2013/" data-tooltip="Open World Forum 2013">
          
            <span class="hide-xs hide-sm text-small icon-mr"></span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Loading%20Geolocation%20Data with @tapoueh: http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#table-of-contents">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <ul class="share-options">
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
        <i class="fa fa-google-plus"></i><span></span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
        <i class="fa fa-facebook-official"></i><span></span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Loading%20Geolocation%20Data with @tapoueh: http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
        <i class="fa fa-twitter"></i><span></span>
      </a>
    </li>
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=110" alt="" />
    
    <h4 id="about-card-name">Dimitri Fontaine</h4>
    
      <div id="about-card-bio">PostgreSQL Major Contributor</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Open Source Software Engineer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        France
      </div>
    
  </div>
</div>

    <div id="algolia-search-modal" class="modal-container">
  <div class="modal">
    <div class="modal-header">
      <span class="close-button"><i class="fa fa-close"></i></span>
      <a href="https://algolia.com" target="_blank" class="searchby-algolia text-color-light link-unstyled">
        <span class="searchby-algolia-text text-color-light text-small">by</span>
        <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
      </a>
      <i class="search-icon fa fa-search"></i>
      <form id="algolia-search-form">
        <input type="text" id="algolia-search-input" name="search"
          class="form-control input--large search-input" placeholder="" />
      </form>
    </div>
    <div class="modal-body">
      <div class="no-result text-color-light text-center"></div>
      <div class="results">
        
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/09/on-json-and-sql/">
                <h3 class="media-heading">on Json and SQL</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Sep 9, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>PostgreSQL has had proper
<a href="https://www.postgresql.org/docs/current/static/datatype-json.html">json</a>
support for a while now. The unique extensibility approach of the PostgreSQL
system allows it to enable native <a href="https://www.postgresql.org/docs/current/static/functions-json.html">SQL friendly JSON
processing</a>.</p>

<p>In this article we&rsquo;ll play with the <a href="https://mtgjson.com">Magic: the Gathering card data in JSON
format</a> data set, provided with a
<a href="https://creativecommons.org/choose/zero/">CC0</a> licence, and process the
information provided. We also see how to normalize a JSON document into a
proper database model that benefits from some PostgreSQL advanced features,
and how to then inject the JSON documents into the normalized database
schema. Finally, we compare some non-trivial processing done against both
versions of the database schema.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/09/mastering-postgresql-in-application-development/">
                <h3 class="media-heading">Mastering PostgreSQL in Application Development</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Sep 9, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">Mastering PostgreSQL in Application Development is the full title of the book I am currently writing. Running the PostgreSQL is YeSQL series of blog posts has shown me developers need a PostgreSQL book for developers. A book with the same properties as the YeSQL series articles in this blog:
 we use real world data sets to put every query and SQL technique we learn in the context of a user story or business case,</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/08/regular-expressions-and-grouping-sets/">
                <h3 class="media-heading">Regular Expressions and Grouping Sets</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Aug 8, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>There&rsquo;s a very rich set of PostgreSQL functions to process text, you can
find them all at
the
<a href="https://www.postgresql.org/docs/current/static/functions-string.html">String Functions and Operators</a> documentation
chapter, with functions such as <em>overlay</em>, <em>substring</em>, <em>position</em> or
<em>trim</em>. Or aggregates such as <em>string_agg</em>. And then <em>regular expression</em>
functions, including the very powerful <em>regexp_split_to_table</em>.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/08/sql-regression-tests/">
                <h3 class="media-heading">SQL Regression Tests</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Aug 8, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>In a previous article here we
saw <a href="/blog/2017/06/how-to-write-sql/">How to Write SQL</a> in your application
code. The main idea in that article is to maintain your queries in separate
SQL files, where it&rsquo;s easier to maintain them. In particular if you want to
be able to test them again in production, and when you have to work and
rewrite queries.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/07/from-mysql-to-postgresql/">
                <h3 class="media-heading">from MySQL to PostgreSQL</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Today
<a href="https://github.com/dimitri/pgloader/releases/tag/v3.4.1">pgloader v3.4.1</a>
is released and available! This new release comes with 110 commits as show
in
<a href="https://github.com/dimitri/pgloader/compare/v3.3.2...v3.4.1">github compare view</a>.</p>

<p>This release of <a href="http://pgloader.io">pgloader</a> is following the tradition of
simplifying things for users, or if you allow me to
quote <a href="https://en.wikiquote.org/wiki/Alan_Kay">Alan Kay</a>, I believe that if
<em>simple things should be simple, complex things should be possible.</em></p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/07/playing-with-unicode/">
                <h3 class="media-heading">Playing with Unicode</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>The reason why I like Unicode a lot is because it allows me to code in text
based environments and still have nice output. Today, we&rsquo;re going to play
with
<a href="https://en.wikipedia.org/wiki/Regional_Indicator_Symbol">Regional Indicator Symbol</a>,
which is implemented as a Unicode combinaison of letters from 🇦 to 🇿. For
instance, if you display 🇫 then 🇷 concatenated together, you get 🇫🇷. Let&rsquo;s
try that from our <a href="https://www.postgresql.org/">PostgreSQL</a> prompt!</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/06/postgresql-and-the-calendar/">
                <h3 class="media-heading">PostgreSQL and the calendar</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jun 6, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>The modern calendar is a trap for the young engineer&rsquo;s mind. We deal with
the calendar on a daily basis and until exposed to its insanity it&rsquo;s rather
common to think that calendar based computations are easy. That&rsquo;s until
you&rsquo;ve tried to do it once. A very good read about how the current calendar
came to be the way it is now is Erik&rsquo;s
Naggum <a href="http://naggum.no/lugm-time.html">The Long, Painful History of Time</a>.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/06/sql-and-business-logic/">
                <h3 class="media-heading">SQL and Business Logic</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jun 6, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Business logic is <em>supposed to be</em> the part of the application where you
deal with customer or user facing decisions and computations. It is often
argued that this part should be well separated from the rest of the
technical infrastructure of your code. Of course, SQL and relational
database design is meant to support your business cases (or user stories),
so then we can ask ourselves if SQL should be part of your business logic
implementation. Or actually, how much of your business logic should be SQL?</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/06/exploring-a-data-set-in-sql/">
                <h3 class="media-heading">Exploring a Data Set in SQL</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jun 6, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Sometimes you need to dive in an existing data set that you know very little
about. Let&rsquo;s say we&rsquo;ve been lucky to have had a high level description of
the business case covered by a database, and then access to it. Our next
step is figuring out data organisation, content and quality. Our tool box:
<em>the world&rsquo;s most advanced open source
database</em>, <a href="https://www.postgresql.org">PostgreSQL</a>, and its <em>Structured
Query Language</em>, SQL.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/06/how-to-write-sql/">
                <h3 class="media-heading">How to Write SQL</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jun 6, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p><a href="https://twitter.com/krisajenkins">Kris Jenkins</a> cooked up a very nice way
to embed SQL in your
code: <a href="https://github.com/krisajenkins/yesql">YeSQL for Clojure</a>. The main
idea is that you should be writing your SQL queries in <code>.sql</code> files in your
code repository and maintain them there.</p>

<p>The idea is very good and it is now possible to find alternative
implementations of the <a href="https://clojure.org">Clojure</a> <em>yesql</em> library in
other languages. Today, we are going to have a look at one of them for
the <a href="https://www.python.org">python</a> programming
language: <a href="https://github.com/honza/anosql">anosql</a>.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
      </div>
    </div>
    <div class="modal-footer">
      <p class="results-count text-medium"
         data-message-zero=""
         data-message-one=""
         data-message-other="">
         241 posts found
      </p>
    </div>
  </div>
</div>
    
  
    
    <div id="cover" style="background-image:url('http://tapoueh.org/images/mayan-calendar.jpg');"></div>
  


    
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.js"></script>


<script src="/js/script-wl33z0n6ocaypepiqrazthtivfrliqijej4rq8ek8gvrv1awftmgjuv8k4zc.min.js"></script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight').each(function(i, block) {
    var code = "";
    hljs.highlightAuto(block.innerText).value.split(/\r\n|\r|\n/).forEach(function(line) {
      code += "<span class=\"line\">" + line + "</span><br>";
    });
    if (code.length > 0) {
      block.innerHTML = code;  
    }
  });
  $('pre > code').each(function(i, block) {
    $(this).addClass('codeblock');
    hljs.highlightBlock(block);
  });
});
</script>

  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'http:\/\/tapoueh.org\/blog\/2013\/10\/loading-geolocation-data\/';
          
            this.page.identifier = '\/blog\/2013\/10\/loading-geolocation-data\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'tapoueh';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  





    
  </body>
</html>

