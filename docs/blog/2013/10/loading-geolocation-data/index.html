

  
    
  


  




  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.20.7">
    <meta name="theme" content="Tranquilpeak 0.3.1-BETA">
    <title>Loading Geolocation Data</title>
    <meta name="author" content="Dimitri Fontaine">
    <meta name="keywords" content="">

    <link rel="icon" href="/favicon.ico">
    

    
    <meta name="description" content="As I&rsquo;ve been mentionning in the past already, I&rsquo;m currently rewriting pgloader from scratch in Common Lisp. In terms of technical debt that&rsquo;s akin to declaring bankrupcy, which is both sad news and good news as there&rsquo;s suddenly new hope of doing it right this time.
Let&rsquo;s dive into the python to common lisp rewrite
Why rewriting pgloader? Several problems hinted me into doing something other than maintaining the code I had for pgloader.">
    <meta property="og:description" content="As I&rsquo;ve been mentionning in the past already, I&rsquo;m currently rewriting pgloader from scratch in Common Lisp. In terms of technical debt that&rsquo;s akin to declaring bankrupcy, which is both sad news and good news as there&rsquo;s suddenly new hope of doing it right this time.
Let&rsquo;s dive into the python to common lisp rewrite
Why rewriting pgloader? Several problems hinted me into doing something other than maintaining the code I had for pgloader.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Loading Geolocation Data">
    <meta property="og:url" content="/blog/2013/10/loading-geolocation-data/">
    <meta property="og:site_name" content="Dimitri Fontaine, PostgreSQL Expert">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Dimitri Fontaine, PostgreSQL Expert">
    <meta name="twitter:description" content="As I&rsquo;ve been mentionning in the past already, I&rsquo;m currently rewriting pgloader from scratch in Common Lisp. In terms of technical debt that&rsquo;s akin to declaring bankrupcy, which is both sad news and good news as there&rsquo;s suddenly new hope of doing it right this time.
Let&rsquo;s dive into the python to common lisp rewrite
Why rewriting pgloader? Several problems hinted me into doing something other than maintaining the code I had for pgloader.">
    
      <meta name="twitter:creator" content="@tapoueh">
    
    

    
    

    
      <meta property="og:image" content="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=640">
    

    
      <meta property="og:image" content="http://tapoueh.org/img/old/lisp-python.png">
    
    
      <meta property="og:image" content="http://tapoueh.org/img/old/lisp-python.png">
    
    

    

    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" />
    
    
    <link rel="stylesheet" href="/css/style-u6mk0ojoywresbx8iepslrmmhl4stuhrsxuwhkpwrkrx7mryjcaimasnk4pi.min.css" />
    
    
      <link rel="stylesheet" href="http://tapoueh.org//css/dim.css">
    

    
      
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-47059482-1', 'auto');
ga('send', 'pageview');
</script>

    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="2">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/">Dimitri Fontaine, PostgreSQL Expert</a>
  </div>
  
</header>

      <nav id="sidebar" data-behavior="2">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about">
          <img class="sidebar-profile-picture" src="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=110" alt="" />
        </a>
        <h4 class="sidebar-profile-name">Dimitri Fontaine</h4>
        
          <h5 class="sidebar-profile-bio">PostgreSQL Major Contributor</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/">
    
      <i class="sidebar-button-icon fa fa-lg fa-pagelines"></i>
      
      <span class="sidebar-button-desc">Blog</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/about/">
    
      <i class="sidebar-button-icon fa fa-lg fa-beer"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/book/">
    
      <i class="sidebar-button-icon fa fa-lg fa-book"></i>
      
      <span class="sidebar-button-desc">Book</span>
    </a>
  </li>

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/dimitri" target="_blank">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/tapoueh" target="_blank">
    
      <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>

    </ul>
  </div>
</nav>

      
  <div class="post-header-cover
              text-left
              post-header-cover--partial"
       style="background-image:url('/img/old/lisp-python.png')"
       data-behavior="2">
    
  </div>


      <div id="main" data-behavior="2"
        class="hasCover
               hasCoverMetaOut
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Loading Geolocation Data
    </h1>
  
  <div class="postShorten-meta post-meta">
  
    <time itemprop="datePublished" datetime="2013-10-01T16:52:00&#43;02:00">
      
  
  
  
  
    Tuesday 01 Oct 2013
  

    </time>
  
  
  
  
    <span></span>
    
      <a class="category-link" href="/categories/projects">Projects</a>, 
    
      <a class="category-link" href="/categories/pgloader">pgloader</a>
    
  


</div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              

<p>As I&rsquo;ve been mentionning in the past already, I&rsquo;m currently rewriting
pgloader from scratch in
<a href="/tags/common-lisp">Common Lisp</a>. In terms of
<a href="http://en.wikipedia.org/wiki/Technical_debt">technical debt</a> that&rsquo;s akin
to declaring
<em>bankrupcy</em>, which is both sad news and good news as there&rsquo;s
suddenly new hope of doing it right this time.</p>

<p><center><em>Let&rsquo;s dive into the python to common lisp rewrite</em></center></p>

<h2 id="why-rewriting-pgloader">Why rewriting pgloader?</h2>

<p>Several problems hinted me into doing something other than maintaining the
code I had for
<a href="/projects/pgloader">pgloader</a>.</p>

<p>First, the configuration file format was already used well beyond its
capacities: it&rsquo;s quite hard to express advanced fine grained options when
using the infamous
<a href="http://en.wikipedia.org/wiki/INI_file">INI file format</a>. Continuing with python I did consider
using the
<a href="http://pyparsing.wikispaces.com/">pyparsing</a> library and even went as far as writing a prototype
command language with it. While the lib was working great for that, at the
time at least it wasn&rsquo;t available for
<em>Python 3</em> and not to be found in some
OS vendors.
<em>pgloader</em> is available today for Debian and derivatives, RedHat
and derivatives, FreeBSD, OpenBSD, and some more. And you can easily enough
use it on Windows too, because it only depends on
<a href="http://initd.org/psycopg/">Psycopg</a>, basically, so
that I wanted to keep things simple for the end user. Basically, integrating
that lib was a problem.</p>

<p>Then again, the performances were a bigger and bigger worry for me as the
size of files one want to load into its database grew bigger. The real
problem was not perceived as the current performance characteristics but
rather how to improve them, and I didn&rsquo;t see many ways forward. The most
obvious one was to rewrite critical parts in C, but if I need to switch away
from python I&rsquo;d rather find a better compromse than writing python modules
in C.</p>

<p>That&rsquo;s in short what lead me to consider alternatives. And as I had some
really good preliminary performances results with a programming language I
can actually like, I decided to go with Common Lisp.</p>

<h2 id="a-test-case">A Test case</h2>

<p>The blog post I actually wanted to write would have been about the awesome
<a href="https://github.com/RhodiumToad/ip4r">ip4r</a> extension, which is about indexing IP range searches as mostly used
nowadays in
<em>geoip location</em>. The first step here is to find some data to use
and load them, and wanting to do that I realised we were lacking an
all-integrated tool easy enough to use.</p>

<p>And that&rsquo;s exactly the reason why I&rsquo;m working on
<em>pgloader</em> in the first
place, to make it really easy to load data, converting it on the fly and all
the jazz. And that
<em>ip4r</em> test case actually has been a very good excuse at
improving what I already had.</p>

<p><center>


 
  
  
  
  
    
      
    
  
    
  
    
      
    
  

<div class="figure fig50 dim-margin" >
  
    <a class="fancybox" href="/img/old/toy-loader.320.jpg" data-fancybox-group="">
  
    <img class="fig-img" src="/img/old/toy-loader.320.jpg" >
  
    </a>
  
  
</div>

</center></p>

<h2 id="the-new-pgloader-command-language">The new pgloader command language</h2>

<p>Here&rsquo;s the current way of doing things with the new
<em>pgloader</em> written in
Common-Lisp, then I&rsquo;ll tell you why using a
<em>parser generator library</em> in that
language is less of a burden than doing the same thing in Python:</p>

<pre><code>LOAD FROM ARCHIVE http://geolite.maxmind.com/download/geoip/database/GeoLiteCity_CSV/GeoLiteCity-latest.zip
   INTO postgresql://dim@localhost:54393/dim

BEFORE LOAD DO
   $$ create extension if not exists ip4r; $$,
   $$ create schema if not exists geolite; $$,
   $$ create table if not exists geolite.location
     (
        locid      integer primary key,
        country    text,
        region     text,
        city       text,
        postalcode text,
        location   point,
        metrocode  text,
        areacode   text
     );
   $$,
   $$ create table if not exists geolite.blocks
     (
        iprange    ip4r,
        locid      integer
     );
   $$,
   $$ drop index if exists geolite.blocks_ip4r_idx; $$,
   $$ truncate table geolite.blocks, geolite.location cascade; $$

    LOAD CSV FROM FILENAME MATCHING ~/GeoLiteCity-Location.csv/
             WITH ENCODING iso-8859-1
             (
                locId,
                country,
                region     null if blanks,
                city       null if blanks,
                postalCode null if blanks,
                latitude,
                longitude,
                metroCode  null if blanks,
                areaCode   null if blanks
             )
        INTO postgresql://dim@localhost:54393/ip4r?geolite.location
             (
                locid,country,region,city,postalCode,
                location point using (format nil &quot;(~a,~a)&quot; longitude latitude),
                metroCode,areaCode
             )
        WITH skip header = 2,
             fields optionally enclosed by '&quot;',
             fields escaped by double-quote,
             fields terminated by ','

AND LOAD CSV FROM FILENAME MATCHING ~/GeoLiteCity-Blocks.csv/
             WITH ENCODING iso-8859-1
             (
                startIpNum, endIpNum, locId
             )
        INTO postgresql://dim@localhost:54393/ip4r?geolite.blocks
             (
                iprange ip4r using (ip-range startIpNum endIpNum),
                locId
             )
        WITH skip header = 2,
             fields optionally enclosed by '&quot;',
             fields escaped by double-quote,
             fields terminated by ','

FINALLY DO
   $$
     create index blocks_ip4r_idx on geolite.blocks using gist(iprange);
   $$;
</code></pre>

<p>What you see here looks quite complex and heavy. That&rsquo;s because it&rsquo;s
addressing the full needs, let&rsquo;s see about that:</p>

<ul>
<li><p>the source of the data loading is a <em>zip archive</em> that we have to download from a <em>http url</em>,</p></li>

<li><p>the <em>zip archive</em> contains a single directory entry wherein we find the data files we want to load, currently <code>GeoLiteCity_20130903</code>&hellip; as we want to be able to update the data without having to edit the command, you will note the support for matching the file name against a full path name: <code>FILENAME MATCHING ~/GeoLiteCity-Blocks.csv/</code> is applying a regular expression,</p></li>

<li><p>we want the loading process to take care about creating the database schema we&rsquo;re going to use, and even drop the current index if any before loading, because we know that loading the data in bulk and then creating the index is way faster than keeping the index around,</p></li>

<li><p>there&rsquo;s no out of band place where to register whether a field value is null in a plain text CSV file, even if technically that could be done, so we have to provide per field instructions on what a <code>NULL</code> will look like in the data itself,</p></li>

<li><p>the files we&rsquo;re using don&rsquo;t have the exact definition we want: rather than a pair of <em>double precision</em> fields for hosting the location we want a <a href="http://www.postgresql.org/docs/9.3/static/datatype-geometric.html#AEN6542">PostgreSQL point</a> datatype column; and rather than a pair of <em>bigint</em> fields we want an <em>ip4r</em> column in PostgreSQL,</p></li>

<li><p>and of course as soon as the data loading is done we want to create the shiny <em>ip4r</em> <strong>GiST</strong> index.</p></li>
</ul>

<p>And as we are using an attribution licence for the data here, let me tell
you that: This article includes
<strong>GeoLite</strong> data created by
<strong>MaxMind</strong>, available
from
<a href="http://www.maxmind.com">http://www.maxmind.com</a>.</p>

<h2 id="transforming-and-projecting">Transforming and Projecting</h2>

<p>The former
<em>pgloader</em> was capable of using dynamic python code to reformat
fields on the fly, which was already quite good, but not up to the task
described just above. What we really want to be able to do here is
<em>project</em>
any number of fields into a
<em>possibly different</em> number of columns that are
dependant on the fields.</p>

<p><center>


 
  
  
  
  
    
      
    
  
    
  
    
      
    
  

<div class="figure fig50 dim-margin" >
  
    <a class="fancybox" href="/img/old/huge-full-outer-join.gif" data-fancybox-group="">
  
    <img class="fig-img" src="/img/old/huge-full-outer-join.gif" >
  
    </a>
  
  
</div>

</center></p>

<p><center><em>Traditionnaly used for Full Outer Join, but I liked the symbol</em></center></p>

<p>In the simplest case possible, each field ends up into a column of the same
name, and that&rsquo;s still supported of course, it looks like this:</p>

<pre><code>LOAD CSV FROM FILENAME MATCHING ~/GeoLiteCity-Blocks.csv/
         WITH ENCODING iso-8859-1
    INTO postgresql://dim@localhost:54393/ip4r?geonumip.blocks
    WITH skip header = 2,
         fields optionally enclosed by '\&quot;',
         fields escaped by double-quote,
         fields terminated by ',';
</code></pre>

<p>That&rsquo;s a very simple processing actually, with no added processing when
reading the file.</p>

<p>In the previous example though, we&rsquo;re using a
<em>transformation</em> function that I
included in
<em>pgloader</em> to transform a couple of integers into an
<em>iprange</em>.
Here&rsquo;s the Common Lisp sources for that function:</p>

<pre><code>(defun ip-range (start-integer-string end-integer-string)
  &quot;Transform a couple of integers to an IP4R ip range notation.&quot;
  (declare (inline)
	   (optimize speed)
	   (type string start-integer-string end-integer-string))
  (flet ((integer-to-ip-string (int)
	   &quot;see http://dev.maxmind.com/geoip/legacy/csv/&quot;
	   (declare (inline) (optimize speed) (type fixnum int))
	   (format nil &quot;~a.~a.~a.~a&quot;
		   (mod (truncate int #. (expt 2 24)) 256)
		   (mod (truncate int #. (expt 2 16)) 256)
		   (mod (truncate int #. (expt 2 8)) 256)
		   (mod int 256))))
    (let ((ip-start (integer-to-ip-string (parse-integer start-integer-string)))
	  (ip-end   (integer-to-ip-string (parse-integer end-integer-string))))
      (format nil &quot;~a-~a&quot; ip-start ip-end))))
</code></pre>

<p>And here&rsquo;s how it&rsquo;s used:</p>

<pre><code>INTO postgresql://dim@localhost:54393/ip4r?geolite.blocks
     (
        iprange ip4r using (ip-range startIpNum endIpNum),
        locId
     )
</code></pre>

<p>Internally, pgloader generates a
<em>lambda</em> expression to process each row, in
that very case the expression looks like this:</p>

<pre><code>(lambda (row)
  (destructuring-bind (startIpNum endIpNum locId) row
    (list (pgloader.transforms::ip-range startIpNum endIpNum)
          locId)))
</code></pre>

<p>That generated lambda expression is then
<strong><em>compiled</em></strong> on the fly into machine
code that is then executed for each row input. That&rsquo;s the kind of things
allowing Common Lisp programmers not to resort to C.</p>

<p><center>


 
  
  
  
  
    
      
    
  
    
  
    
      
    
  

<div class="figure fig50 dim-margin" >
  
    <a class="fancybox" href="/img/old/lisplogo_fancy_256.png" data-fancybox-group="">
  
    <img class="fig-img" src="/img/old/lisplogo_fancy_256.png" >
  
    </a>
  
  
</div>

</center></p>

<p>Note that as in the previous
<em>location</em> example you can also directly write
the Lisp expressions within the command itself:</p>

<pre><code>INTO postgresql://dim@localhost:54393/ip4r?geolite.location
     (
        locid,country,region,city,postalCode,
        location point using (format nil &quot;(~a,~a)&quot; longitude latitude),
        metroCode,areaCode
     )
</code></pre>

<h2 id="simple-benchmarking">Simple benchmarking</h2>

<p>Enough presenting the software already, let&rsquo;s run it!</p>

<h3 id="python-version">Python version</h3>

<p>First, let&rsquo;s run the current python pgloader code against our dataset. Note
that you will have to download and unzip the data yourself here, then
prepare that kind of configuration file:</p>

<pre><code>[pgsql]
base = pgloader

log_file            = /tmp/pgloader.log
log_min_messages    = INFO
client_min_messages = WARNING

client_encoding = 'latin1'
lc_messages         = C
pg_option_standard_conforming_strings = on
; This setting has no effect other than allowing to check option precedence
pg_option_work_mem = 12MB

copy_every      = 25000
commit_every    = 25000
#copy_delimiter  = %

null         = &quot;&quot;
empty_string = &quot;\ &quot;

[tmpl]
template        = True
format          = csv
field_sep       = ,
skip_head_lines = 2

[location]
use_template    = tmpl
table           = location
filename        = /tmp/GeoLiteCity-latest/GeoLiteCity_20130903/GeoLiteCity-Location.csv
columns         = *

[blocks]
use_template    = tmpl
table           = blocks
filename        = /tmp/GeoLiteCity-latest/GeoLiteCity_20130903/GeoLiteCity-Blocks.csv
columns         = *
skip_head_lines = 2
</code></pre>

<p>And with that we can do:</p>

<pre><code>./pgloader.py -R reformat -sTv -c ~/dev/temp/pgloader.geolite.conf
   ... edited ...
Table name        |    duration |    size |  copy rows |     errors 
====================================================================
blocks            |  01m18.979s |       - |    1790461 |          0
location          |     35.710s |       - |     438386 |          0
====================================================================
Total             |  01m54.713s |       - |    2228847 |          0
</code></pre>

<h3 id="common-lisp-version-no-projection">Common Lisp version, no projection</h3>

<p>With a command doing the same amount of work as the previous one for the
<em>blocks</em> table (I still kept the longitude and latitude to point formating):</p>

<pre><code>                    table name       read   imported     errors       time
------------------------------  ---------  ---------  ---------  ---------
                       extract          0          0          0      1.007
                   before load          0          0          0      0.024
------------------------------  ---------  ---------  ---------  ---------
             geonumip.location     438386     438386          0      8.868
               geonumip.blocks    1790461    1790461          0     17.425
------------------------------  ---------  ---------  ---------  ---------
             Total import time    2228847    2228847          0    27.324s
</code></pre>

<p>We can see new sections, as the command is now actually extracting the
archive (at the size and given how many tests I wanted to do, the fetching
step as been avoided in the tests here), then preparing the load with all
the
<code>CREATE TABLE IF NOT EXISTS</code> steps, and then actually parsing the files
and loading the data.</p>

<p>So for doing the same work, we went from nearly
<strong><em>2 minutes</em></strong> with the previous
solution down to less than
<strong><em>30 seconds</em></strong>, including the zip archive extraction
and the create table steps. Another way to look at it is that
<em>pgloader</em> here
spent
<code>9.73213 µs</code> to process each row. Yeah, less than 10
<strong><em>microseconds</em></strong> per
row.</p>

<p>Declaring bankrupcy on the previous code base was maybe not the worst
decision I made this year, finally&hellip;</p>

<p>I want to note here that the python importing code is actually using the
<em>csv</em>
module for reading the files, and that module is already written in C in
fact. So we&rsquo;re actually comparing python and C on the one hand to Common
Lisp alone on the other hand.</p>

<p><center>


 
  
  
  
  
    
      
    
  
    
  
    
      
    
  

<div class="figure fig50 dim-margin" >
  
    <a class="fancybox" href="/img/old/made-with-lisp.png" data-fancybox-group="">
  
    <img class="fig-img" src="/img/old/made-with-lisp.png" >
  
    </a>
  
  
</div>

</center></p>

<h3 id="common-lisp-version-with-fields-to-columns-projection">Common Lisp version with fields to columns projection</h3>

<p>Now, as we have some time budget left, let&rsquo;s have the loader actually do
more work for us and convert on the fly to the data representation we are
interested into:</p>

<pre><code>                    table name       read   imported     errors       time
------------------------------  ---------  ---------  ---------  ---------
                       extract          0          0          0      1.008
                   before load          0          0          0      0.134
------------------------------  ---------  ---------  ---------  ---------
              geolite.location     438386     438386          0      9.521
                geolite.blocks    1790461    1790461          0     31.546
------------------------------  ---------  ---------  ---------  ---------
                       finally          0          0          0     31.134
------------------------------  ---------  ---------  ---------  ---------
             Total import time    2228847    2228847          0  1m13.343s
</code></pre>

<p>So this time with the extra work we&rsquo;re going from about 18 seconds up to
about 32 seconds. The projection of integers to ip ranges is costly, but we
are still so much ahead from the old solution than we have enough time to
run the command
<code>create index blocks_ip4r_idx on geolite.blocks using
gist(iprange);</code> and still finish about 40 seconds earlier.</p>

<p>This time 31,456,000 microseconds where spent loading 1,790,461 rows, and
that gives us
<code>17.568659 µs</code> per row in average, including the
<em>two bigint as
text to iprange as text</em> transformation calls. Not too bad.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Earlier in the article I said I would tell you why it&rsquo;s ok to use a
<em>parser
generator library</em> such as
<a href="http://nikodemus.github.io/esrap/">esrap</a> here, whereas in the python case it was a
burden. The first part is that we don&rsquo;t have the major
<em>platform</em> problem that
python has with version 2 against version 3:
<a href="http://www.lispworks.com/documentation/HyperSpec/Front/">the Common Lisp Specs</a> are a
really
<strong><em>stable</em></strong> base to develop libs, and so even decade old untouched code
has a really good chance to work as-is.</p>

<p><center>


 
  
  
  
  
    
      
    
  
    
  
    
      
    
  

<div class="figure fig50 dim-margin" >
  
    <a class="fancybox" href="/img/old/morland_a_carriers_stable2.jpg" data-fancybox-group="">
  
    <img class="fig-img" src="/img/old/morland_a_carriers_stable2.jpg" >
  
    </a>
  
  
</div>

</center></p>

<p><center>*Another kind of <strong><em>stable</em></strong>, here*</center></p>

<p>It&rsquo;s also possible and should be easy enough with
<a href="http://www.xach.com/lisp/buildapp/">cl-buildapp</a> to produce a
static all-included binary image of the application so that users don&rsquo;t have
to care about which programming language and libraires are used when
developping
<em>pgloader</em>.</p>

<p>And of course the proficiency and interactivity of using Common Lisp is so
much better than when using python than you almost wonder why, given the
performances characteristics we&rsquo;re seeing here and in almost any other test,
o why are so much people still using python?</p>

<h2 id="can-i-use-that-new-software-today">Can I use that new software today?</h2>

<p>Yes you can, be aware that it&rsquo;s not for the faint of heart in the current
shape of things. Most of the development time has been spent on features
development and testing, integration with a
<em>nice</em> enough command language and
things like that, and very few consideration has been made yet to ease of
use and advanced error management.</p>

<p>If you&rsquo;re a Common Lisp user already, you can fetch the code and look
around, the
<em>docstrings</em> and the code generated by the
<em>parser</em> should help you
figure out the API and use it. Of course, any feedback is welcome!</p>

<p>If you&rsquo;re not a Common Lisp user already, then the
<em>README.md</em> file has
instructions to get you started with the software, and you can hack your way
around with the command language from examples in that blog post. Proper
documentation of the supported commands and their options is still on the
to-do list.</p>

<p>The
<em>pgloader</em> software is distributed under the same Licence as PostgreSQL
itself, a licence in between MIT and two clauses BSD ones.</p>

<p>As I don&rsquo;t consider the software ready for the general public (mainly
because of the lack of proper docs), it&rsquo;s not yet published at the usual
place within
<a href="http://github.com/dimitri">my github repositories</a>, instead you can find it at its interm
place:
<a href="http://git.tapoueh.org/?p=pgloader.git;a=summary">http://git.tapoueh.org/?p=pgloader.git;a=summary</a>.</p>

<p>Any contributions are welcome to help polish
<em>pgloader</em>, have fun!</p>

              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small"></span><br/>
                    
  <a class="tag tag--primary tag--small" href="http://tapoueh.org//tags/postgresql/">PostgreSQL</a>

  <a class="tag tag--primary tag--small" href="http://tapoueh.org//tags/pgloader/">pgloader</a>

  <a class="tag tag--primary tag--small" href="http://tapoueh.org//tags/ip4r/">ip4r</a>

  <a class="tag tag--primary tag--small" href="http://tapoueh.org//tags/extensions/">Extensions</a>

  <a class="tag tag--primary tag--small" href="http://tapoueh.org//tags/common-lisp/">Common-Lisp</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/10/a-worthwile-micro-optimisation/" data-tooltip="A Worthwile Micro Optimisation">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml"></span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/09/open-world-forum-2013/" data-tooltip="Open World Forum 2013">
          
            <span class="hide-xs hide-sm text-small icon-mr"></span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Loading%20Geolocation%20Data with @tapoueh: http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2017 Dimitri Fontaine. 
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
        <div class="post-actions-wrap">
  <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/10/a-worthwile-micro-optimisation/" data-tooltip="A Worthwile Micro Optimisation">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml"></span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/09/open-world-forum-2013/" data-tooltip="Open World Forum 2013">
          
            <span class="hide-xs hide-sm text-small icon-mr"></span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Loading%20Geolocation%20Data with @tapoueh: http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="2">
  <ul class="share-options">
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
        <i class="fa fa-google-plus"></i><span></span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
        <i class="fa fa-facebook-official"></i><span></span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Loading%20Geolocation%20Data with @tapoueh: http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2floading-geolocation-data%2f">
        <i class="fa fa-twitter"></i><span></span>
      </a>
    </li>
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=110" alt="" />
    
    <h4 id="about-card-name">Dimitri Fontaine</h4>
    
      <div id="about-card-bio">PostgreSQL Major Contributor</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Open Source Software Engineer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        France
      </div>
    
  </div>
</div>

    <div id="algolia-search-modal" class="modal-container">
  <div class="modal">
    <div class="modal-header">
      <span class="close-button"><i class="fa fa-close"></i></span>
      <a href="https://algolia.com" target="_blank" class="searchby-algolia text-color-light link-unstyled">
        <span class="searchby-algolia-text text-color-light text-small">by</span>
        <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
      </a>
      <i class="search-icon fa fa-search"></i>
      <form id="algolia-search-form">
        <input type="text" id="algolia-search-input" name="search"
          class="form-control input--large search-input" placeholder="" />
      </form>
    </div>
    <div class="modal-body">
      <div class="no-result text-color-light text-center"></div>
      <div class="results">
        
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2016/04/pgconf-us-2016/">
                <h3 class="media-heading">PGConf US 2016</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2016
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p><a href="https://www.pgconf.us/conferences/2016">PostgreSQL Conference US</a> took
place in New York City and I had the pleasure to be a speaker there. I
presented there a talk about why <em>You’d Better Have Tested Backups</em>. The
important bit is that backups are not interesting, recoveries are. Also the
only way to make sure a backup is successful is to be able to use it for
recovery.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2015/11/all-your-base-conference-2015/">
                <h3 class="media-heading">All Your Base Conference 2015</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Nov 11, 2015
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>I had the pleasure to be invited to speak at
<a href="http://allyourbaseconf.com/2015/speakers#dimitri-fontaine">All Your Base Conference 2015</a>
about
<a href="http://www.postgresql.org">PostgreSQL</a> (of course). The conference gathers together lots of user
experience around data management and database products, either in the now
classic meaning of the word (I mean
<em>relational database management systems
here</em>) or the newer set of trade-offs represented by the NoSQL set of tools.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2015/05/postgresql-au-jug-de-montpellier/">
                <h3 class="media-heading">PostgreSQL au JUG de Montpellier</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  May 5, 2015
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>J&rsquo;ai eu le plaisir de présenter PostgreSQL au
<a href="http://www.jug-montpellier.org/">Java User Group de Montpellier</a>
le 20 mai dernier dans le cadre d&rsquo;une soirée
<a href="http://www.jug-montpellier.org/event/36">PostgreSQL is YeSQL</a>. L&rsquo;accueil
réservé par le
<em>JUG</em> a été parfait et je tiens à les remercier pour une très
bonne soirée de partage et d&rsquo;échanges autour de PostgreSQL.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2015/05/quicklisp-and-debian/">
                <h3 class="media-heading">Quicklisp and debian</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  May 5, 2015
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Common Lisp users are very happy to use
<a href="https://www.quicklisp.org/beta/">Quicklisp</a> when it comes to
downloading and maintaining dependencies between their own code and the
<a href="http://quickdocs.org/">librairies</a> it is using.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2015/04/pgday-paris/">
                <h3 class="media-heading">pgDay Paris</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Apr 4, 2015
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Le 21 avril prochain se tient le premier
<a href="http://pgday.paris/">pgDay Paris</a>: une conférence
<a href="http://www.postgresql.org/">PostgreSQL</a> d&rsquo;une journée complète. Il s&rsquo;agit de 8 conférences sur votre base
de données préférée par des conférencers internationaux, incluant des
retours d&rsquo;expérience et une analyse de l&rsquo;utilisation des derniers
développements en cours dans notre projet de base de données préféré.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2015/03/a-pgday-in-paris/">
                <h3 class="media-heading">a pgDay in Paris!</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Mar 3, 2015
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>I was lucky to participate as a speaker to the
<a href="http://2015.nordicpgday.org/">Nordic PostgreSQL Day 2015</a>
and it&rsquo;s been another awesome edition of the conference. Really smooth,
everything has been running as it should, with about one hundred people at
the conference.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2015/02/back-from-fosdem-2015/">
                <h3 class="media-heading">Back From FOSDEM 2015</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Feb 2, 2015
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>The
<a href="https://fosdem.org/2015/">FOSDEM 2015</a> edition has been awesome this year, the usual mix of meeting
with old friends, talking about interesting topics, seeing tremendous
activity in all Open Source domains, and having Belgium beers in the
evenings.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2015/01/my-first-slashdot-effect/">
                <h3 class="media-heading">My First Slashdot Effect</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jan 1, 2015
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Thanks to the
<a href="http://postgresweekly.com/issues/89">Postgres Weekly issue #89</a> and a post to
<a href="https://news.ycombinator.com/news">Hacker News</a> front page
(see
<a href="https://news.ycombinator.com/item?id=8924270">Pgloader: A High-speed PostgreSQL Swiss Army Knife, Written in Lisp</a> it
well seems that I just had my first
<a href="http://en.wikipedia.org/wiki/Slashdot_effect">Slashdot effect</a>&hellip;</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2015/01/new-release-pgloader-3.2/">
                <h3 class="media-heading">New release: pgloader 3.2</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jan 1, 2015
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>PostgreSQL comes with an awesome bulk copy protocol and tooling best known
as the
<a href="http://www.postgresql.org/docs/current/static/sql-copy.html">COPY</a> and
<code>\copy</code> commands. Being a transactional system, PostgreSQL
COPY implementation will
<code>ROLLBACK</code> any work done if a single error is found
in the data set you&rsquo;re importing. That&rsquo;s the reason why
<a href="http://pgloader.io/">pgloader</a> got
started: it provides with error handling for the
<a href="http://www.postgresql.org/docs/9.3/static/protocol-flow.html#PROTOCOL-COPY">COPY protocol</a>.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2014/10/meetup-postgresql-%C3%A0-paris/">
                <h3 class="media-heading">Meetup PostgreSQL à Paris</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Oct 10, 2014
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Mercredi 8 octobre se tiendra le prochain
<a href="http://www.meetup.com/PostgreSQL-User-Group-Paris/events/209650432/">Meetup PostgreSQL à Paris</a> dans les
locaux de
<a href="https://www.mozilla.org/en-US/contact/spaces/paris/">Mozilla Europe</a>, dont la capacité est de 90 personnes ! Venez
nombreux !</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
      </div>
    </div>
    <div class="modal-footer">
      <p class="results-count text-medium"
         data-message-zero=""
         data-message-one=""
         data-message-other="">
         230 posts found
      </p>
    </div>
  </div>
</div>
    
  
    
    <div id="cover" style="background-image:url('http://tapoueh.org/images/Tree_Of_Light_by_lowapproach.jpg');"></div>
  


    
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.js"></script>


<script src="/js/script-wl33z0n6ocaypepiqrazthtivfrliqijej4rq8ek8gvrv1awftmgjuv8k4zc.min.js"></script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight').each(function(i, block) {
    var code = "";
    hljs.highlightAuto(block.innerText).value.split(/\r\n|\r|\n/).forEach(function(line) {
      code += "<span class=\"line\">" + line + "</span><br>";
    });
    if (code.length > 0) {
      block.innerHTML = code;  
    }
  });
  $('pre > code').each(function(i, block) {
    $(this).addClass('codeblock');
    hljs.highlightBlock(block);
  });
});
</script>

  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'http:\/\/tapoueh.org\/blog\/2013\/10\/loading-geolocation-data\/';
          
            this.page.identifier = '\/blog\/2013\/10\/loading-geolocation-data\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'tapoueh';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  





    
  </body>
</html>

