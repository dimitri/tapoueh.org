

  
    
  


  




  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.31.1">
    <meta name="theme" content="Tranquilpeak 0.3.1-BETA">
    <title>Denormalizing Tags</title>
    <meta name="author" content="Dimitri Fontaine">
    <meta name="keywords" content="">

    <link rel="icon" href="/favicon.ico">
    

    
    <meta name="description" content="In our Tour of Extensions today&rsquo;s article is about advanced tag indexing. We have a great data collection to play with and our goal today is to be able to quickly find data matching a complex set of tags. So, let&rsquo;s find out those lastfm tracks that are tagged as blues and rhythm and blues, for instance.
 We&rsquo;re going to use the Last.fm dataset from the Million Song Dataset project here.">
    <meta property="og:description" content="In our Tour of Extensions today&rsquo;s article is about advanced tag indexing. We have a great data collection to play with and our goal today is to be able to quickly find data matching a complex set of tags. So, let&rsquo;s find out those lastfm tracks that are tagged as blues and rhythm and blues, for instance.
 We&rsquo;re going to use the Last.fm dataset from the Million Song Dataset project here.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Denormalizing Tags">
    <meta property="og:url" content="/blog/2013/10/denormalizing-tags/">
    <meta property="og:site_name" content="Dimitri Fontaine, PostgreSQL Expert">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Denormalizing Tags">
    <meta name="twitter:description" content="In our Tour of Extensions today&rsquo;s article is about advanced tag indexing. We have a great data collection to play with and our goal today is to be able to quickly find data matching a complex set of tags. So, let&rsquo;s find out those lastfm tracks that are tagged as blues and rhythm and blues, for instance.
 We&rsquo;re going to use the Last.fm dataset from the Million Song Dataset project here.">
    
      <meta name="twitter:creator" content="@tapoueh">
    
    

    
    

    
      <meta property="og:image" content="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=640">
    

    
      <meta property="og:image" content="http://tapoueh.org/img/old/wordpres-seo-categories-tags.jpg">
    
    
      <meta property="og:image" content="http://tapoueh.org/img/rock-punk-metal-music-news.jpg">
    
    

    

    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" />
    
    
    <link rel="stylesheet" href="/css/style-jsjn0006wyhpyzivf6yceb31gvpjatbcs3qzjvlumobfnugccvobqwxnnaj8.min.css" />
    
    
      <link rel="stylesheet" href="http://tapoueh.org//css/dim.css">
    
      <link rel="stylesheet" href="http://tapoueh.org//css/nav.css">
    

    
      
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-47059482-1', 'auto');
ga('send', 'pageview');
</script>

    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="navbar-collapse collapse header-title" id="navigation">
    <ul class="nav navbar-nav navbar-right">
      
      <li class="dropdown">
        
        <a href="/">blog</a>
        
      </li>
      
      <li class="dropdown">
        
        <a href="/conf/">talks</a>
        
      </li>
      
      <li class="dropdown">
        
        <a href="http://pgloader.io/">pgloader</a>
        
      </li>
      
      <li class="dropdown">
        
        <a href="http://masteringpostgresql.com/">Mastering PostgreSQL</a>
        
      </li>
      
    </ul>
  </div>

  
    
      <a class="header-right-icon "
         href="http://masteringpostgresql.com" target="_blank">
    
    
      <i class="fa fa-lg fa-book"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about">
          <img class="sidebar-profile-picture" src="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=110" alt="" />
        </a>
        <h4 class="sidebar-profile-name">Dimitri Fontaine</h4>
        
          <h5 class="sidebar-profile-bio">PostgreSQL Major Contributor</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/">
    
      <i class="sidebar-button-icon fa fa-lg fa-pagelines"></i>
      
      <span class="sidebar-button-desc">Blog</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/about/">
    
      <i class="sidebar-button-icon fa fa-lg fa-beer"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories/yesql/">
    
      <i class="sidebar-button-icon fa fa-lg fa-database"></i>
      
      <span class="sidebar-button-desc">YeSQL</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://masteringpostgresql.com" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-book"></i>
      
      <span class="sidebar-button-desc">Mastering PostgreSQL</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/dimitri" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/tapoueh" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      
  <div class="post-header-cover
              text-left
              post-header-cover--partial"
       style="background-image:url('/img/rock-punk-metal-music-news.jpg')"
       data-behavior="5">
    
      <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Denormalizing Tags
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2013-10-24T13:40:00&#43;02:00">
        
  
  
  
  
    Thursday 24 Oct 2013
  

      </time>
    
    
  
  
    <span></span>
    
      <a class="category-link" href="/categories/postgresql">PostgreSQL</a>, 
    
      <a class="category-link" href="/categories/yesql">YeSQL</a>
    
  

  </div>

</div>
    
  </div>


      <div id="main" data-behavior="5"
        class="hasCover
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              

<p>In our
<a href="/tags/extensions">Tour of Extensions</a> today&rsquo;s article is about advanced tag indexing. We
have a great data collection to play with and our goal today is to be able
to quickly find data matching a complex set of tags. So, let&rsquo;s find out
those
<a href="http://www.lastfm.fr/">lastfm</a> tracks that are tagged as
<em>blues</em> and
<em>rhythm and blues</em>, for
instance.</p>

<h1 id="table-of-contents"></h1><nav id="TableOfContents">
<ul>
<li><a href="#the-setup">The Setup</a></li>
<li><a href="#advanced-tag-indexing">Advanced tag indexing</a></li>
<li><a href="#searches">Searches</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</nav>

<p>We&rsquo;re going to use
the
<a href="http://labrosa.ee.columbia.edu/millionsong/lastfm">Last.fm dataset from the Million Song Dataset project</a> here.
The article where they present their similarity searches is providing the
whole dataset they have as a <a href="http://www.sqlite.org/">SQLite</a> database and
they propose to read their python
script
<a href="http://labrosa.ee.columbia.edu/millionsong/sites/default/files/lastfm/demo_tags_db.py">demo_tags_db.py</a> to
make sense of it.</p>

<h1 id="the-setup">The Setup</h1>

<p>First, we need to import this dataset into a PostgreSQL database. To do that
the easier path I could think of was to hack the capability into
<em>pgloader</em> of
course, so here we go:</p>

<pre><code>Â                    table name       read   imported     errors       time
------------------------------  ---------  ---------  ---------  ---------
                          tags          0     522366          0      3.922
                          tids          0     505216          0      3.746
                       tid_tag          0    8598630          0    115.349
        index build completion          0          0          0     33.099
------------------------------  ---------  ---------  ---------  ---------
                  create index          0          8          0     38.839
               reset sequences          0          0          0      0.064
------------------------------  ---------  ---------  ---------  ---------
          Total streaming time          0    9626212          0  2m36.180s
</code></pre>




<div class="figure fig25 right dim-margin" >
  
    <img class="fig-img" src="/img/old/sqlite.gif" >
  
  
</div>


<p>Here,
<em>pgloader</em> extracted the table and index definitions from the SQLite
database using the
<code>sqlite_master</code> catalog and the
<code>PRAGMA table_info()</code>
commands, and migrated the data in a streaming fashion down to PostgreSQL,
using the
<em>COPY protocol</em>.</p>

<p>Having a look at the
<em>demo_tags.py</em> script we can actually see how to use the
relations here, and we realize they are using the
<a href="http://www.sqlite.org/autoinc.html">64-bit signed integer ROWID</a> system column. We need something comparable to
be able to make sense of the data:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">&gt; <span style="color:#00a">alter</span> <span style="color:#00a">table</span> tags <span style="color:#00a">add</span> <span style="color:#00a">column</span> rowid <span style="color:#0aa">serial</span>;
<span style="color:#00a">ALTER</span> <span style="color:#00a">TABLE</span>
Time: <span style="color:#099">3177</span>.<span style="color:#099">603</span> ms

&gt; <span style="color:#00a">alter</span> <span style="color:#00a">table</span> tids <span style="color:#00a">add</span> <span style="color:#00a">column</span> rowid <span style="color:#0aa">serial</span>;
<span style="color:#00a">ALTER</span> <span style="color:#00a">TABLE</span>
Time: <span style="color:#099">2528</span>.<span style="color:#099">680</span> ms

&gt; <span style="color:#00a">SELECT</span> tags.tag, <span style="color:#00a">COUNT</span>(tid_tag.tid)
    <span style="color:#00a">FROM</span> tid_tag, tags
   <span style="color:#00a">WHERE</span> tid_tag.tag=tags.ROWID <span style="color:#00a">and</span> tags.tag ~* <span style="color:#a50">&#39;setzer&#39;</span>
<span style="color:#00a">GROUP</span> <span style="color:#00a">BY</span> tags.tag;
             
             tag             | <span style="color:#00a">count</span> 
<span style="color:#aaa;font-style:italic">-----------------------------+-------
</span><span style="color:#aaa;font-style:italic"></span> the brian setzer orchestra  |     <span style="color:#099">1</span>
 Setzer                      |    <span style="color:#099">13</span>
 rockabilly Setzer style     |     <span style="color:#099">4</span>
 setzer <span style="color:#00a">is</span> a <span style="color:#00a">true</span> guitarhero |     <span style="color:#099">9</span>
 brian setzer orchestra      |     <span style="color:#099">3</span>
 brian setzer <span style="color:#00a">is</span> GOD         |     <span style="color:#099">1</span>
 Brian Setzer                |     <span style="color:#099">1</span>
 brain setzer orchestra      |     <span style="color:#099">2</span>
(<span style="color:#099">8</span> <span style="color:#00a">rows</span>)

Time: <span style="color:#099">644</span>.<span style="color:#099">826</span> ms</code></pre></div>
<p>Here the query is mainly doing a
<em>JOIN</em> in between the
<em>tid</em> table (containing
track ids) and the
<em>tid_tag</em> table (containing association in between tracks
and tags), filtering on the
<em>case insensitive regular expression</em>
<code>'setzer'</code>. As
we can imagine from reading the query execution time, we don&rsquo;t have any
index to implement the filtering here.</p>

<h1 id="advanced-tag-indexing">Advanced tag indexing</h1>

<p>PostgreSQL comes with plenty of interesting datatypes, one of them is known
as the
<a href="http://www.postgresql.org/docs/9.3/interactive/arrays.html">Arrays Type</a>. PostgreSQL also provides a very rich set of extensions,
some of them found under the
<em>contrib</em> package; one of them is
<a href="http://www.postgresql.org/docs/9.3/interactive/intarray.html">intarray</a>. Let
me quote for you the most interesting part of the documentation for that
extension:</p>

<blockquote>
<p>The @@ and ~~ operators test whether an array satisfies a query, which is
expressed as a value of a specialized data type query_int. A query consists
of integer values that are checked against the elements of the array,
possibly combined using the operators &amp; (AND), | (OR), and ! (NOT).
Parentheses can be used as needed. For example, the query 1&amp;(2|3) matches
arrays that contain 1 and also contain either 2 or 3.</p>
</blockquote>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">&gt; <span style="color:#00a">create</span> extension intarray;
<span style="color:#00a">CREATE</span> EXTENSION</code></pre></div>
<p>The way the
<em>intarray</em> extension works, we need to build a new table that
contains for each track the list of tags it&rsquo;s been associated with, as an
array of integers. We&rsquo;re going to use our
<em>rowid</em> identifier for that purpose,
as in the following query:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">&gt;  <span style="color:#00a">SELECT</span> tt.tid, array_agg(tags.rowid) <span style="color:#00a">as</span> tags
     <span style="color:#00a">FROM</span> tags <span style="color:#00a">JOIN</span> tid_tag tt <span style="color:#00a">ON</span> tags.rowid = tt.tag
 <span style="color:#00a">GROUP</span> <span style="color:#00a">BY</span> tt.tid
    <span style="color:#00a">LIMIT</span> <span style="color:#099">3</span>;
    
 tid |   tags    
<span style="color:#aaa;font-style:italic">-----+-----------
</span><span style="color:#aaa;font-style:italic"></span>   <span style="color:#099">1</span> | <span style="color:#f00;background-color:#faa">{</span><span style="color:#099">1</span>,<span style="color:#099">2</span><span style="color:#f00;background-color:#faa">}</span>
   <span style="color:#099">2</span> | <span style="color:#f00;background-color:#faa">{</span><span style="color:#099">3</span>,<span style="color:#099">4</span><span style="color:#f00;background-color:#faa">}</span>
   <span style="color:#099">3</span> | <span style="color:#f00;background-color:#faa">{</span><span style="color:#099">5</span>,<span style="color:#099">6</span>,<span style="color:#099">7</span>,<span style="color:#099">8</span><span style="color:#f00;background-color:#faa">}</span>
(<span style="color:#099">3</span> <span style="color:#00a">rows</span>)

Time: <span style="color:#099">942</span>.<span style="color:#099">074</span> ms</code></pre></div>
<p>So let&rsquo;s build the full table then index it:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">&gt; <span style="color:#00a">CREATE</span> <span style="color:#00a">TABLE</span> track_tags <span style="color:#00a">AS</span>
   <span style="color:#00a">SELECT</span> tt.tid, array_agg(tags.rowid) <span style="color:#00a">as</span> tags
     <span style="color:#00a">FROM</span> tags <span style="color:#00a">join</span> tid_tag tt <span style="color:#00a">on</span> tags.rowid = tt.tag
 <span style="color:#00a">GROUP</span> <span style="color:#00a">BY</span> tt.tid;
<span style="color:#00a">SELECT</span> <span style="color:#099">505216</span>
Time: <span style="color:#099">45388</span>.<span style="color:#099">424</span> ms

&gt; <span style="color:#00a">create</span> <span style="color:#00a">index</span> <span style="color:#00a">on</span> track_tags <span style="color:#00a">using</span> gin(tags gin__int_ops);
<span style="color:#00a">CREATE</span> <span style="color:#00a">INDEX</span>
Time: <span style="color:#099">18645</span>.<span style="color:#099">931</span> ms</code></pre></div>
<h1 id="searches">Searches</h1>

<p>Now
<a href="http://www.postgresql.org/">PostgreSQL</a> is ready for the real magic. Let&rsquo;s find all the tracks we
have that have been tagged as both
<em>blues</em> and
<em>rhythm and blues</em>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">&gt; <span style="color:#00a">select</span> array_agg(rowid)
    <span style="color:#00a">from</span> tags
   <span style="color:#00a">where</span> tag = <span style="color:#a50">&#39;blues&#39;</span> <span style="color:#00a">or</span> tag = <span style="color:#a50">&#39;rhythm and blues&#39;</span>;
 
 array_agg 
<span style="color:#aaa;font-style:italic">-----------
</span><span style="color:#aaa;font-style:italic"></span> <span style="color:#f00;background-color:#faa">{</span><span style="color:#099">3</span>,<span style="color:#099">739</span><span style="color:#f00;background-color:#faa">}</span>
(<span style="color:#099">1</span> <span style="color:#00a">row</span>)

Time: <span style="color:#099">0</span>.<span style="color:#099">684</span> ms</code></pre></div>
<p>Now what we want is a
<em>query_int</em> query string, which looks like
<code>'(1880&amp;179879)'</code>, so rather than just
<code>array_agg</code> we&rsquo;re going to use the
following query:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">&gt; <span style="color:#00a">select</span> format(<span style="color:#a50">&#39;(%s)&#39;</span>,
            array_to_string(array_agg(rowid), <span style="color:#a50">&#39;&amp;&#39;</span>)
         )::query_int <span style="color:#00a">as</span> query
    <span style="color:#00a">from</span> tags
   <span style="color:#00a">where</span> tag = <span style="color:#a50">&#39;blues&#39;</span> <span style="color:#00a">or</span> tag = <span style="color:#a50">&#39;rhythm and blues&#39;</span>;
  
  query  
<span style="color:#aaa;font-style:italic">---------
</span><span style="color:#aaa;font-style:italic"></span> <span style="color:#099">3</span> &amp; <span style="color:#099">739</span>
(<span style="color:#099">1</span> <span style="color:#00a">row</span>)

Time: <span style="color:#099">0</span>.<span style="color:#099">747</span> ms</code></pre></div>
<p>That query here allows us to easily inject as many tags as we want to, so
that it&rsquo;s easy to use it as a
<em>template</em> from within an application where the
user is going to provide for the tags list. The
<em>intarray</em> extension&rsquo;s
<em>query</em>
format also accepts other operators (
<em>or</em> and
<em>not</em>) as we saw before, so if you
want to expose those to your users you would need to tweak the
<em>query_int</em>
building part of the SQL.</p>

<p>Now, how many tracks have been tagged with
<strong><em>both</em></strong> the
<em>blues</em> and the
<em>rhythm and
blues</em> tags, will you ask me:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">&gt; <span style="color:#00a">with</span> t(query) <span style="color:#00a">as</span> (
       <span style="color:#00a">select</span> format(<span style="color:#a50">&#39;(%s)&#39;</span>,
                array_to_string(array_agg(rowid), <span style="color:#a50">&#39;&amp;&#39;</span>)
             )::query_int <span style="color:#00a">as</span> query
        <span style="color:#00a">from</span> tags
       <span style="color:#00a">where</span> tag = <span style="color:#a50">&#39;blues&#39;</span> <span style="color:#00a">or</span> tag = <span style="color:#a50">&#39;rhythm and blues&#39;</span>
  )
<span style="color:#00a">select</span> <span style="color:#00a">count</span>(*) <span style="color:#00a">from</span> track_tags, t
 <span style="color:#00a">where</span> tags @@ query;
 
 <span style="color:#00a">count</span> 
<span style="color:#aaa;font-style:italic">-------
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#099">2278</span>
(<span style="color:#099">1</span> <span style="color:#00a">row</span>)

Time: <span style="color:#099">8</span>.<span style="color:#099">242</span> ms</code></pre></div>
<p>Now of course you might want to fetch some track meta-data, here the only
one we have is the track
<em>hash id</em>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">&gt; <span style="color:#00a">with</span> t(query) <span style="color:#00a">as</span> (
    <span style="color:#00a">select</span> format(<span style="color:#a50">&#39;(%s)&#39;</span>,
                    array_to_string(array_agg(rowid), <span style="color:#a50">&#39;&amp;&#39;</span>)
           )::query_int <span style="color:#00a">as</span> query
      <span style="color:#00a">from</span> tags
       <span style="color:#00a">where</span> tag = <span style="color:#a50">&#39;blues&#39;</span> <span style="color:#00a">or</span> tag = <span style="color:#a50">&#39;rhythm and blues&#39;</span>
)
 <span style="color:#00a">select</span> track.tid
   <span style="color:#00a">from</span> track_tags tt <span style="color:#00a">join</span> tids track <span style="color:#00a">on</span> tt.tid = track.rowid, t
  <span style="color:#00a">where</span> tt.tags @@ t.query
  <span style="color:#00a">limit</span> <span style="color:#099">10</span>;
        tid         
<span style="color:#aaa;font-style:italic">--------------------
</span><span style="color:#aaa;font-style:italic"></span> TRCJLCC12903CBF4AE
 TRCIFOV128F92F6F4C
 TRCYUVJ128F425C8F1
 TRCNTFO128F92F6564
 TRCDRGT12903CE64BF
 TRCWAED128F42A837B
 TRCWFEM128F9320F94
 TRCQCQH128F932E707
 TRCUMTA12903CD67EE
 TRJJYUT12903CFB13B
(<span style="color:#099">10</span> <span style="color:#00a">rows</span>)

Time: <span style="color:#099">7</span>.<span style="color:#099">630</span> ms</code></pre></div>
<h1 id="conclusion">Conclusion</h1>




<div class="figure fig25 right dim-margin" >
  
    <img class="fig-img" src="/img/old/rhythm-blues-final4.320.jpg" >
  
  
</div>


<p>The usual way to handle a set of user defined tags and query against it
involves join against a reference table of tags, but then it&rsquo;s quite
complicated to express the full search query: we want tracks tagged with
both
<em>blues</em> and
<em>rhythm and blues</em> and might want then to exclude
<em>finger
picking</em>.</p>

<p>The
<a href="http://www.postgresql.org/docs/9.3/interactive/intarray.html">intarray</a> extension provides a powerful
<em>query specialized language</em> with
direct index support, so that you can build dynamic indexes searches
directly from your application.</p>

              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small"></span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/postgresql/">PostgreSQL</a>

  <a class="tag tag--primary tag--small" href="/tags/extensions/">Extensions</a>

  <a class="tag tag--primary tag--small" href="/tags/intagg/">intagg</a>

  <a class="tag tag--primary tag--small" href="/tags/yesql/">YeSQL</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  <div class="post-footer-tags">
    
    <script async id="_ck_252762" src="https://forms.convertkit.com/252762?v=6"></script>
    
  </div>
  <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/11/back-from-dublin/" data-tooltip="Back From Dublin">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml"></span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/10/an-interview-about-mariadb-and-postgresql/" data-tooltip="An Interview about MariaDB and PostgreSQL">
          
            <span class="hide-xs hide-sm text-small icon-mr"></span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2fdenormalizing-tags%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2fdenormalizing-tags%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Denormalizing%20Tags with @tapoueh: http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2fdenormalizing-tags%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#table-of-contents">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2017 Dimitri Fontaine. 
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        <div class="post-actions-wrap">
  <div class="post-footer-tags">
    
    <script async id="_ck_252762" src="https://forms.convertkit.com/252762?v=6"></script>
    
  </div>
  <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/11/back-from-dublin/" data-tooltip="Back From Dublin">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml"></span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/10/an-interview-about-mariadb-and-postgresql/" data-tooltip="An Interview about MariaDB and PostgreSQL">
          
            <span class="hide-xs hide-sm text-small icon-mr"></span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2fdenormalizing-tags%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2fdenormalizing-tags%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Denormalizing%20Tags with @tapoueh: http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2fdenormalizing-tags%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#table-of-contents">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <ul class="share-options">
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2fdenormalizing-tags%2f">
        <i class="fa fa-google-plus"></i><span></span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2fdenormalizing-tags%2f">
        <i class="fa fa-facebook-official"></i><span></span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Denormalizing%20Tags with @tapoueh: http%3a%2f%2ftapoueh.org%2fblog%2f2013%2f10%2fdenormalizing-tags%2f">
        <i class="fa fa-twitter"></i><span></span>
      </a>
    </li>
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=110" alt="" />
    
    <h4 id="about-card-name">Dimitri Fontaine</h4>
    
      <div id="about-card-bio">PostgreSQL Major Contributor</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Open Source Software Engineer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        France
      </div>
    
  </div>
</div>

    <div id="algolia-search-modal" class="modal-container">
  <div class="modal">
    <div class="modal-header">
      <span class="close-button"><i class="fa fa-close"></i></span>
      <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
        <span class="searchby-algolia-text text-color-light text-small">by</span>
        <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
      </a>
      <i class="search-icon fa fa-search"></i>
      <form id="algolia-search-form">
        <input type="text" id="algolia-search-input" name="search"
          class="form-control input--large search-input" placeholder="" />
      </form>
    </div>
    <div class="modal-body">
      <div class="no-result text-color-light text-center"></div>
      <div class="results">
        
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/12/setting-up-psql/">
                <h3 class="media-heading">Setting up psql</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Dec 12, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>PostgreSQL ships with an interactive console with the command line tool
named <a href="https://www.postgresql.org/docs/current/static/app-psql.html">psql</a>.
It can be used both for scripting and interactive usage and is moreover
quite a powerful tool. Interactive features includes <em>autocompletion</em>,
<em>readline</em> support (history searches, modern keyboard movements, etc), input
and output redirection, formatted output, and more.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/12/mastering-postgresql-a-readers-interview/">
                <h3 class="media-heading">Mastering PostgreSQL: a reader&#39;s interview</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Dec 12, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p><strong><em>Florent Fourcot</em></strong> has read <a href="http://masteringpostgresql.com">Mastering PostgreSQL in Application
Development</a> and has seen tremendous
inprovements in his production setup from reading the first chapters and
applying the book advices to his use case.</p>

<p>Here&rsquo;s an interview run with Florent where he explains the context in which
such improvements has been made!</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/12/mastering-postgresql-more-about-the-docker-image/">
                <h3 class="media-heading">Mastering PostgreSQL: more about the docker image</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Dec 12, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>The Enterprise Edition of <a href="https://masteringpostgresql.com">Mastering PostgreSQL in Application
Development</a> ships with a docker image that
hosts both a PostgreSQL server instance with a pre-loaded database, the one
that&rsquo;s used throughout the book examples, and also with a Jupyter Network
notebook that hosts SQL queries thanks to the
<a href="https://github.com/pivotal/sql_magic">sql_magic</a> plugin.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/12/queen-princesses-and-workers/">
                <h3 class="media-heading">Queen, Princesses, and Workers</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Dec 12, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>The <a href="https://postgresql.org">PostgreSQL</a> community made the explicit choice
some times ago that they would not use the infamous <em>master</em> and <em>slave</em>
terminology. Instead, the documentation introduces the concepts of <a href="https://www.postgresql.org/docs/current/static/high-availability.html">High
Availability, Load Balancing, and
Replication</a>
with the terms <em>Primary</em> and <em>Standby</em>, and the even more generic term
<em>Replica</em> is used in contexts when only the data flow is considered, rather
than the particular role of a node.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/12/scaling-python-released/">
                <h3 class="media-heading">Scaling Python released</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Dec 12, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Today I am very pleased to announce the release of the book <a href="https://scaling-python.com">Scaling
Python</a> from my good friend <a href="https://julien.danjou.info/">Julien
Danjou</a>!</p>

<p>As Julien says, <strong>Python applications can handle millions of requests.</strong>
Well, we know here that it&rsquo;s easier on them when they are using PostgreSQL
of course!</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/11/simple-data-modeling-with-a-test-data-set/">
                <h3 class="media-heading">Simple Data Modeling with a Test Data Set</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Nov 11, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>In <a href="/blog/2017/06/how-to-write-sql/">How to Write SQL</a> we saw how to write
SQL queries as separate <code>.sql</code> files, and we learnt about using query
parameters with the <em>psql</em> syntax for that (<code>:variable</code>, <code>:'variable'</code>, and
<code>:&quot;identifier&quot;</code>).</p>

<p>For writing our database model, the same tooling is all we need. An
important aspect of using <em>psql</em> is its capacity to provide immediate
feedback, and we can also have that with modeling too.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/11/the-mode-ordered-set-aggregate-function/">
                <h3 class="media-heading">The Mode Ordered-Set Aggregate Function</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Nov 11, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>In our article <a href="/blog/2017/06/exploring-a-data-set-in-sql/">Exploring a Data Set in
SQL</a> we discovered a data set
related to music: the <a href="https://github.com/lerocha/chinook-database">Chinook</a>
sample database.</p>

<p>Our discovery led us to find albums containing tracks of multiple genres,
and for the analytics we were then pursuing, we wanted to <em>clean</em> the data
set and assign a single genre per album. We did that in SQL of course, and
didn&rsquo;t actually edit the data.</p>

<p>Finding the most frequent input value in a group is a job for the <code>mode()
WITHIN GROUP (ORDER BY sort_expression)</code> Ordered-Set Aggregate Function, as
documented in the PostgreSQL page about <a href="https://www.postgresql.org/docs/current/static/functions-aggregate.html#FUNCTIONS-ORDEREDSET-TABLE">Aggregate
Functions</a>.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/11/whats-in-a-name-mastering/">
                <h3 class="media-heading">What&#39;s in a name: âMasteringâ</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Nov 11, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Now that my book <a href="https://masteringpostgresql.com">Mastering PostgreSQL in Application
Development</a> is released (and selling well,
thanks guys!), I&rsquo;ve had some questions about the title.</p>

<p>The idea is that to become good at anything, we need to practice. We
practice a lot, and it&rsquo;s even better when we are actively trying to learn,
following what&rsquo;s named <a href="https://en.wikipedia.org/wiki/Practice_(learning_method)#Deliberate_practice">deliberate
practice</a>.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/11/mastering-postgresql-in-application-development-launches/">
                <h3 class="media-heading">Mastering PostgreSQL in Application Development launches!</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Nov 11, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">Today is the day my book Mastering PostgreSQL in Application Development launches! I&rsquo;m all excited that everybody interested is now able to actually read my book!
Mastering PostgreSQL in Application Development targets application developers who want to learn SQL properly, and actually master this programming language. Most developers don&rsquo;t think of SQL as a programming language, mainly because they don&rsquo;t have full control of the execution plan of their queries.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="http://tapoueh.org/blog/2017/10/set-returning-functions-and-postgresql-10/">
                <h3 class="media-heading">Set Returning Functions and PostgreSQL 10</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Oct 10, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>PostgreSQL 10 is now available for everyone to use, and hinted by <a href="http://fetter.org">David
Fetter</a> I had to review my previous article <a href="/blog/2017/09/on-json-and-sql/">on Json and
SQL</a> to adapt to <em>Set Returning Functions</em>
changes.</p>

<p>A <em>Set Returning Function</em> is a PostgreSQL <em>Stored Procedure</em> that can be
used as a relation: from a single call it returns an entire result set, much
like a subquery or a table.</p>

<p>It used to be possible to use <em>SRF</em> in the <em>SELECT</em> clause, with dubious
(but useful at times) semantics, and also in <em>scalar</em> contexts. The
semantics have been fixed and are now much clearer, and the uses in scalar
contexts are forbidden â they were a hack and never made sense anyway.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
      </div>
    </div>
    <div class="modal-footer">
      <p class="results-count text-medium"
         data-message-zero=""
         data-message-one=""
         data-message-other="">
         251 posts found
      </p>
    </div>
  </div>
</div>
    
  
    
    <div id="cover" style="background-image:url('http://tapoueh.org/images/mayan-calendar.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="/js/script-qi9wbxp2ya2j6p7wx1i6tgavftewndznf4v0hy2gvivk1rxgc3lm7njqb6bz.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'http:\/\/tapoueh.org\/blog\/2013\/10\/denormalizing-tags\/';
          
            this.page.identifier = '\/blog\/2013\/10\/denormalizing-tags\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'tapoueh';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  



    
  </body>
</html>

