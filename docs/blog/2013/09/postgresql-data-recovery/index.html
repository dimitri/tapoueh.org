

  
    
  


  




  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.46">
    <meta name="theme" content="Tranquilpeak 0.3.1-BETA">
    <title>PostgreSQL data recovery</title>
    <meta name="author" content="Dimitri Fontaine">
    <meta name="keywords" content="">

    <link rel="icon" href="/favicon.ico">
    

    
    <meta name="description" content="The following story is only interesting to read if you like it when bad things happen, or if you don&rsquo;t have a trustworthy backup policy in place. By trustworthy I mean that each backup you take must be tested with a test recovery job. Only tested backups will prove useful when you need them. So go read our Backup and Restore documentation chapter then learn how to setup Barman for handling physical backups and Point In Time Recovery.">
    <meta property="og:description" content="The following story is only interesting to read if you like it when bad things happen, or if you don&rsquo;t have a trustworthy backup policy in place. By trustworthy I mean that each backup you take must be tested with a test recovery job. Only tested backups will prove useful when you need them. So go read our Backup and Restore documentation chapter then learn how to setup Barman for handling physical backups and Point In Time Recovery.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="PostgreSQL data recovery">
    <meta property="og:url" content="/blog/2013/09/postgresql-data-recovery/">
    <meta property="og:site_name" content="The Art of PostgreSQL">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="PostgreSQL data recovery">
    <meta name="twitter:description" content="The following story is only interesting to read if you like it when bad things happen, or if you don&rsquo;t have a trustworthy backup policy in place. By trustworthy I mean that each backup you take must be tested with a test recovery job. Only tested backups will prove useful when you need them. So go read our Backup and Restore documentation chapter then learn how to setup Barman for handling physical backups and Point In Time Recovery.">
    
      <meta name="twitter:creator" content="@tapoueh">
    
    

    
    

    
      <meta property="og:image" content="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=640">
    

    
      <meta property="og:image" content="https://tapoueh.org/img/tazzine-barman-fondogrigio.png">
    
    
      <meta property="og:image" content="https://tapoueh.org/img/tazzine-barman-fondogrigio.png">
    
    

    

    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" />
    
    
    <link rel="stylesheet" href="/css/style-jsjn0006wyhpyzivf6yceb31gvpjatbcs3qzjvlumobfnugccvobqwxnnaj8.min.css" />
    
    
      <link rel="stylesheet" href="https://tapoueh.org/css/dim.css">
    
      <link rel="stylesheet" href="https://tapoueh.org/css/nav.css">
    

    
      
<script>
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-47059482-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="navbar-collapse collapse header-title" id="navigation">
    <ul class="nav navbar-nav navbar-right">
      
      <li class="dropdown">
        
        <a style="color: black;" href="/" alt="blog"><i class="sidebar-button-icon fa fa-lg fa-home"></i></a>
        
      </li>
      
      <li class="dropdown">
        
        <a style="color: black;" href="/conf/" alt="talks"><i class="sidebar-button-icon fa fa-lg fa-microphone"></i></a>
        
      </li>
      
      <li class="dropdown">
        
        <a style="color: black;" href="https://twitter.com/tapoueh" alt="Twitter"><i class="sidebar-button-icon fa fa-lg fa-twitter"></i></a>
        
      </li>
      
      <li class="dropdown">
        
        <a style="color: black;" href="http://masteringpostgresql.com/" alt="Mastering PostgreSQL"><i class="sidebar-button-icon fa fa-lg fa-book"></i></a>
        
      </li>
      
    </ul>
  </div>

  
    
      <a class="header-right-icon "
         href="http://masteringpostgresql.com" target="_blank">
    
    
      <i class="fa fa-lg fa-book"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about">
          <img class="sidebar-profile-picture" src="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=110" alt="" />
        </a>
        <h4 class="sidebar-profile-name">Dimitri Fontaine</h4>
        
          <h5 class="sidebar-profile-bio">PostgreSQL Major Contributor</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/">
    
      <i class="sidebar-button-icon fa fa-lg fa-pagelines"></i>
      
      <span class="sidebar-button-desc">Blog</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/about/">
    
      <i class="sidebar-button-icon fa fa-lg fa-beer"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories/yesql/">
    
      <i class="sidebar-button-icon fa fa-lg fa-database"></i>
      
      <span class="sidebar-button-desc">YeSQL</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://masteringpostgresql.com" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-book"></i>
      
      <span class="sidebar-button-desc">Mastering PostgreSQL</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/dimitri" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/tapoueh" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      
  <div class="post-header-cover
              text-left
              post-header-cover--partial"
       style="background-image:url('/img/tazzine-barman-fondogrigio.png')"
       data-behavior="5">
    
  </div>


      <div id="main" data-behavior="5"
        class="hasCover
               hasCoverMetaOut
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      PostgreSQL data recovery
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2013-09-17T10:39:00&#43;02:00">
        <span style="float: left; width: 35%">
          <i class="fa fa-calendar"></i> 
  
  
  
  
    Tuesday 17 Sep 2013
  

        </span>
      </time>
    
    <span style="float: right; width: 65%">
      <i class="fa fa-clock-o"></i> 15 mins read
      
    </span>
    <span style="float: left; width: 35%">
      <i class="fa fa-bookmark"></i> 
  
  
    <span></span>
    
      <a class="category-link" href="/categories/postgresql">PostgreSQL</a>, 
    
      <a class="category-link" href="/categories/backups-and-recovery">Backups and Recovery</a>
    
  

    </span>
    <div>
      <p>
        
        
        
        
        <a href="/tags/recovery/">
          <i class="fa fa-tag"></i> Recovery
        </a>
        
        
        
        <a href="/tags/backups/">
          <i class="fa fa-tag"></i> Backups
        </a>
        
        
      </p>
    </div>
  </div>


</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              

<p>The following story is only interesting to read if you like it when bad
things happen, or if you don&rsquo;t have a trustworthy backup policy in place. By
trustworthy I mean that
<em>each backup</em> you take
<strong>must</strong> be tested with a test
recovery job. Only tested backups will prove useful when you need them. So
go read our
<a href="http://www.postgresql.org/docs/current/interactive/backup.html">Backup and Restore</a> documentation chapter then learn how to setup
<a href="http://www.pgbarman.org/">Barman</a> for handling
<em>physical backups</em> and
<a href="http://www.postgresql.org/docs/current/interactive/continuous-archiving.html">Point In Time Recovery</a>. Get back
when you have proper backups, including recovery testing in place. We are
waiting for you. Back? Ok, let&rsquo;s see how bad you can end up without backups,
and how to still recover. With luck.</p>

<p><center>
<div class="figure dim-margin">
  <a href="http://www.pgbarman.org/">
    <img src="/img/old/pgbarman.png">
  </a>
</div>
</center></p>

<p><center><em>Set a trustworthy backup solution, and review your policy</em></center></p>

<p>Did I mention that a
<em>trustworthy</em> backup solution includes automated testing
of your ability to recover from any and all backup you&rsquo;ve been taking? That
might be more important than you think.</p>

<blockquote>
<p>This article is going to be quite long. Prepare yourself a cup of your
favorite beaverage.</p>
</blockquote>

<h2 id="the-setup">The Setup</h2>

<p>Most of the customers I visit have already laid out a
<em>backup strategy</em> and
implemented it. Most of them did implement it with custom in-house scripts.
They hire high-skilled engineers who have been doing system administration
for more than a decade, and who are more than able to throw a
<em>shell script</em>
at the problem.</p>

<p><em>Shell scripting</em> must in hindsight be one of the most difficult things to do
right, given how many times it turns around doing something else entirely
than what the program author though it would. If you want another one of my
quite bulk advices, stop doing any
<em>shell scripting</em> today: a
<em>shell</em> is a nice
<em>interactive</em> tool, if you are doing non-interactive scripting, that&rsquo;s
actually called system programming and you deserve a better tool than that.</p>

<p><center>


 
  
  
  
  
    
      
    
  
    
  
    
      
    
  

<div class="figure fig50 dim-margin" >
  
    <a class="fancybox" href="/img/old/a-shell-scripting-story.png" data-fancybox-group="">
  
    <img class="fig-img" src="/img/old/a-shell-scripting-story.png" >
  
    </a>
  
  
</div>

</center></p>

<p><center><em>My take: shell script makes it harder to write production quality code.</em></center></p>

<p>In our very case, the customer did realize that a
<em>production</em> setup had been
approved and was running live
<em>before</em> any backup solution was in place. Think
about it for a minute. If you don&rsquo;t have
<strong><em>tested</em></strong> backups in place, it&rsquo;s not
production ready.</p>

<p>Well, the incident was taken seriously, and the usual backup
<em>scripts</em>
deployed as soon as possible. Of course, the shell scripts depended in
non-obvious ways on some parameters (environment variables, database
connections, database setup with special configuration tables and rows). And
being a
<em>shell script</em>, not much verification that the setup was complete had
been implemented, you see.</p>

<h2 id="the-horror-story">The Horror Story</h2>

<p>And guess what the first thing that
<em>backup</em> script is doing? Of course,
making sure enough place is available on the file system to handle the next
backup. That&rsquo;s usually done by applying a
<em>retention policy</em> and first
removing backups that are
<em>too old</em> given said policy. And this script too did
exactly that.</p>

<p>The problem is that, as some of you already guessed (yes, I see those smiles
trying to hide brains thinking as fast as possible to decide if the same
thing could happen to you too), well, the script configuration had not been
done before entering production. So the script ran without setup, and
without much checking, began making bytes available. By removing any file
more than 5 days old. Right. In.
<code>$PGDATA</code>.</p>

<h2 id="but-recently-modified-are-still-there-right">But recently modified are still there, right?</h2>

<p>Exactly, not all the files of the database system had been removed. Surely
something can be done to recover data from a very small number of important
tables? Let&rsquo;s now switch to the present tense and see about it.</p>

<p><center>


 
  
  
  
  
    
      
    
  
    
  
    
      
    
  

<div class="figure fig50 dim-margin" >
  
    <a class="fancybox" href="/img/old/data_loss.gif" data-fancybox-group="">
  
    <img class="fig-img" src="/img/old/data_loss.gif" >
  
    </a>
  
  
</div>

</center></p>

<p><center>*Can you spell <strong><em>data loss</em></strong>?*</center></p>

<p>Remember, there&rsquo;s no
<em>backups</em>. The
<code>archive_command</code> is set though, so that&rsquo;s a
first track to consider. After that, what we can do is try to start
PostgreSQL on a copy of the remaining
<code>$PGDATA</code> and massage it until it allows
us to
<code>COPY</code> the data out.</p>

<h2 id="the-desperate-pitr">The desperate PITR</h2>

<p>The
<em>WAL Archive</em> is starting at the file
<code>000000010000000000000009</code>, which
makes it unusable without a corresponding
<em>base backup</em>, which we don&rsquo;t have.
Well, unless maybe if we tweak the system. We need to first edit the system
identifier, then reset the system to only begin replaying at the file we do
have. With some luck&hellip;</p>

<p><center>


 
  
  
  
  
    
      
    
  
    
  
    
      
    
  

<div class="figure fig50 dim-margin" >
  
    <a class="fancybox" href="/img/old/a-broken-clock-is-right-twice-a-day-michael-flood.640.jpg" data-fancybox-group="">
  
    <img class="fig-img" src="/img/old/a-broken-clock-is-right-twice-a-day-michael-flood.640.jpg" >
  
    </a>
  
  
</div>

</center></p>

<p><center><em>A broken clock is still right twice a day, a broken backup never is&hellip;</em></center></p>

<p>Time to try our luck here:</p>

<pre><code>$ export PGDATA=/some/place
$ initdb
$ hexedit $PGDATA/global/pg_control
$ pg_controldata
$ xlogdump /archives/000000010000000000000009
$ pg_resetxlog -f -l 1,9,19 -x 2126 -o 16667 $PGDATA
$ cat &gt; $PGDATA/recovery.conf &lt;&lt;EOF
restore_command = 'gunzip -c /archives/%f.gz &gt; &quot;%p&quot;'
EOF
$ pg_ctl start
</code></pre>

<p>Using the transaction data we get from reading the first archive log file we
have with
<a href="https://github.com/snaga/xlogdump">xlogdump</a> then using
<a href="http://www.postgresql.org/docs/current/static/app-pgresetxlog.html">pg_resetxlog</a> and thus accepting to maybe lose
some more data, we still can&rsquo;t start the system in
<em>archive recovery</em> mode,
because the
<em>system identifier</em> is not the same in the WAL files and in the
system&rsquo;s
<code>pg_controldata</code> output.</p>

<p>So we tweak our fresh cluster to match, by changing the first 8 bytes of the
control file, paying attention to the byte order here. As I already had a
Common Lisp
<em>REPL</em> open on my laptop, the easier for me to switch from decimal
representation of the
<em>database system identifier</em> was so:</p>

<pre><code>(format nil &quot;~,,' ,2:x&quot; 5923145491842547187)
&quot;52 33 3D 71 52 3B 3D F3&quot;
</code></pre>

<p>Paying attention to the byte order means that you need to edit the control
file&rsquo;s first 8 bytes in reverse:
<code>F3 3D 3B 52 71 3D 33 52</code>. But in our case,
no massaging seems to allow PostgreSQL to read from the archives we have.</p>

<p>On to massaging what is remaining in the old cluster then.</p>

<h2 id="the-promotion">The Promotion</h2>

<p>I&rsquo;m usually not doing promotion in such a prominent way, but I clearly
solved the situation thanks to my colleagues from the <sup>24</sup>&frasl;<sub>7</sub> support at
2ndQuadrant, with a special mention to
<strong><em>Andres Freund</em></strong> for inspiration and
tricks:</p>

<p><center>
<div class="figure dim-margin">
  <a href="http://2ndquadrant.com/">
    <img src="/img/old/2ndQuadrant-logo.640.jpg">
  </a>
</div>
</center></p>

<p><center><em>We also know how to recover your data, but we first insist in proper backups</em></center></p>

<p>Oh, did I mention about proper backups and how you need to have been
successfully testing them before you can call a service
<em>in production</em> or
have any hope about your recovery abilities? I wasn&rsquo;t sure I did&hellip;</p>

<h2 id="playing-fast-and-loose-with-postgresql">Playing fast and loose with PostgreSQL</h2>

<p>The damaged cluster is not starting, for lack of important meta-data kind-of
files. First thing missing is
<code>pg_filenode.map</code> in the
<code>global</code> directory. Using
<code>xlogdump</code> it should be possible to recover just this file if it&rsquo;s been
changed in the WAL archives we have, but that&rsquo;s not the case.</p>

<p><center>


 
  
  
  
  
    
      
    
  
    
  
    
      
    
  

<div class="figure fig50 dim-margin" >
  
    <a class="fancybox" href="/img/old/damage-case-bloat.640.jpg" data-fancybox-group="">
  
    <img class="fig-img" src="/img/old/damage-case-bloat.640.jpg" >
  
    </a>
  
  
</div>

</center></p>

<p><center><em>Trying to salvage a damage case</em></center></p>

<h3 id="pg-filenode-map">pg_filenode.map</h3>

<p>As this file is only used for shared relations and some bootstraping
situation (you can&rsquo;t read current
<code>pg_class</code> file node from
<code>pg_class</code>, as the
file mapping is the information you need to know which file to read), and
knowing that the version on disk was older than 5 days on a cluster recently
put into production, we can allow ourselves trying something: copy the
<code>pg_filenode.map</code> from another fresh cluster.</p>

<p>My understanding is that this file only changes when doing heavy maintenance
on system tables, like
<code>CLUSTER</code> or
<code>VACUUM FULL</code>, which apparently didn&rsquo;t get
done here.</p>

<p>By the way, here&rsquo;s one of those tricks I learnt in this exercise. You can
read the second and fourth columns as filenames in the same directory:</p>

<pre><code>od -j 8 -N $((512-8-8)) -td4 &lt; $PGDATA/global/pg_filenode.map
</code></pre>

<p>So copying default
<code>pg_filenode.map</code> allowed us to pass that error and get to
the next.</p>

<h3 id="pg-clog">pg_clog</h3>

<p>Next is the lack of some
<code>pg_clog</code> files. That&rsquo;s a little tricky because those
binary files contain the
<code>commit log</code> information and are used to quickly
decide if recent transactions are still in flight, or committed already, or
have been rolled back. We can easily trick the system and declare that all
transaction older than 5 days (remember the bug in the
<em>cleanup</em> script was
about that, right?) have in fact been
<em>committed</em>. A commit in the
<code>CLOG</code> is a
<code>01</code> value, and in a single byte we can stuff as many as 4 transactions&rsquo;
status.</p>

<p>Here&rsquo;s how to create those file from scratch, once you&rsquo;ve noticed that
<code>01010101</code> is in fact the ascii code for the letter
<code>U</code>.</p>

<pre><code>(code-char #b01010101)
#\U
</code></pre>

<p>So to create a series of clog file where all transactions have been
committed, so that we can see the data, we can use the following command
line:</p>

<pre><code>for c in 0000 0001 0002 0003 0004 0005 0006 0007 0008 0009 000A 000B 000C
do
    dd if=/dev/zero bs=256k count=1 | tr '\0' 'U' &gt; $c
done
</code></pre>

<p><center>


 
  
  
  
  
    
      
    
  
    
  
    
      
    
  

<div class="figure fig50 dim-margin" >
  
    <a class="fancybox" href="/img/old/LRN-LNP-database.png" data-fancybox-group="">
  
    <img class="fig-img" src="/img/old/LRN-LNP-database.png" >
  
    </a>
  
  
</div>

</center></p>

<h3 id="pg-database">pg_database</h3>

<p>The next step we are confronted to is that PostgreSQL has lost its baking
files for the
<code>pg_database</code> relation and has no idea what are those
directories in
<code>$PGDATA/base</code> supposed to be all about. We only have the
numbers!</p>

<p>That said, the customer still had an history of the commands used to install
the database server, so knew in which order the databases where created. So
we had an OID to name mapping. How to apply it?</p>

<p>Well
<code>pg_database</code> is a shared catalog and the underlying file apparently
isn&rsquo;t that easy to hack around, so the easiest solution is to actually hack
the
<code>CREATE DATABASE</code> command and have it accepts a
<code>WITH OIDS</code> option (
<code>OIDS</code> is
already a PostgreSQL keyword,
<code>OID</code> is not, and we&rsquo;re not going to introduce
new keywords just for that particular patch).</p>

<p>Equiped with that
<strong><em>hacked version of PostgreSQL</em></strong> it&rsquo;s then possible to use
the new command and create the databases we need with the
<code>OIDS</code> we know.</p>

<p>Those
<code>OIDS</code> are then to be found on-disk in the file where
<code>pg_database</code> is
internally stored, and we can ask the system where that file is:</p>

<pre><code>select oid, relname, pg_relation_filenode(oid)
  from pg_class
 where relname = 'pg_database';
 oid  |   relname   | pg_relation_filenode 
------+-------------+----------------------
 1262 | pg_database |                12319
(1 row)
</code></pre>

<p>Then without surprise we can see:</p>

<pre><code>$ strings $PGDATA/global/12319
postgres
template0
template1
</code></pre>

<p>Once that file is copied over to the (running, as it happened) damaged
cluster, it&rsquo;s then possible to actually open a connection to a database. And
that&rsquo;s pretty impressive. But suddenly it didn&rsquo;t work anymore&hellip;</p>

<h3 id="sytem-indexes">Sytem Indexes</h3>

<p>This problem was fun to diagnose. The first
<code>psql</code> call would be fine, but the
second one would always complain with an error you might have never seen in
the field. I sure didn&rsquo;t before.</p>

<pre><code>FATAL:  database &quot;dbname&quot; does not exists
DETAIL:  Database OID 17838 now seems to belong to &quot;otherdbname&quot;
</code></pre>

<p>Part of PostgreSQL startup is building up some caches, and for that it&rsquo;s
using indexes. And we might have made a mistake, or the index is corrupted,
but apparently there&rsquo;s a mismatch somewhere.</p>

<p>But your now all-time favourite development team knew that would happen to
you and is very careful that any feature included in the software is able to
bootstrap itself without using any indexes. Or that in bad situations the
system knows how to resist the lack of those indexes by turning the feature
off, which is the case for
<a href="http://www.postgresql.org/docs/9.3/interactive/event-triggers.html">Event Triggers</a> for example, as you can see in the
commit
<a href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=cd3413ec3683918c9cb9cfb39ae5b2c32f231e8b">cd3413ec3683918c9cb9cfb39ae5b2c32f231e8b</a>.</p>

<p><center>


 
  
  
  
  
    
      
    
  
    
  
    
      
    
  

<div class="figure fig50 dim-margin" >
  
    <a class="fancybox" href="/img/old/indexing-system.jpg" data-fancybox-group="">
  
    <img class="fig-img" src="/img/old/indexing-system.jpg" >
  
    </a>
  
  
</div>

</center></p>

<p><center><em>Another kind of indexing system</em></center></p>

<p>So yes, it is indeed possible to start
<a href="http://www.postgresql.org/">PostgreSQL</a> and have that marvellous
<strong><em>production ready</em></strong> system avoid any system indexes, for dealing with cases
where you have reasons to think those are corrupted&hellip; or plain missing.</p>

<pre><code>$ pg_ctl start -o &quot;-P&quot;
$ cat &gt; $PGDATA/postgresql.conf &lt;&lt;EOF
	enable_indexscan = off
	enable_bitmapscan = off
	enable_indexonlyscan = off
EOF
$ pg_ctl reload
</code></pre>

<p>While at it, we edit the
<code>postgresq.conf</code> and adjust some index usage related
settings, as you can see, because this problem will certain happen outside
of the system indexes.</p>

<blockquote>
<p>If you&rsquo;re not using (only) PostgreSQL as your database system of choice, now
is the time to check that you can actually start those other systems when
their internal indexes are corrupted or missing, by the way. I think that
tells a lot about the readiness of the system for production usage, and the
attitude of the developpers towards what happens in</p>
</blockquote>

<p>So we now have a running PostgreSQL service, servicing the data that still
is available. Well, not quite, We have a PostgreSQL service that accepts to
start and allows connections to a specific database.</p>

<h3 id="pg-proc-pg-operator-pg-cast-pg-aggregate-pg-amop-and-others">pg_proc, pg_operator, pg_cast, pg_aggregate, pg_amop and others</h3>

<p>The first query I did try on the new database was against
<code>pg_class</code> to get
details about the available tables. The
<code>psql</code> command line tool is doing a
large number of queries in order to serve the
<code>\d</code> output, the
<code>\dt</code> one is
usable in our case.</p>

<p>To know what queries are sent to the server by
<a href="http://www.postgresql.org/docs/current/interactive/app-psql.html">psql</a> commands use the
<code>\set
ECHO_HIDDEN</code> toggle.</p>

<p>About any query is now complaining that the target database is missing
files. To understand which file it is, I used the following query in a fresh
cluster. The following example is about an error message where
<code>base/16384/12062</code> is missing:</p>

<pre><code>select oid, relname, pg_relation_filenode(oid)
  from pg_class
 where pg_relation_filenode(oid) = 12062;
 oid  | relname | pg_relation_filenode 
------+---------+----------------------
 1255 | pg_proc |                12062
(1 row)
</code></pre>

<p>In our specific case, no extensions were used. Check that before taking
action here, or at least make sure that the tables you want to try and
recover data from are not using extensions, that would make things so much
more complex.</p>

<p>Here we can just use default settings for most of the system catalogs: we
are using the same set of
<em>functions</em>,
<em>operators</em>,
<em>casts</em>,
<em>aggregates</em> etc as any
other 9.2 system, so we can directly use files created by
<a href="http://www.postgresql.org/docs/current/interactive/app-initdb.html">initdb</a> and copy
them over where the error message leads.</p>

<p><center>


 
  
  
  
  
    
      
    
  
    
  
    
      
    
  

<div class="figure fig50 dim-margin" >
  
    <a class="fancybox" href="/img/old/namespace1.png" data-fancybox-group="">
  
    <img class="fig-img" src="/img/old/namespace1.png" >
  
    </a>
  
  
</div>

</center></p>

<h3 id="pg-namespace">pg_namespace</h3>

<p>Some error messages are about things we should definitely not ignore. The
content of the
<code>pg_namespace</code> relation was lost on about all our databases,
and the application here were using non default schema.</p>

<p>To recover from that situation, we need to better understand how this
relation is actually stored:</p>

<pre><code># select oid, * from pg_namespace;
  oid  |      nspname       | nspowner |        nspacl        
-------+--------------------+----------+----------------------
    99 | pg_toast           |       10 | 
 11222 | pg_temp_1          |       10 | 
 11223 | pg_toast_temp_1    |       10 | 
    11 | pg_catalog         |       10 | {dim=UC/dim,=U/dim}
  2200 | public             |       10 | {dim=UC/dim,=UC/dim}
 11755 | information_schema |       10 | {dim=UC/dim,=U/dim}
(6 rows)

# copy pg_namespace to stdout with oids;
99	pg_toast	10	\N
11222	pg_temp_1	10	\N
11223	pg_toast_temp_1	10	\N
11	pg_catalog	10	{dim=UC/dim,=U/dim}
2200	public	10	{dim=UC/dim,=UC/dim}
11755	information_schema	10	{dim=UC/dim,=U/dim}
</code></pre>

<p><center>


 
  
  
  
  
    
      
    
  
    
  
    
      
    
  

<div class="figure fig50 dim-margin" >
  
    <a class="fancybox" href="/img/old/data_factory.jpg" data-fancybox-group="">
  
    <img class="fig-img" src="/img/old/data_factory.jpg" >
  
    </a>
  
  
</div>

</center></p>

<p>So it&rsquo;s pretty easy here, actually, when you make the right connections:
let&rsquo;s import a default
<code>pg_namespace</code> file then append to it thanks to
<code>COPY
IN</code>, being quite careful about using
<code>tabs</code> (well, unless you use the
<code>delimiter</code>
option of course):</p>

<pre><code># copy pg_namespace from stdin with oids;
Enter data to be copied followed by a newline.
End with a backslash and a period on a line by itself.
&gt;&gt; 16443	my_namespace	10	\N
&gt;&gt; \.
</code></pre>

<p>And now there&rsquo;s a new
<em>schema</em> in there with the
<code>OID</code> we want. Wait, how do we
figure out the OID we need?</p>

<pre><code># select c.oid, relname, relnamespace, nspname
    from pg_class c left join pg_namespace n on n.oid = c.relnamespace
   where relname = 'bar';
  oid  | relname | relnamespace | nspname 
-------+---------+--------------+---------
 16446 | bar     |        16443 | 
(1 row)
</code></pre>

<p>So in the result of that query we have no
<code>nspname</code>, but we happen to know
that the table
<code>bar</code> is supposed to be in the schema
<code>my_namespace</code>.</p>

<p>And believe it or not, that method actually allows you to create a schema in
a database in a running cluster. We directly are editing the catalog files
and editing even the
<code>OID</code> of the rows we are injecting.</p>

<p>The reason we couldn&rsquo;t do that with
<code>pg_database</code>, if you&rsquo;re wondering about
that, is that
<code>pg_database</code> is a shared catalog and part of the bootstrapping,
so that it was impossible to start PostgreSQL until we fix it, and the only
implementation of
<a href="http://www.postgresql.org/docs/current/interactive/sql-copy.html">COPY</a> we have requires a running PostgreSQL instance.</p>

<h3 id="pg-attributes-and-pg-attrdef">pg_attributes and pg_attrdef</h3>

<p>So now we are able to actually refer to the right relation in a SQL command,
we should be able to dump its content right? Well, it so happens that in
some case it&rsquo;s ok and in some cases it&rsquo;s not.</p>

<p>We are very lucky in that exercise in that
<code>pg_attribute</code> is not missing. We
might have been able to rebuild it thanks to some
<code>pg_upgrade</code> implementation
detail by forcing the
<code>OID</code> of the next table to be created and then issuing
the right command, as given by
<a href="http://www.postgresql.org/docs/current/interactive/app-pgdump.html">pg_dump</a>. By the way, did I mention about
backups? and automated recovery tests?</p>

<p><center>


 
  
  
  
  
    
      
    
  
    
  
    
      
    
  

<div class="figure fig50 dim-margin" >
  
    <a class="fancybox" href="/img/old/relation-attributes.jpg" data-fancybox-group="">
  
    <img class="fig-img" src="/img/old/relation-attributes.jpg" >
  
    </a>
  
  
</div>

</center></p>

<p><center><em>We need the data attributes</em></center></p>

<p>In some cases though, we are missing the
<code>pg_attrdef</code> relation, wholesale.
That relation is used for default expressions attached to columns, as we can
see in the following example, taken on a working database server:</p>

<pre><code># \d a
                         Table &quot;public.a&quot;
 Column |  Type   |                   Modifiers                    
--------+---------+------------------------------------------------
 id     | integer | not null default nextval('a_id_seq'::regclass)
 f1     | text    | 
Indexes:
    &quot;a_pkey&quot; PRIMARY KEY, btree (id)

#  select adrelid, adnum, adsrc
     from pg_attrdef
    where adrelid = 'public.a'::regclass;
 adrelid | adnum |             adsrc             
---------+-------+-------------------------------
   16411 |     1 | nextval('a_id_seq'::regclass)
(1 row)

# select attnum, atthasdef
    from pg_attribute
   where     attrelid = 'public.a'::regclass
         and atthasdef;
 attnum | atthasdef 
--------+-----------
      1 | t
(1 row)
</code></pre>

<p>We need to remember that the goal here is to salvage some data out of an
installation where lots is missing, it&rsquo;s not at all about being able to ever
use that system again. Given that, what we can do here is just ignore the
default expression of the columns, by directly updating the catalogs:</p>

<pre><code># update pg_attribute
     set atthasdef = false
   where attrelid = 'my_namespace.bar';
</code></pre>

<h3 id="copy-the-data-out-now">COPY the data out! now!</h3>

<p>At this point we are now able to actually run the
<code>COPY</code> command to store the
interesting data into a plain file, that is going to be usable on another
system for analysis.</p>

<p>Not every relation from the get go, mind you, sometime some
<em>default</em> catalogs
are still missing, but in that instance of the data recovery we were able to
replace all the missing pieces of the puzzle by just copying the underlying
files as we did in the previous section.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Really,
<a href="http://www.postgresql.org/">PostgreSQL</a> once again surprises me by its flexibility and
resilience. After having tried quite hard to kill it dead, it was still
possible to actually rebuild the
<em>cluster</em> into shape piecemeal and get the
interesting data back.</p>

<p><center>


 
  
  
  
  
    
      
    
  
    
  
    
      
    
  

<div class="figure fig50 dim-margin" >
  
    <a class="fancybox" href="/img/old/resilience_logo.jpg" data-fancybox-group="">
  
    <img class="fig-img" src="/img/old/resilience_logo.jpg" >
  
    </a>
  
  
</div>

</center></p>

<p>I should mention, maybe, that with a proper
<em>production setup</em> including a
<a href="http://www.postgresql.org/docs/current/interactive/continuous-archiving.html">Continuous Archiving and Point-in-Time Recovery</a> solution such as
<a href="http://www.pgbarman.org/">pgbarman</a>,
<a href="http://skytools.projects.pgfoundry.org/doc/walmgr.html">walmgr</a>,
<a href="https://github.com/omniti-labs/omnipitr">OmniPITR</a> or
<a href="https://public.commandprompt.com/projects/pitrtools/wiki">PITRtools</a>; the recovery would have been really simple.</p>

<blockquote>
<p>Using an already made solution is often better because they don&rsquo;t just
include</p>
</blockquote>

<p>It&rsquo;s even one of those rare cases where using
<a href="http://www.postgresql.org/docs/current/interactive/high-availability.html">PostgreSQL replication</a> would
have been a solution: the removing of the files did happen without
PostgreSQL involved, it didn&rsquo;t know that was happening and wouldn&rsquo;t have
replicated that to the standby.</p>

              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small"></span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/postgresql/">PostgreSQL</a>

  <a class="tag tag--primary tag--small" href="/tags/recovery/">Recovery</a>

  <a class="tag tag--primary tag--small" href="/tags/backups/">Backups</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  <div class="post-footer-tags">
    
    
    <script async id="_ck_218061" src="https://forms.convertkit.com/218061?v=6"></script>
    
    
  </div>
  <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/09/open-world-forum-2013/" data-tooltip="Open World Forum 2013">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml"></span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/09/using-trigrams-against-typos/" data-tooltip="Using trigrams against typos">
          
            <span class="hide-xs hide-sm text-small icon-mr"></span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https%3a%2f%2ftapoueh.org%2fblog%2f2013%2f09%2fpostgresql-data-recovery%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftapoueh.org%2fblog%2f2013%2f09%2fpostgresql-data-recovery%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=PostgreSQL%20data%20recovery with @tapoueh: https%3a%2f%2ftapoueh.org%2fblog%2f2013%2f09%2fpostgresql-data-recovery%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2018 Dimitri Fontaine. 
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        <div class="post-actions-wrap">
  <div class="post-footer-tags">
    
    
    <script async id="_ck_218061" src="https://forms.convertkit.com/218061?v=6"></script>
    
    
  </div>
  <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/09/open-world-forum-2013/" data-tooltip="Open World Forum 2013">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml"></span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2013/09/using-trigrams-against-typos/" data-tooltip="Using trigrams against typos">
          
            <span class="hide-xs hide-sm text-small icon-mr"></span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https%3a%2f%2ftapoueh.org%2fblog%2f2013%2f09%2fpostgresql-data-recovery%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftapoueh.org%2fblog%2f2013%2f09%2fpostgresql-data-recovery%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=PostgreSQL%20data%20recovery with @tapoueh: https%3a%2f%2ftapoueh.org%2fblog%2f2013%2f09%2fpostgresql-data-recovery%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <ul class="share-options">
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https%3a%2f%2ftapoueh.org%2fblog%2f2013%2f09%2fpostgresql-data-recovery%2f">
        <i class="fa fa-google-plus"></i><span></span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftapoueh.org%2fblog%2f2013%2f09%2fpostgresql-data-recovery%2f">
        <i class="fa fa-facebook-official"></i><span></span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=PostgreSQL%20data%20recovery with @tapoueh: https%3a%2f%2ftapoueh.org%2fblog%2f2013%2f09%2fpostgresql-data-recovery%2f">
        <i class="fa fa-twitter"></i><span></span>
      </a>
    </li>
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=110" alt="" />
    
    <h4 id="about-card-name">Dimitri Fontaine</h4>
    
      <div id="about-card-bio">PostgreSQL Major Contributor</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Open Source Software Engineer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        France
      </div>
    
  </div>
</div>

    <div id="algolia-search-modal" class="modal-container">
  <div class="modal">
    <div class="modal-header">
      <span class="close-button"><i class="fa fa-close"></i></span>
      <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
        <span class="searchby-algolia-text text-color-light text-small">by</span>
        <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
      </a>
      <i class="search-icon fa fa-search"></i>
      <form id="algolia-search-form">
        <input type="text" id="algolia-search-input" name="search"
          class="form-control input--large search-input" placeholder="" />
      </form>
    </div>
    <div class="modal-body">
      <div class="no-result text-color-light text-center"></div>
      <div class="results">
        
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/08/postgresql-concurrency-an-article-series/">
                <h3 class="media-heading">PostgreSQL Concurrency: an Article Series</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Aug 8, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p><a href="https://www.postgresql.org">PostgreSQL</a> is a relational database management
system. It&rsquo;s even the world&rsquo;s most advanced open source one of them. As
such, as its core, Postgres solves concurrent access to a set of data and
maintains consistency while allowing concurrent operations.</p>

<p>In the <a href="/tags/concurrency/">PostgreSQL Concurrency</a> series of articles here
we did see several aspects of how to handle concurrent use cases of your
application design with PostgreSQL. The main thing to remember is that a
Database Management System first task is to handle concurrency access to the
data for you.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/08/scheduled-data-processing-how-to-use-cron/">
                <h3 class="media-heading">Scheduled Data Processing: How to use cron?</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Aug 8, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>A previous article in the <a href="/tags/concurrency">PostgreSQL Concurrency</a> series
covered how to manage concurrent retweets in an efficient way: in <a href="/blog/2018/07/computing-and-caching/">Computing
and Caching</a>, we learnt how to
maintain a cache right in your PostgreSQL database, using MATERIALIZED
VIEWS. We also had a look at how to take care of <a href="/blog/2018/07/batch-updates-and-concurrency/">Batch Updates and
Concurrency</a>.</p>

<p>While in the first case we are providing a solution to a technical problem
where we want to solve performance issues while keeping the same semantics,
in the second case we are actually implementing a part of the application&rsquo;s
<a href="/blog/2017/06/sql-and-business-logic/">Business Logic</a> as a scheduled job.</p>

<p>Today&rsquo;s article shows a modern technique to handle the scheduling of those
business oriented activities that are not tied to any user activity. When
thinking about it this way, you certainly don&rsquo;t want to implement the
backbone of your business logic in a <em>shell script</em> that&rsquo;s directly
maintained in the production environment, do you?</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/07/batch-updates-and-concurrency/">
                <h3 class="media-heading">Batch Updates and Concurrency</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>This article fits in the <a href="/tags/concurrency">PostgreSQL Concurrency</a> series,
where we installed a tweeter like application schema and had all the
characters from Shakespeare&rsquo;s <em>A Midsummer Night&rsquo;s Dream</em> tweet their own
lines in our database in <a href="/blog/2018/06/PostgreSQL-DML.md">PostgreSQL Concurrency: Data Modification
Language</a>.</p>

<p>A previous article in the series covered how to manage concurrent retweets
in an efficient way: <a href="/blog/2018/07/computing-and-caching/">Computing and
Caching</a>, where we learn how to
maintain a cache right in your PostgreSQL database, thanks for materialized
views. We even went as far as maintaining an <em>external</em> cache in another
application layer using PostgreSQL
<a href="https://www.postgresql.org/docs/current/static/sql-listen.html">LISTEN</a> and
<a href="https://www.postgresql.org/docs/current/static/sql-notify.html">NOTIFY</a>
features and a Golang application.</p>

<p>Today&rsquo;s article is going to address concurrency in the context of updating
data in a batch. This activity is quite common, as soon as your system is
connected to other systems either internally or with external providers.
While it&rsquo;s pretty easy to ingest new data, and easy enough to update data
from an external source when nothing happens in your database, doing the
operation safely with concurrent activity is more complex. Once more though,
PostgreSQL comes with all the tooling you need to handle that situation.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/07/postgresql-listen/notify/">
                <h3 class="media-heading">PostgreSQL LISTEN/NOTIFY</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>This article fits in the <a href="/tags/concurrency">PostgreSQL Concurrency</a> series,
where we installed a tweeter like application schema and had all the
characters from Shakespeare&rsquo;s <em>A Midsummer Night&rsquo;s Dream</em> tweet their own
lines in our database in <a href="/blog/2018/06/PostgreSQL-DML.md">PostgreSQL Concurrency: Data Modification
Language</a>.</p>

<p>A previous article in the series covered how to manage concurrent retweets
in an efficient way: <a href="/blog/2018/07/computing-and-caching/">Computing and
Caching</a>, where we learn how to
maintain a cache right in your PostgreSQL database, thanks for materialized
views.</p>

<p>Today&rsquo;s article shows how to maintain an <em>external</em> cache in another
application layer. In this article we are going to maintain an in-memory
cache in a Golang service, using PostgreSQL
<a href="https://www.postgresql.org/docs/current/static/sql-listen.html">LISTEN</a> and
<a href="https://www.postgresql.org/docs/current/static/sql-notify.html">NOTIFY</a>
features.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/07/postgresql-event-based-processing/">
                <h3 class="media-heading">PostgreSQL Event Based Processing</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>In the previous article of the series <a href="/blog/2018/07/modeling-for-concurrency/">Modeling for
Concurrency</a>, we saw how to model
your application for highly concurrent activity. It was a follow-up to the
article entitled <a href="/blog/2018/07/postgresql-concurrency-isolation-and-locking/">PostgreSQL Concurrency: Isolation and
Locking</a>, which
was a primer on PostgreSQL isolation and locking properties and behaviors.</p>

<p>Today&rsquo;s article takes us a step further and builds on what we did in the
previous articles in our series. After having had all the characters from
Shakespeare&rsquo;s <em>A Midsummer Night&rsquo;s Dream</em> tweet their own lines in our
database in <a href="/blog/2018/06/PostgreSQL-DML.md">PostgreSQL Concurrency: Data Modification
Language</a>, and having had them like and
retweet a lot in <a href="/blog/2018/07/postgresql-concurrency-isolation-and-locking/">PostgreSQL Concurrency: Isolation and
Locking</a>, we
saw how to manage concurrent retweets in an efficient way in <a href="/blog/2018/07/computing-and-caching/">Computing and
Caching</a>.</p>

<p>What we did implement in the previous article is a <em>cache</em> system, all with
its necessary <strong>cache invalidation policy</strong>. Sometimes though, the
processing of an <em>event</em> needs to happen within the same transaction where
the event is registered in your system. PostgreSQL makes it possible to
maintain a summary table transactionally thanks to its
<a href="https://www.postgresql.org/docs/current/static/sql-createtrigger.html">trigger</a>
support. Today, we&rsquo;re going to dive in how to maintain a summary table with
triggers, and its impact on concurrency.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/07/computing-and-caching/">
                <h3 class="media-heading">Computing and Caching</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Let&rsquo;s continue to dive in PostgreSQL Concurrency. In the previous article of
the series, <a href="/blog/2018/07/modeling-for-concurrency/">Modeling for
Concurrency</a>, we saw how to model
your application for highly concurrent activity. It was a follow-up to the
article entitled <a href="/blog/2018/07/postgresql-concurrency-isolation-and-locking/">PostgreSQL Concurrency: Isolation and
Locking</a>, which
was a primer on PostgreSQL isolation and locking properties and behaviors.</p>

<p>Today&rsquo;s article takes us a step further and builds on what we did in the
previous articles in our series. After having had all the characters from
Shakespeare&rsquo;s <em>A Midsummer Night&rsquo;s Dream</em> tweet their own lines in our
database in <a href="/blog/2018/06/PostgreSQL-DML.md">PostgreSQL Concurrency: Data Modification
Language</a>, and having had them like a
retweet a lot in <a href="/blog/2018/07/postgresql-concurrency-isolation-and-locking/">PostgreSQL Concurrency: Isolation and
Locking</a>, it&rsquo;s
time to think about how to display our counters in an efficient way.</p>

<p>In this article, we&rsquo;re going to think about when we should compute results
and when we should cache them for instant retrieval, all within the SQL
tooling. The SQL tooling for handling cache is a <a href="https://www.postgresql.org/docs/current/static/sql-creatematerializedview.html">MATERIALIZED
VIEW</a>,
and it comes with <strong>cache invalidation</strong> routines, of course.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/07/modeling-for-concurrency/">
                <h3 class="media-heading">Modeling for Concurrency</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Let&rsquo;s continue to dive in PostgreSQL Concurrency. Last week&rsquo;s article
<a href="/blog/2018/07/postgresql-concurrency-isolation-and-locking/">PostgreSQL Concurrency: Isolation and
Locking</a> was a
primer on PostgreSQL isolation and locking properties and behaviors.</p>

<p>Today&rsquo;s article takes us a step further and builds on what we did last week,
in particular the database modeling for a <em>tweet</em> like application. After
having had all the characters from Shakespeare&rsquo;s <em>A Midsummer Night&rsquo;s Dream</em>
tweet their own lines in our database in <a href="/blog/2018/06/PostgreSQL-DML.md">PostgreSQL Concurrency: Data
Modification Language</a>, it&rsquo;s time for them
to do some actions on the tweets: likes and retweet.</p>

<p>Of course, we&rsquo;re going to put concurrency to the test, so we&rsquo;re going to
have to handle very very popular tweets from the play!</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/07/postgresql-concurrency-isolation-and-locking/">
                <h3 class="media-heading">PostgreSQL Concurrency: Isolation and Locking</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p><a href="https://www.postgresql.org">PostgreSQL</a> is a relational database management
system. It&rsquo;s even the world&rsquo;s most advanced open source one of them. As
such, as its core, Postgres solves concurrent access to a set of data and
maintains consistency while allowing concurrent operations.</p>

<p>This article is a primer on PostgreSQL Isolation and Locking properties and
behaviors. You might be interested into the previous article in the series:
<a href="/blog/2018/06/postgresql-concurrency-data-modification-language/">PostgreSQL Concurrency: Data Modification
Language</a>.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/06/postgresql-concurrency-data-modification-language/">
                <h3 class="media-heading">PostgreSQL Concurrency: Data Modification Language</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jun 6, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather">PostgreSQL is a relational database management system. It&rsquo;s even the world&rsquo;s most advanced open source one of them. As such, as its core, Postgres solves concurrent access to a set of data and maintains consistency while allowing concurrent operations.
Postgres exposes its concurrency APIs in the SQL language, in particular in the DML parts of it: you can read the Data Manipulation Language chapter of the PostgreSQL docs for all the details.</div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/05/postgresql-data-types/">
                <h3 class="media-heading">PostgreSQL Data Types</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  May 5, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Today it&rsquo;s time to conclude our series of <a href="/tags/data-types/">PostgreSQL Data
Types</a> articles with a recap. The series cover lots of
core PostgreSQL data types and shows how to benefit from the PostgreSQL
concept of a data type: more than input validation, a PostgreSQL data type
also implements expected behaviors and processing functions.</p>

<p>This allows an application developer to rely on PostgreSQL for more complex
queries, having the processing happen where the data is, for instance when
implementing advanced JOIN operations, then retrieving only the data set
that is interesting for the application.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
      </div>
    </div>
    <div class="modal-footer">
      <p class="results-count text-medium"
         data-message-zero=""
         data-message-one=""
         data-message-other="">
         282 posts found
      </p>
    </div>
  </div>
</div>
    
  
    
    <div id="cover" style="background-image:url('https://tapoueh.org/images/mayan-calendar.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="/js/script-qi9wbxp2ya2j6p7wx1i6tgavftewndznf4v0hy2gvivk1rxgc3lm7njqb6bz.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/tapoueh.org\/blog\/2013\/09\/postgresql-data-recovery\/';
          
            this.page.identifier = '\/blog\/2013\/09\/postgresql-data-recovery\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'tapoueh';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  



    
  </body>
</html>

