

  
    
  


  




  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.50">
    <meta name="theme" content="Tranquilpeak 0.3.1-BETA">
    <title>Find the number of the longest continuously rising days for a stock</title>
    <meta name="author" content="Dimitri Fontaine">
    <meta name="keywords" content="">

    <link rel="icon" href="/favicon.ico">
    

    
    <meta name="description" content="Today I want to react to an article that claims that Relational Algebra Is
the Root of SQL
Problems
in which the author hand-waves the following position:


SQL becomes more a hindrance to data manipulation than an efficient tool.
SQL’s greatest problem isn’t in the implementation level, but at its
theory foundation. The problem can’t be solved by application
optimization. Relational algebra isn’t sophisticated enough for handling
the complicated data manipulation scenarios.


Then they go on to several arguments from authority to “prove” their
point. My reading of the article is that SQL is very hard when you didn&rsquo;t
care to learn it, as most technologies are.

In this article, we&rsquo;re going to look at the simple examples provided where
apparently SQL makes it so much harder to find a solution compared to
writing some Java or C&#43;&#43; code. Contrary to the original article, we go as
far as to actually writing both the SQL solution and a complete Python
solution, so that we can compare.

">
    <meta property="og:description" content="Today I want to react to an article that claims that Relational Algebra Is
the Root of SQL
Problems
in which the author hand-waves the following position:


SQL becomes more a hindrance to data manipulation than an efficient tool.
SQL’s greatest problem isn’t in the implementation level, but at its
theory foundation. The problem can’t be solved by application
optimization. Relational algebra isn’t sophisticated enough for handling
the complicated data manipulation scenarios.


Then they go on to several arguments from authority to “prove” their
point. My reading of the article is that SQL is very hard when you didn&rsquo;t
care to learn it, as most technologies are.

In this article, we&rsquo;re going to look at the simple examples provided where
apparently SQL makes it so much harder to find a solution compared to
writing some Java or C&#43;&#43; code. Contrary to the original article, we go as
far as to actually writing both the SQL solution and a complete Python
solution, so that we can compare.

">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Find the number of the longest continuously rising days for a stock">
    <meta property="og:url" content="/blog/2018/02/find-the-number-of-the-longest-continuously-rising-days-for-a-stock/">
    <meta property="og:site_name" content="The Art of PostgreSQL">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Find the number of the longest continuously rising days for a stock">
    <meta name="twitter:description" content="Today I want to react to an article that claims that Relational Algebra Is
the Root of SQL
Problems
in which the author hand-waves the following position:


SQL becomes more a hindrance to data manipulation than an efficient tool.
SQL’s greatest problem isn’t in the implementation level, but at its
theory foundation. The problem can’t be solved by application
optimization. Relational algebra isn’t sophisticated enough for handling
the complicated data manipulation scenarios.


Then they go on to several arguments from authority to “prove” their
point. My reading of the article is that SQL is very hard when you didn&rsquo;t
care to learn it, as most technologies are.

In this article, we&rsquo;re going to look at the simple examples provided where
apparently SQL makes it so much harder to find a solution compared to
writing some Java or C&#43;&#43; code. Contrary to the original article, we go as
far as to actually writing both the SQL solution and a complete Python
solution, so that we can compare.

">
    
      <meta name="twitter:creator" content="@tapoueh">
    
    

    
    

    
      <meta property="og:image" content="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=640">
    

    
      <meta property="og:image" content="https://tapoueh.org/img/growing-stock-icon.jpg">
    
    
      <meta property="og:image" content="https://tapoueh.org/img/stocks-on-the-rise.jpg">
    
    

    

    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" />
    
    
    <link rel="stylesheet" href="/css/style-jsjn0006wyhpyzivf6yceb31gvpjatbcs3qzjvlumobfnugccvobqwxnnaj8.min.css" />
    
    
      <link rel="stylesheet" href="https://tapoueh.org/css/dim.css">
    
      <link rel="stylesheet" href="https://tapoueh.org/css/nav.css">
    

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-47059482-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="navbar-collapse collapse header-title" id="navigation">
    <ul class="nav navbar-nav navbar-right">
      
      <li class="dropdown">
        
        <a style="color: black;" href="/" alt="blog"><i class="sidebar-button-icon fa fa-lg fa-home"></i></a>
        
      </li>
      
      <li class="dropdown">
        
        <a style="color: black;" href="/conf/" alt="talks"><i class="sidebar-button-icon fa fa-lg fa-microphone"></i></a>
        
      </li>
      
      <li class="dropdown">
        
        <a style="color: black;" href="https://twitter.com/tapoueh" alt="Twitter"><i class="sidebar-button-icon fa fa-lg fa-twitter"></i></a>
        
      </li>
      
      <li class="dropdown">
        
        <a style="color: black;" href="https://masteringpostgresql.com/" alt="Mastering PostgreSQL"><i class="sidebar-button-icon fa fa-lg fa-book"></i></a>
        
      </li>
      
      <li class="dropdown">
        
        <a style="color: black;" href="http://theartofpostgresql.com" alt="The Art Of PostgreSQL"><i class="sidebar-button-icon fa fa-lg fa-edit"></i></a>
        
      </li>
      
    </ul>
  </div>

  
    
      <a class="header-right-icon "
         href="http://masteringpostgresql.com" target="_blank">
    
    
      <i class="fa fa-lg fa-book"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about">
          <img class="sidebar-profile-picture" src="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=110" alt="" />
        </a>
        <h4 class="sidebar-profile-name">Dimitri Fontaine</h4>
        
          <h5 class="sidebar-profile-bio">PostgreSQL Major Contributor</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/">
    
      <i class="sidebar-button-icon fa fa-lg fa-pagelines"></i>
      
      <span class="sidebar-button-desc">Blog</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/about/">
    
      <i class="sidebar-button-icon fa fa-lg fa-beer"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories/yesql/">
    
      <i class="sidebar-button-icon fa fa-lg fa-database"></i>
      
      <span class="sidebar-button-desc">YeSQL</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://masteringpostgresql.com" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-book"></i>
      
      <span class="sidebar-button-desc">Mastering PostgreSQL</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/dimitri" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/tapoueh" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      
  <div class="post-header-cover
              text-left
              post-header-cover--partial"
       style="background-image:url('/img/stocks-on-the-rise.jpg')"
       data-behavior="5">
    
      <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Find the number of the longest continuously rising days for a stock
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2018-02-06T23:24:17&#43;01:00">
        <span style="float: left; width: 35%">
          <i class="fa fa-calendar"></i> 
  
  
  
  
    Tuesday 06 Feb 2018
  

        </span>
      </time>
    
    <span style="float: right; width: 65%">
      <i class="fa fa-clock-o"></i> 17 mins read
      
    </span>
    <span style="float: left; width: 35%">
      <i class="fa fa-bookmark"></i> 
  
  
    <span></span>
    
      <a class="category-link" href="/categories/postgresql">PostgreSQL</a>, 
    
      <a class="category-link" href="/categories/yesql">YeSQL</a>
    
  

    </span>
    <div>
      <p>
        
        
        
        
        
        
        <a href="/tags/rising/">
          <i class="fa fa-tag"></i> Rising
        </a>
        
        
        
        <a href="/tags/window-functions/">
          <i class="fa fa-tag"></i> Window Functions
        </a>
        
        
        
        <a href="/tags/stock/">
          <i class="fa fa-tag"></i> Stock
        </a>
        
        
        
        <a href="/tags/recursive/">
          <i class="fa fa-tag"></i> Recursive
        </a>
        
        
      </p>
    </div>
  </div>


</div>
    
  </div>


      <div id="main" data-behavior="5"
        class="hasCover
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>Today I want to react to an article that claims that <a href="https://www.datasciencecentral.com/profiles/blogs/relational-algebra-is-the-root-of-sql-problems">Relational Algebra Is
the Root of SQL
Problems</a>
in which the author hand-waves the following position:</p>

<blockquote>
<p>SQL becomes more a hindrance to data manipulation than an efficient tool.
SQL’s greatest problem isn’t in the implementation level, but at its
theory foundation. The problem can’t be solved by application
optimization. Relational algebra isn’t sophisticated enough for handling
the complicated data manipulation scenarios.</p>
</blockquote>

<p>Then they go on to several <em>arguments from authority</em> to “prove” their
point. My reading of the article is that SQL is very hard when you didn&rsquo;t
care to learn it, as most technologies are.</p>

<p>In this article, we&rsquo;re going to look at the <em>simple examples</em> provided where
apparently SQL makes it so much harder to find a solution compared to
writing some Java or C++ code. Contrary to the original article, we go as
far as to actually writing both the SQL solution and a complete Python
solution, so that we can compare.</p>

<p></p>

<p>Maybe SQL is even less forgiving than most other technologies in that it is
a <em>declarative</em> programming language. It&rsquo;s very hard in SQL to improvise a
query, you really need to understand both the data model under it and also
the business case. You need to be able to describe <strong>what</strong> you want to
achieve, without telling much to the system about <strong>how</strong> to do it. When
you&rsquo;re not used to it, this is hard.</p>

<p>The simple examples made in the article entitled <a href="https://www.datasciencecentral.com/profiles/blogs/relational-algebra-is-the-root-of-sql-problems">Relational Algebra Is the
Root of SQL
Problems</a>
are the following:</p>

<ol>
<li><p>Find the number of the longest continuously rising days for a stock.</p></li>

<li><p>Find the top 10 among one billion records.</p></li>
</ol>

<p>Here follows implementations in SQL and Python of those two simple examples,
so that you can compare them.</p>

 




<div class="table-of-contents toc bd-callout">
    
    <h4 class="text-muted">Table of Contents</h4>
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/02/find-the-number-of-the-longest-continuously-rising-days-for-a-stock/#first-simple-example">
                    First Simple Example
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/02/find-the-number-of-the-longest-continuously-rising-days-for-a-stock/#having-some-data-to-play-with">
                    Having some data to play with
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/02/find-the-number-of-the-longest-continuously-rising-days-for-a-stock/#sql-foundamentals-needed">
                    SQL Foundamentals Needed
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/02/find-the-number-of-the-longest-continuously-rising-days-for-a-stock/#advanced-sql-with-full-details">
                    Advanced SQL With Full Details
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/02/find-the-number-of-the-longest-continuously-rising-days-for-a-stock/#the-sql-solution">
                    The SQL Solution
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/02/find-the-number-of-the-longest-continuously-rising-days-for-a-stock/#an-alternative-sql-implementation">
                    An Alternative SQL Implementation
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/02/find-the-number-of-the-longest-continuously-rising-days-for-a-stock/#a-python-implementation">
                    A Python Implementation
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/02/find-the-number-of-the-longest-continuously-rising-days-for-a-stock/#second-simple-example">
                    Second Simple Example
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/02/find-the-number-of-the-longest-continuously-rising-days-for-a-stock/#the-sql-solution">
                    The SQL Solution
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/02/find-the-number-of-the-longest-continuously-rising-days-for-a-stock/#a-python-implementation">
                    A Python Implementation
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/02/find-the-number-of-the-longest-continuously-rising-days-for-a-stock/#is-sql-that-bad-really">
                    Is SQL That Bad Really?
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/02/find-the-number-of-the-longest-continuously-rising-days-for-a-stock/#conclusion">
                    Conclusion
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
</div>



<h2 id="first-simple-example">First Simple Example</h2>

<p>Here&rsquo;s how the problem is described in the original article we are reacting
to here:</p>

<blockquote>
<p>It’s simple for Java or C++ programmers. They will create a counter whose
initial value is 0, sort records by date and traverse them all, add 1 to
the counter when the stock rises and reset it to 0 when it falls, and then
find the largest number the counter ever has.</p>

<p>The logic is natural, but it’s rather difficult to implement it in SQL.</p>

<p>Relational algebra inherits the mathematical concept of unordered sets,
which means the data sorting can only be performed at the output and the
order of traversal can’t be specified, making it difficult to implement
the logic in a natural way. Instead, programmers need to generate numbers
for the dates, create a group mark, group a rising day with the previous
day and put a falling day into another group, and then find the biggest
COUNT() value among the groups. The logic is difficult to grasp. That is
the issue of the translation of computing logic being more difficult than
the solution itself.</p>
</blockquote>

<p>Saying that the <em>logic is natural</em> without writing a single line of code is
an argument from authority in my book. Of course writing this quick recipe
without thinking about any level of details is always easy and simple, and
might even feel natural in somes cases. As <a href="https://en.wikiquote.org/wiki/Linus_Torvalds#2000-04">Linus Torvalds
said</a> once:</p>

<blockquote>
<p>Talk is cheap. Show me the code.</p>

<p><strong><em>Torvalds, Linus</em></strong> (2000-08-25), in a <a href="http://lkml.org/lkml/2000/8/25/132">message to linux-kernel mailing
list</a>.</p>
</blockquote>

<p>Saying then that <em>it&rsquo;s rather difficult to implement it in SQL</em> without even
trying is another argument from authority. And then the description of how
to write the SQL query focuses on <strong><em>how</em></strong> to retrieve the data rather than
<strong><em>what</em></strong> data we want to retrieve. That is going to make it really hard to
express in SQL.</p>

<p>Moreover, <em>the order of traversal can&rsquo;t be specified</em> sounds dubious. The
SQL standard cover the ORDER BY clause in the main query, in subqueries, as
an aggregate control, and in a window function frame definition. That&rsquo;s many
places where to specify the order of traversal, and SQL knows how to ORDER
BY date, thanks.</p>

<p>So, first thing first, we need a data model and a data set.</p>

<h2 id="having-some-data-to-play-with">Having some data to play with</h2>

<p><a href="https://www.nyse.com/">Intercontinental Exchange</a> provides a chart with
<a href="http://www.nyxdata.com/nysedata/asp/factbook/viewer_edition.asp?mode=table&amp;key=3141&amp;category=3">Daily NYSE Group Volume in NYSE Listed,
2017</a>.
We can fetch the <em>Excel</em> file which is actually a <em>CSV</em> file using <em>tab</em> as
a separator, remove the headings and load it into a PostgreSQL table.</p>

<figure class="right"><a href="https://masteringpostgresql.com">
    <img src="/img/MasteringPostgreSQLinAppDev-Cover-th.png"/> </a>
</figure>


<p>I have used this data set previously both in my book <a href="https://masteringpostgresql.com">Mastering PostgreSQL
in Application Development</a> and in the
article <a href="https://opensource.com/article/17/12/python-and-postgresql">How to use PostgreSQL to streamline Python
code</a> published
at <a href="http://opensource.com">http://opensource.com</a>. Here&rsquo;s what the <code>factbook</code> table looks like:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a">table</span> factbook <span style="color:#00a">limit</span> <span style="color:#099">10</span>;</code></pre></div>
<p>The <code>TABLE</code> command is standard SQL and included in PostgreSQL of course,
and an easy way to quickly see what&rsquo;s a data model all about. In our case,
we have the <em>date</em> and <em>dollars</em> columns, and some more:</p>

<pre><code> year │    date    │   shares   │ trades  │   dollars   
══════╪════════════╪════════════╪═════════╪═════════════
 2010 │ 2010-01-04 │ 1425504460 │ 4628115 │ 38495460645
 2010 │ 2010-01-05 │ 1754011750 │ 5394016 │ 43932043406
 2010 │ 2010-01-06 │ 1655507953 │ 5494460 │ 43816749660
 2010 │ 2010-01-07 │ 1797810789 │ 5674297 │ 44104237184
 2010 │ 2010-01-08 │ 1545692647 │ 5008824 │ 40816677580
 2010 │ 2010-01-11 │ 1492666469 │ 4970320 │ 41341854839
 2010 │ 2010-01-12 │ 1685064003 │ 5600471 │ 45676531877
 2010 │ 2010-01-13 │ 1468586700 │ 4989082 │ 39877317621
 2010 │ 2010-01-14 │ 1357605480 │ 4552360 │ 36899505722
 2010 │ 2010-01-15 │ 1952486180 │ 5335459 │ 53482586973
(10 rows)
</code></pre>

<p>Given this data set, it&rsquo;s then possible to find the number of the longest
continuously rising days for a stock, by looking at the dollars column.</p>

<h2 id="sql-foundamentals-needed">SQL Foundamentals Needed</h2>

<p>The first thing we need to know in SQL here is how to determine if the stock
is rising. This involves comparing the current row&rsquo;s <em>dollars</em> with the next
row&rsquo;s <em>dollars</em>. That is easily done with a <a href="/tags/window-functions/">Window
Function</a> as in the following example:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">  <span style="color:#00a">select</span> <span style="color:#0aa">date</span>,
         to_char(
           lag(dollars, <span style="color:#099">1</span>) over(<span style="color:#00a">order</span> <span style="color:#00a">by</span> <span style="color:#0aa">date</span>),
           <span style="color:#a50">&#39;L99G999G999G999&#39;</span>
         ) <span style="color:#00a">as</span> <span style="color:#a50">&#34;dollars previous day&#34;</span>,

         to_char(dollars, <span style="color:#a50">&#39;L99G999G999G999&#39;</span>) <span style="color:#00a">as</span> dollars,

         <span style="color:#00a">case</span> <span style="color:#00a">when</span>   dollars
                   - lag(dollars, <span style="color:#099">1</span>) over(<span style="color:#00a">order</span> <span style="color:#00a">by</span> <span style="color:#0aa">date</span>)
                   &lt; <span style="color:#099">0</span>
              <span style="color:#00a">then</span> <span style="color:#a50">&#39;-&#39;</span>
              <span style="color:#00a">else</span> <span style="color:#a50">&#39;+&#39;</span>
          <span style="color:#00a">end</span> <span style="color:#00a">as</span> diff
    <span style="color:#00a">from</span> factbook
<span style="color:#00a">order</span> <span style="color:#00a">by</span> <span style="color:#0aa">date</span>
   <span style="color:#00a">limit</span> <span style="color:#099">5</span>;</code></pre></div>
<p>The <code>lag(dollars, 1) over(order by date)</code> SQL window function expression
gives us the amount of dollars for the previous day. It&rsquo;s then easy to
compare that number with the current&rsquo;s one and output a <code>+</code> if the stock is
rising, or a <code>-</code> if it&rsquo;s lowering:</p>

<pre><code>    date    │ dollars previous day │     dollars      │ diff 
════════════╪══════════════════════╪══════════════════╪══════
 2010-01-04 │ ¤                    │ $ 38,495,460,645 │ +
 2010-01-05 │ $ 38,495,460,645     │ $ 43,932,043,406 │ +
 2010-01-06 │ $ 43,932,043,406     │ $ 43,816,749,660 │ -
 2010-01-07 │ $ 43,816,749,660     │ $ 44,104,237,184 │ +
 2010-01-08 │ $ 44,104,237,184     │ $ 40,816,677,580 │ -
(5 rows)
</code></pre>

<p>Using that knowledge, we might be able to actually find our magic number,
right?</p>

<h2 id="advanced-sql-with-full-details">Advanced SQL With Full Details</h2>

<p>Once we have the <code>+</code> and <code>-</code> information computed from the data set, the
number of continuously raising days can be found by collecting all the <code>+</code>
that follow each-other in a row.</p>

<p>Another way to say that is to find the first following date for which the
computed <em>diff</em> column changes, either from <code>+</code> to <code>-</code> or the other way
around, from <code>-</code> to <code>+</code>. This kind of lookup to the next value is done with
a <em>self-join</em> in SQL, and can be implemented in the following way:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a">with</span> diffs <span style="color:#00a">as</span>
  (
     <span style="color:#aaa;font-style:italic">--
</span><span style="color:#aaa;font-style:italic"></span>     <span style="color:#aaa;font-style:italic">-- compute if the current stock is raising or lowering
</span><span style="color:#aaa;font-style:italic"></span>     <span style="color:#aaa;font-style:italic">--
</span><span style="color:#aaa;font-style:italic"></span>     <span style="color:#00a">select</span> <span style="color:#0aa">date</span>, dollars,
            <span style="color:#00a">case</span> <span style="color:#00a">when</span>   dollars
                      - lag(dollars, <span style="color:#099">1</span>) over(<span style="color:#00a">order</span> <span style="color:#00a">by</span> <span style="color:#0aa">date</span>)
                      &lt; <span style="color:#099">0</span>
                 <span style="color:#00a">then</span> <span style="color:#a50">&#39;-&#39;</span>
                 <span style="color:#00a">else</span> <span style="color:#a50">&#39;+&#39;</span>
             <span style="color:#00a">end</span> <span style="color:#00a">as</span> diff
          <span style="color:#00a">from</span> factbook
      <span style="color:#00a">where</span> <span style="color:#0aa">date</span> <span style="color:#00a">is</span> <span style="color:#00a">not</span> <span style="color:#00a">null</span>
   <span style="color:#00a">order</span> <span style="color:#00a">by</span> <span style="color:#0aa">date</span>
  )
<span style="color:#00a">select</span> diffs.diff,
       <span style="color:#00a">min</span>(diffs.<span style="color:#0aa">date</span>) <span style="color:#00a">as</span> <span style="color:#00a">start</span>,
       diff_change.<span style="color:#0aa">date</span> <span style="color:#00a">as</span> <span style="color:#00a">end</span>,
       <span style="color:#00a">count</span>(*) <span style="color:#00a">as</span> days

  <span style="color:#00a">from</span> diffs
       <span style="color:#00a">left</span> <span style="color:#00a">join</span> <span style="color:#00a">lateral</span>
       <span style="color:#aaa;font-style:italic">-- 
</span><span style="color:#aaa;font-style:italic"></span>       <span style="color:#aaa;font-style:italic">-- for each row of our &#34;diffs&#34; relation, compute the next
</span><span style="color:#aaa;font-style:italic"></span>       <span style="color:#aaa;font-style:italic">-- day at which the stock change direction is changing, that is
</span><span style="color:#aaa;font-style:italic"></span>       <span style="color:#aaa;font-style:italic">-- where a + becomes a - or the other way round
</span><span style="color:#aaa;font-style:italic"></span>       <span style="color:#aaa;font-style:italic">-- 
</span><span style="color:#aaa;font-style:italic"></span>       (
         <span style="color:#00a">select</span> <span style="color:#0aa">date</span>
           <span style="color:#00a">from</span> diffs d2
          <span style="color:#00a">where</span> d2.<span style="color:#0aa">date</span> &gt; diffs.<span style="color:#0aa">date</span>
            <span style="color:#00a">and</span> d2.diff &lt;&gt; diffs.diff
       <span style="color:#00a">order</span> <span style="color:#00a">by</span> <span style="color:#0aa">date</span>
          <span style="color:#00a">limit</span> <span style="color:#099">1</span>
       ) <span style="color:#00a">as</span> diff_change <span style="color:#00a">on</span> <span style="color:#00a">true</span>

<span style="color:#aaa;font-style:italic">--
</span><span style="color:#aaa;font-style:italic">-- we group by the date where the +/- change occurs
</span><span style="color:#aaa;font-style:italic">-- and count how many rows share that value
</span><span style="color:#aaa;font-style:italic">--
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#00a">group</span> <span style="color:#00a">by</span> diffs.diff, diff_change.<span style="color:#0aa">date</span>
  <span style="color:#00a">having</span> <span style="color:#00a">count</span>(*) &gt; <span style="color:#099">4</span>
<span style="color:#00a">order</span> <span style="color:#00a">by</span> days <span style="color:#00a">desc</span>, <span style="color:#00a">start</span>;</code></pre></div>
<p>In this query, we first compute the differences in between the current and
the next row, as in the previous section of this article. Equiped with that
in the common table expression <em>diffs</em>, we may now find the previous date
when there&rsquo;s a change of direction in the stock value.</p>

<p>That lookup is implemented in the LEFT JOIN LATERAL subquery thanks to the
use of the ORDER BY and LIMIT clauses. Once we have found the date at which
the current trend changes, then we can compute how many days have been
having the same trend value thanks to a GROUP BY clause.</p>

<p>In order to make it easier to follow all the steps of writing the SQL query,
this query focuses on more than just the single result that&rsquo;s asked for: we
go to some lengths in order to display the following <em>debug</em> output, where
not only we have the maximum number of rising days for our stock, but also
the first and last day when it happened. Oh and we have both the rising and
lowering values too…</p>

<pre><code> diff │   start    │    end     │ days 
══════╪════════════╪════════════╪══════
 +    │ 2017-07-17 │ 2017-07-26 │    7
 -    │ 2014-08-07 │ 2014-08-15 │    6
 -    │ 2014-08-18 │ 2014-08-26 │    6
 +    │ 2015-07-21 │ 2015-07-29 │    6
 -    │ 2010-05-07 │ 2010-05-14 │    5
 -    │ 2010-07-30 │ 2010-08-06 │    5
 -    │ 2010-12-20 │ 2010-12-28 │    5
 +    │ 2011-08-02 │ 2011-08-09 │    5
 -    │ 2011-08-09 │ 2011-08-16 │    5
 -    │ 2011-11-18 │ 2011-11-28 │    5
 +    │ 2012-05-14 │ 2012-05-21 │    5
 +    │ 2016-10-25 │ 2016-11-01 │    5
 -    │ 2017-03-01 │ 2017-03-08 │    5
(13 rows)
</code></pre>

<p>The HAVING clause implements a restriction of the output to limit how many
rows we display, we could have been using a LIMIT clause instead if we
wanted to show a known number of rows in advance rather than only the
interesting values from the data set.</p>

<h2 id="the-sql-solution">The SQL Solution</h2>

<p>So, now that we have seen this <em>debug</em> oriented result set, we can write a
SQL query that answers the question we are tasked with in the first place:</p>

<blockquote>
<p>Find the number of the longest continuously rising days for a stock.</p>
</blockquote>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a">with</span> diffs <span style="color:#00a">as</span>
  (
     <span style="color:#aaa;font-style:italic">--
</span><span style="color:#aaa;font-style:italic"></span>     <span style="color:#aaa;font-style:italic">-- compute if the current stock is raising or lowering
</span><span style="color:#aaa;font-style:italic"></span>     <span style="color:#aaa;font-style:italic">--
</span><span style="color:#aaa;font-style:italic"></span>     <span style="color:#00a">select</span> <span style="color:#0aa">date</span>, dollars,
            <span style="color:#00a">case</span> <span style="color:#00a">when</span>   dollars
                      - lag(dollars, <span style="color:#099">1</span>) over(<span style="color:#00a">order</span> <span style="color:#00a">by</span> <span style="color:#0aa">date</span>)
                      &lt; <span style="color:#099">0</span>
                 <span style="color:#00a">then</span> <span style="color:#a50">&#39;-&#39;</span>
                 <span style="color:#00a">else</span> <span style="color:#a50">&#39;+&#39;</span>
             <span style="color:#00a">end</span> <span style="color:#00a">as</span> diff
       <span style="color:#00a">from</span> factbook
      <span style="color:#00a">where</span> <span style="color:#0aa">date</span> <span style="color:#00a">is</span> <span style="color:#00a">not</span> <span style="color:#00a">null</span>
   <span style="color:#00a">order</span> <span style="color:#00a">by</span> <span style="color:#0aa">date</span>
  )
<span style="color:#00a">select</span> <span style="color:#00a">count</span>(*) <span style="color:#00a">as</span> days

  <span style="color:#00a">from</span> diffs
       <span style="color:#00a">left</span> <span style="color:#00a">join</span> <span style="color:#00a">lateral</span>
       <span style="color:#aaa;font-style:italic">-- 
</span><span style="color:#aaa;font-style:italic"></span>       <span style="color:#aaa;font-style:italic">-- for each row of our &#34;diffs&#34; relation, compute the next
</span><span style="color:#aaa;font-style:italic"></span>       <span style="color:#aaa;font-style:italic">-- day at which the stock change direction is changing, that is
</span><span style="color:#aaa;font-style:italic"></span>       <span style="color:#aaa;font-style:italic">-- where a + becomes a - or the other way round
</span><span style="color:#aaa;font-style:italic"></span>       <span style="color:#aaa;font-style:italic">-- 
</span><span style="color:#aaa;font-style:italic"></span>       (
         <span style="color:#00a">select</span> <span style="color:#0aa">date</span>
           <span style="color:#00a">from</span> diffs d2
          <span style="color:#00a">where</span> d2.<span style="color:#0aa">date</span> &gt; diffs.<span style="color:#0aa">date</span>
            <span style="color:#00a">and</span> d2.diff &lt;&gt; diffs.diff
       <span style="color:#00a">order</span> <span style="color:#00a">by</span> <span style="color:#0aa">date</span>
          <span style="color:#00a">limit</span> <span style="color:#099">1</span>
       ) <span style="color:#00a">as</span> diff_change <span style="color:#00a">on</span> <span style="color:#00a">true</span>

 <span style="color:#00a">where</span> diffs.diff = <span style="color:#a50">&#39;+&#39;</span>

<span style="color:#aaa;font-style:italic">--
</span><span style="color:#aaa;font-style:italic">-- we group by the date where the +/- change occurs
</span><span style="color:#aaa;font-style:italic">-- and count how many rows share that value
</span><span style="color:#aaa;font-style:italic">--
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#00a">group</span> <span style="color:#00a">by</span> diff_change.<span style="color:#0aa">date</span>

<span style="color:#aaa;font-style:italic">--
</span><span style="color:#aaa;font-style:italic">-- and we only keep the longest continuously rising number of days
</span><span style="color:#aaa;font-style:italic">--
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#00a">order</span> <span style="color:#00a">by</span> days <span style="color:#00a">desc</span>
   <span style="color:#00a">limit</span> <span style="color:#099">1</span>;</code></pre></div>
<p>The answer is the following, straight to the point, without any extra
information:</p>

<pre><code> days 
══════
    7
(1 row)
</code></pre>

<p>Now is that query simple and its logic natural? It&rsquo;s easy enough to already
have an opinion on that, but we might also want to refrain until we have a
competing implementation (e.g. in Python) to actually think about it.</p>

<h2 id="an-alternative-sql-implementation">An Alternative SQL Implementation</h2>

<p>The same problem can be solved with using a recursive approach that looks
like the classic <a href="https://wiki.postgresql.org/wiki/Loose_indexscan">Loose Index
Scan</a> method. The idea is
to start with the last day from our table. That&rsquo;s easy enough.</p>

<p>Then we fetch the day before from there, and see if its sock has risen, in
which case we increment our computed <em>day</em> column to reflect the situation,
and repeat the operation as long as we have days:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a">with</span> <span style="color:#00a">recursive</span> raising <span style="color:#00a">as</span>
(
   (
       <span style="color:#aaa;font-style:italic">-- 
</span><span style="color:#aaa;font-style:italic"></span>       <span style="color:#aaa;font-style:italic">-- start with the most recent date in our dataset
</span><span style="color:#aaa;font-style:italic"></span>       <span style="color:#aaa;font-style:italic">-- and prepare our recursive computed data: series
</span><span style="color:#aaa;font-style:italic"></span>       <span style="color:#aaa;font-style:italic">-- of increasing dollars values and number of days 
</span><span style="color:#aaa;font-style:italic"></span>       <span style="color:#aaa;font-style:italic">-- in a row of seeing an increase
</span><span style="color:#aaa;font-style:italic"></span>       <span style="color:#aaa;font-style:italic">--
</span><span style="color:#aaa;font-style:italic"></span>   <span style="color:#00a">select</span> <span style="color:#0aa">date</span>, dollars, <span style="color:#0aa">array</span>[dollars] <span style="color:#00a">as</span> series, <span style="color:#099">0</span> <span style="color:#00a">as</span> days
     <span style="color:#00a">from</span> factbook
    <span style="color:#00a">where</span> <span style="color:#0aa">date</span> <span style="color:#00a">is</span> <span style="color:#00a">not</span> <span style="color:#00a">null</span>
 <span style="color:#00a">order</span> <span style="color:#00a">by</span> <span style="color:#0aa">date</span> <span style="color:#00a">desc</span>
    <span style="color:#00a">limit</span> <span style="color:#099">1</span>
   )
   
   <span style="color:#00a">union</span> <span style="color:#00a">all</span>
    
  (
         <span style="color:#aaa;font-style:italic">--
</span><span style="color:#aaa;font-style:italic"></span>         <span style="color:#aaa;font-style:italic">-- fetch the previous day of factbook data and compute
</span><span style="color:#aaa;font-style:italic"></span>         <span style="color:#aaa;font-style:italic">-- the new series/days values depending on the value of
</span><span style="color:#aaa;font-style:italic"></span>         <span style="color:#aaa;font-style:italic">-- the previous factbook day compared to the value of the
</span><span style="color:#aaa;font-style:italic"></span>         <span style="color:#aaa;font-style:italic">-- current day in raising
</span><span style="color:#aaa;font-style:italic"></span>         <span style="color:#aaa;font-style:italic">--
</span><span style="color:#aaa;font-style:italic"></span>     <span style="color:#00a">select</span> factbook.<span style="color:#0aa">date</span>,
            factbook.dollars,
            <span style="color:#00a">case</span> <span style="color:#00a">when</span> raising.dollars &gt; factbook.dollars
                 <span style="color:#00a">then</span> <span style="color:#0aa">array</span>[factbook.dollars] || raising.series
                 <span style="color:#00a">else</span> <span style="color:#0aa">array</span>[factbook.dollars]
             <span style="color:#00a">end</span> <span style="color:#00a">as</span> series,
            <span style="color:#00a">case</span> <span style="color:#00a">when</span> raising.dollars &gt; factbook.dollars
                 <span style="color:#00a">then</span> days + <span style="color:#099">1</span>
                 <span style="color:#00a">else</span> <span style="color:#099">0</span>
             <span style="color:#00a">end</span> <span style="color:#00a">as</span> days
       <span style="color:#00a">from</span> factbook <span style="color:#00a">join</span> raising <span style="color:#00a">on</span> factbook.<span style="color:#0aa">date</span> &lt; raising.<span style="color:#0aa">date</span>
   <span style="color:#00a">order</span> <span style="color:#00a">by</span> <span style="color:#0aa">date</span> <span style="color:#00a">desc</span>
      <span style="color:#00a">limit</span> <span style="color:#099">1</span>
  )
)
<span style="color:#aaa;font-style:italic">--
</span><span style="color:#aaa;font-style:italic">-- display only the interesting part of the recursive
</span><span style="color:#aaa;font-style:italic">-- query results:
</span><span style="color:#aaa;font-style:italic">--
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#00a">select</span> days, <span style="color:#0aa">date</span>, series
    <span style="color:#00a">from</span> raising
   <span style="color:#00a">where</span> days &gt; <span style="color:#099">4</span>
<span style="color:#00a">order</span> <span style="color:#00a">by</span> days <span style="color:#00a">desc</span>;</code></pre></div>
<p>And the query shows interesting information that&rsquo;s not asked for, such as
the series of <em>dollars</em> values that have been registered to the number of
days we&rsquo;re looking for:</p>

<pre><code> days │    date    │                                              series                                               
══════╪════════════╪═══════════════════════════════════════════════════════════════════════════════════════════════════
    7 │ 2017-07-14 │ {32588362765,33760987656,35165369201,35297166209,39376330787,42470589106,42701120315,54039073558}
    6 │ 2015-07-20 │ {35853995657,39619794106,42664392961,43134509170,43590746301,45959161744,47026897118}
    6 │ 2017-07-17 │ {33760987656,35165369201,35297166209,39376330787,42470589106,42701120315,54039073558}
    5 │ 2012-05-11 │ {35089242038,35385171602,38619918965,39640166828,42001050587,50014530108}
    5 │ 2017-07-18 │ {35165369201,35297166209,39376330787,42470589106,42701120315,54039073558}
    5 │ 2011-08-01 │ {51752009908,56183343867,62257561258,80176338229,94797260297,101033041245}
    5 │ 2016-10-24 │ {37480090453,39682504757,41375471787,44843918730,45627849370,49351786965}
    5 │ 2015-07-21 │ {39619794106,42664392961,43134509170,43590746301,45959161744,47026897118}
(8 rows)
</code></pre>

<p>It&rsquo;s easy from there to change the last part of the query so that it would
only returns the number 7 that we want to find here.</p>

<h2 id="a-python-implementation">A Python Implementation</h2>

<p>A very classic implementation of the problem at hand in Python would look
like the following script:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#aaa;font-style:italic">#! /usr/bin/env python3</span>

<span style="color:#00a">import</span> <span style="color:#0aa;text-decoration:underline">psycopg2</span>
<span style="color:#00a">from</span> <span style="color:#0aa;text-decoration:underline">collections</span> <span style="color:#00a">import</span> namedtuple

Record = namedtuple(<span style="color:#a50">&#39;Record&#39;</span>, <span style="color:#a50">&#39;date days&#39;</span>)
PGCONNSTRING = <span style="color:#a50">&#34;dbname=appdev application_name=cont&#34;</span>

<span style="color:#00a">def</span> <span style="color:#0a0">cont</span>():
    <span style="color:#a50">&#34;Fetch data from the factbook table&#34;</span>

    conn = psycopg2.connect(PGCONNSTRING)
    curs = conn.cursor()
    sql = <span style="color:#a50">&#34;&#34;&#34;
</span><span style="color:#a50">  SELECT date, dollars
</span><span style="color:#a50">    FROM factbook
</span><span style="color:#a50">   WHERE date is not null
</span><span style="color:#a50">ORDER BY date
</span><span style="color:#a50">&#34;&#34;&#34;</span>
    curs.execute(sql)

    previous_date = None
    previous_dollars = None

    current = Record(date=None, days=<span style="color:#099">0</span>)
    best = Record(date=None, days=<span style="color:#099">0</span>)

    <span style="color:#00a">for</span> date, dollars <span style="color:#00a">in</span> curs.fetchall():
        <span style="color:#00a">if</span> previous_dollars:
            <span style="color:#00a">if</span> dollars &gt; previous_dollars:
                current = Record(current.date, current.days + <span style="color:#099">1</span>)
                <span style="color:#00a">if</span> current.days &gt; best.days:
                    best = Record(current.date, current.days)
            <span style="color:#00a">else</span>:
                current = Record(date, <span style="color:#099">0</span>)
        <span style="color:#00a">else</span>:
            current = Record(date, <span style="color:#099">0</span>)

        previous_date, previous_dollars = date, dollars

    <span style="color:#00a">return</span> best

<span style="color:#00a">if</span> __name__ == <span style="color:#a50">&#39;__main__&#39;</span>:
    rising = cont()

    <span style="color:#00a">print</span>(<span style="color:#a50">&#34;Continuously rising days: </span><span style="color:#a50">%d</span><span style="color:#a50"> days from </span><span style="color:#a50">%s</span><span style="color:#a50">&#34;</span> % (rising.days,
                                                         rising.date))</code></pre></div>
<p>Running the code gives us the following result, as expected:</p>

<pre><code>Continuously rising days: 7 days from 2017-07-14
</code></pre>

<p>The only bits that might be not the simplest possible implementation of the
problem set is that I chose to keep track of not only the number of days but
also the date when the rising series starts, and I&rsquo;ve been using a
<em>namedtuple</em> to keep track of that.</p>

<h2 id="second-simple-example">Second Simple Example</h2>

<p>The other simple example provided is to <em>find the top 10 among one billion
records</em>.</p>

<p>And the article&rsquo;s author goes on to mention that</p>

<blockquote>
<p>There’s no need to sort the one billion records to find the desired ones.
We create a 10-member empty set, and traverse data while keeping the set
contain the top 10 records of the traversed records. That way we just need
to perform one traversal with a very small memory space occupied and a
good computational performance.</p>

<p>Unfortunately as the relational algebra doesn’t define an explicit set
data type, SQL can’t express the algorithm.</p>
</blockquote>

<h2 id="the-sql-solution-1">The SQL Solution</h2>

<p>Well the way to express the algorithm in SQL is to describe the result we
are interested into, and for that here we can use the simple ORDER BY and
LIMIT clauses of the language:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a">explain</span> (<span style="color:#00a">analyze</span>, <span style="color:#00a">verbose</span>, buffers)

   <span style="color:#00a">select</span> <span style="color:#0aa">date</span>, dollars
     <span style="color:#00a">from</span> factbook
 <span style="color:#00a">order</span> <span style="color:#00a">by</span> dollars <span style="color:#00a">desc</span>
    <span style="color:#00a">limit</span> <span style="color:#099">10</span>;</code></pre></div>
<p>Now, we don&rsquo;t get to specify <strong>how</strong> the data is going to be retrieved by
our SQL engine. Of course, We can trust PostgreSQL to do the Right Thing™
here for us, as we can see in full details thanks to the previous EXPLAIN
(ANALYZE, VERBOSE, BUFFERS) command. It gives the following result:</p>

<pre><code> Limit  (cost=76.73..76.76 rows=10 width=12)
        (actual time=1.356..1.359 rows=10 loops=1)
   Output: date, dollars
   Buffers: shared hit=18
   -&gt;  Sort  (cost=76.73..81.62 rows=1953 width=12)
             (actual time=1.354..1.354 rows=10 loops=1)
         Output: date, dollars
         Sort Key: factbook.dollars DESC
         Sort Method: top-N heapsort  Memory: 25kB
         Buffers: shared hit=18
         -&gt;  Seq Scan on public.factbook
                   (cost=0.00..34.53 rows=1953 width=12)
                   (actual time=0.017..0.673 rows=1953 loops=1)
               Output: date, dollars
               Buffers: shared hit=15
 Planning time: 0.137 ms
 Execution time: 1.395 ms
(13 rows)
</code></pre>

<p>The mention of the <em>Top-N heapsort</em> that used exactly 25kB of memory is
exactly the suggested implementation. I don&rsquo;t suppose you could implement
that in 4 lines of your favorite programming language, but even if you
actually can, that&rsquo;s beyond the point. It is actually very simple to solve
that simple exercise in SQL, and that includes checking that the right
algorithm is in use.</p>

<p>The result of the query isn&rsquo;t very interesting, though we might want to
compare with the Python implementation of the Top-N algorithm:</p>

<pre><code>    date    │   dollars    
════════════╪══════════════
 2014-12-19 │ 124663932012
 2015-09-18 │ 118869806099
 2014-09-19 │ 118622863491
 2013-12-20 │ 117924997250
 2015-03-20 │ 115466468635
 2016-06-24 │ 112434567771
 2015-06-26 │ 110931465892
 2010-06-25 │ 110901889417
 2015-12-18 │ 110329938339
 2014-03-21 │ 107923489435
(10 rows)
</code></pre>

<h2 id="a-python-implementation-1">A Python Implementation</h2>

<p>In Python, implementing a Top-N heapsort can be done using the
<a href="https://docs.python.org/3/library/heapq.html">heapq</a> standard library, as
in the following code:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#aaa;font-style:italic">#! /usr/bin/env python3</span>

<span style="color:#00a">import</span> <span style="color:#0aa;text-decoration:underline">psycopg2</span>
<span style="color:#00a">import</span> <span style="color:#0aa;text-decoration:underline">heapq</span>
<span style="color:#00a">import</span> <span style="color:#0aa;text-decoration:underline">sys</span>

PGCONNSTRING = <span style="color:#a50">&#34;dbname=appdev application_name=cont&#34;</span>


<span style="color:#00a">def</span> <span style="color:#0a0">top</span>(n):
    <span style="color:#a50">&#34;Fetch data from the factbook table&#34;</span>

    conn = psycopg2.connect(PGCONNSTRING)
    curs = conn.cursor()
    sql = <span style="color:#a50">&#34;&#34;&#34;
</span><span style="color:#a50">  SELECT date, dollars
</span><span style="color:#a50">    FROM factbook
</span><span style="color:#a50">   WHERE date is not null
</span><span style="color:#a50">&#34;&#34;&#34;</span>
    curs.execute(sql)

    topn = [(<span style="color:#099">0</span>, None) <span style="color:#00a">for</span> i <span style="color:#00a">in</span> <span style="color:#0aa">range</span>(n)]
    heapq.heapify(topn)

    <span style="color:#00a">for</span> date, dollars <span style="color:#00a">in</span> curs.fetchall():
        heapq.heappushpop(topn, (dollars, date))

    <span style="color:#00a">return</span> topn


<span style="color:#00a">if</span> __name__ == <span style="color:#a50">&#39;__main__&#39;</span>:
    n = <span style="color:#0aa">int</span>(sys.argv[<span style="color:#099">1</span>])
    topn = top(n)

    <span style="color:#00a">for</span> dollars, date <span style="color:#00a">in</span> heapq.nlargest(n, topn):
        <span style="color:#00a">print</span>(<span style="color:#a50">&#34;</span><span style="color:#a50">%s</span><span style="color:#a50">: </span><span style="color:#a50">%s</span><span style="color:#a50">&#34;</span> % (date, dollars))</code></pre></div>
<p>The implementation is pretty straightforward, with the trick of using the
Python function <code>heappushpop</code> that requires an that we initialize a dummy
top-n result structure before looping over the result set.</p>

<pre><code>2014-12-19: 124663932012
2015-09-18: 118869806099
2014-09-19: 118622863491
2013-12-20: 117924997250
2015-03-20: 115466468635
2016-06-24: 112434567771
2015-06-26: 110931465892
2010-06-25: 110901889417
2015-12-18: 110329938339
2014-03-21: 107923489435
</code></pre>

<p>The result is the same as before, of course.</p>

<h2 id="is-sql-that-bad-really">Is SQL That Bad Really?</h2>

<p>To conclude this article, I think that
<a href="https://twitter.com/ngollperrier">Nicolas</a> makes a very good point in his
tweet here:</p>

<p><center>
<blockquote class="twitter-tweet" data-conversation="none" data-lang="en"><p lang="en" dir="ltr">1/ I&#39;m not complaining about SQL, I&#39;m citing a point of view. For most data use cases it probably still is the best tool for the job. However, I find the dogmatic approach to try to solve every problem with it unsettling.</p>&mdash; Nicolas Goll-Perrier (@ngollperrier) <a href="https://twitter.com/ngollperrier/status/959404749283094528?ref_src=twsrc%5Etfw">February 2, 2018</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</center></p>

<p>So rather than being dogmatic about it, my suggestion is to be pragmatic:</p>

<ol>
<li><p>Know your SQL and what can be done with this powerful programming
 language, and when being declarative is a strength.</p></li>

<li><p>Remember that SQL and relational algebra are not exactly the same
 thing, as explained e.g. in <a href="http://www.cs.cornell.edu/projects/btr/bioinformaticsschool/slides/gehrke.pdf">Relational Algebra and
 SQL</a>
 from professor <a href="http://www.cs.cornell.edu/johannes/">Johannes Gehrke</a>
 from Cornell University.</p></li>

<li><p>Pick the right tool for the right job, thinking about several
 dimensions in which you&rsquo;re making trade-offs, most importantly the
 modularity violations you might be making and how to properly document
 them and maintain the resulting code-base in the long term.</p></li>
</ol>

<p>The trade-offs we make when choosing to solve problems in SQL or in
application code can be quite complex, and need proper thinking. My advice
is to first go with the more obvious solution in terms of architecture and
responsibility of the <em>modules</em> or <em>systems</em> you&rsquo;re using: make it obvious,
and only then, when you hit limitations that aren&rsquo;t compatible with your
constraints, then try and be clever about it, and maybe optimize by
violating your system&rsquo;s modularity.</p>

<p>It means that sometimes you will pick the SQL implementation even if it&rsquo;s
not so obvious and requires knowing about <em>lateral joins</em> and <em>window
functions</em>, and sometimes you&rsquo;ll be implementing it in the application
middleware or even in the front-end UI code because that&rsquo;s where it belongs,
and you&rsquo;ll bypass the database entirely, or use it a an dumb object store.</p>

<p>My opinion is that either choice is ok as long as you took a concious
decision. What I still often see in the field though, is developers who have
no idea about what can be done in SQL these days and are stuck in a kind of
<a href="https://en.wikipedia.org/wiki/Greenspun%27s_tenth_rule">Greenspun&rsquo;s tenth
rule</a> only applied
to SQL rather than Common-Lisp:</p>

<blockquote>
<p>Any sufficiently complicated C or Fortran program contains an ad-hoc,
informally-specified, bug-ridden, slow implementation of half of Common
Lisp.</p>
</blockquote>

<h2 id="conclusion">Conclusion</h2>

<p>PostgreSQL implements a very advanced version of SQL, so that&rsquo;s even more
the case when focusing on PostgreSQL, as I do.</p>

<figure class="right"><a href="https://masteringpostgresql.com">
    <img src="/img/MasteringPostgreSQLinAppDev-Cover-th.png"/> </a>
</figure>


<p>The idea behing both this article and my book <a href="https://masteringpostgresql.com">Mastering PostgreSQL in
Application Development</a> is that as a
developer using some SQL in your application code, you should master it and
know what&rsquo;s possible to implement with the PostgreSQL system, so that you
can make the right choices in terms of your application&rsquo;s architecture.</p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small"></span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/postgresql/">PostgreSQL</a>

  <a class="tag tag--primary tag--small" href="/tags/yesql/">YeSQL</a>

  <a class="tag tag--primary tag--small" href="/tags/rising/">Rising</a>

  <a class="tag tag--primary tag--small" href="/tags/window-functions/">Window Functions</a>

  <a class="tag tag--primary tag--small" href="/tags/stock/">Stock</a>

  <a class="tag tag--primary tag--small" href="/tags/recursive/">Recursive</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  <div class="post-footer-tags taop">
   
   <section class="ny-body">
    <p class="ny-desc">I wrote a book!</p>
    <script async data-uid="c1452ad801" src="https://f.convertkit.com/c1452ad801/ad53e74e51.js"></script>
   </section>
    
    
  </div>
  <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2018/02/sustainable-open-source-development/" data-tooltip="Sustainable Open Source Development">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml"></span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2018/01/exporting-a-hierarchy-in-json-with-recursive-queries/" data-tooltip="Exporting a Hierarchy in JSON: with recursive queries">
          
            <span class="hide-xs hide-sm text-small icon-mr"></span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f02%2ffind-the-number-of-the-longest-continuously-rising-days-for-a-stock%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f02%2ffind-the-number-of-the-longest-continuously-rising-days-for-a-stock%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Find%20the%20number%20of%20the%20longest%20continuously%20rising%20days%20for%20a%20stock with @tapoueh: https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f02%2ffind-the-number-of-the-longest-continuously-rising-days-for-a-stock%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#table-of-contents">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2019 Dimitri Fontaine. 
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        <div class="post-actions-wrap">
  <div class="post-footer-tags taop">
   
   <section class="ny-body">
    <p class="ny-desc">I wrote a book!</p>
    <script async data-uid="c1452ad801" src="https://f.convertkit.com/c1452ad801/ad53e74e51.js"></script>
   </section>
    
    
  </div>
  <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2018/02/sustainable-open-source-development/" data-tooltip="Sustainable Open Source Development">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml"></span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2018/01/exporting-a-hierarchy-in-json-with-recursive-queries/" data-tooltip="Exporting a Hierarchy in JSON: with recursive queries">
          
            <span class="hide-xs hide-sm text-small icon-mr"></span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f02%2ffind-the-number-of-the-longest-continuously-rising-days-for-a-stock%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f02%2ffind-the-number-of-the-longest-continuously-rising-days-for-a-stock%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Find%20the%20number%20of%20the%20longest%20continuously%20rising%20days%20for%20a%20stock with @tapoueh: https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f02%2ffind-the-number-of-the-longest-continuously-rising-days-for-a-stock%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#table-of-contents">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <ul class="share-options">
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f02%2ffind-the-number-of-the-longest-continuously-rising-days-for-a-stock%2f">
        <i class="fa fa-google-plus"></i><span></span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f02%2ffind-the-number-of-the-longest-continuously-rising-days-for-a-stock%2f">
        <i class="fa fa-facebook-official"></i><span></span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Find%20the%20number%20of%20the%20longest%20continuously%20rising%20days%20for%20a%20stock with @tapoueh: https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f02%2ffind-the-number-of-the-longest-continuously-rising-days-for-a-stock%2f">
        <i class="fa fa-twitter"></i><span></span>
      </a>
    </li>
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=110" alt="" />
    
    <h4 id="about-card-name">Dimitri Fontaine</h4>
    
      <div id="about-card-bio">PostgreSQL Major Contributor</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Open Source Software Engineer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        France
      </div>
    
  </div>
</div>

    <div id="algolia-search-modal" class="modal-container">
  <div class="modal">
    <div class="modal-header">
      <span class="close-button"><i class="fa fa-close"></i></span>
      <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
        <span class="searchby-algolia-text text-color-light text-small">by</span>
        <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
      </a>
      <i class="search-icon fa fa-search"></i>
      <form id="algolia-search-form">
        <input type="text" id="algolia-search-input" name="search"
          class="form-control input--large search-input" placeholder="" />
      </form>
    </div>
    <div class="modal-body">
      <div class="no-result text-color-light text-center"></div>
      <div class="results">
        
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2019/08/the-art-of-postgresql/">
                <h3 class="media-heading">The Art Of PostgreSQL</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Aug 8, 2019
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>I did it again! Today I am releasing the new edition of my book, with a new
title: “The Art of PostgreSQL”. I&rsquo;m very happy (and quite excited) to
declare my book as <em>Generally Available</em>!</p>

<figure class="right"><a href="https://theartofpostgresql.com">
    <img src="/img/TAOPCoverTablet.png"/> </a>
</figure>


<p><a href="https://theartofpostgresql.com">The Art of PostgreSQL</a> is the new edition
of my previous release, <em>Mastering PostgreSQL in Application Development</em>.
It contains mostly fixes to the old content, a new title, and a new book
design (PDF and paperback). Content wise, <a href="https://theartofpostgresql.com">The Art of
PostgreSQL</a> also comes with a new whole
chapter about PostgreSQL Extensions.</p>

<p>The new chapter covers extensions such as <code>hstore</code>, <code>pg_trgm</code>, <code>intarray</code>,
<code>earthdistance</code>, <code>ip4r</code>, and <code>hll</code> or HyperLogLog, one of the all times
favorite extensions of <a href="http://www.craigkerstiens.com">Craig Kerstiens</a>… who
made himself available to answer my questions and share his view of
PostgreSQL Extensions in an interview!</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/11/preventing-sql-injections/">
                <h3 class="media-heading">Preventing SQL Injections</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Nov 11, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>An <em>SQL Injection</em> is a security breach, one made famous by the <a href="https://xkcd.com/327/">Exploits of
a Mom</a> <code>xkcd</code> comic episode in which we read about
<em>little Bobby Tables</em>:</p>

<figure class="center"><a href="https://xkcd.com/327/">
    <img src="/img/exploits_of_a_mom.png"/> </a>
</figure>


<p>PostgreSQL implements a protocol level facility to send the static SQL query
text separately from its dynamic arguments. An SQL injection happens when
the database server is mistakenly led to consider a dynamic argument of a
query as part of the query text. Sending those parts as separate entities
over the protocol means that SQL injection is no longer possible.</p>

<!--toc-->

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/08/geolocation-with-postgresql/">
                <h3 class="media-heading">Geolocation with PostgreSQL</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Aug 8, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>We have loaded Open Street Map points of interests in the article <a href="/blog/2013/08/the-most-popular-pub-names/">The Most
Popular Pub Names</a> — which
compares PostgreSQL with MongoDB for simple geographical queries, and is
part of our <a href="/tags/extensions/">PostgreSQL Extensions</a> article series. In
today&rsquo;s article, look at how to geolocalize an IP address and locate the
nearest pub, all within a single SQL query!</p>

<p>For that, we are going to use the awesome
<a href="https://github.com/RhodiumToad/ip4r">ip4r</a> extension from
<a href="http://blog.rhodiumtoad.org.uk/">RhodiumToad</a>.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/08/postgresql-concurrency-an-article-series/">
                <h3 class="media-heading">PostgreSQL Concurrency: an Article Series</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Aug 8, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p><a href="https://www.postgresql.org">PostgreSQL</a> is a relational database management
system. It&rsquo;s even the world&rsquo;s most advanced open source one of them. As
such, as its core, Postgres solves concurrent access to a set of data and
maintains consistency while allowing concurrent operations.</p>

<p>In the <a href="/tags/concurrency/">PostgreSQL Concurrency</a> series of articles here
we did see several aspects of how to handle concurrent use cases of your
application design with PostgreSQL. The main thing to remember is that a
Database Management System first task is to handle concurrency access to the
data for you.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/08/scheduled-data-processing-how-to-use-cron/">
                <h3 class="media-heading">Scheduled Data Processing: How to use cron?</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Aug 8, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>A previous article in the <a href="/tags/concurrency">PostgreSQL Concurrency</a> series
covered how to manage concurrent retweets in an efficient way: in <a href="/blog/2018/07/computing-and-caching/">Computing
and Caching</a>, we learnt how to
maintain a cache right in your PostgreSQL database, using MATERIALIZED
VIEWS. We also had a look at how to take care of <a href="/blog/2018/07/batch-updates-and-concurrency/">Batch Updates and
Concurrency</a>.</p>

<p>While in the first case we are providing a solution to a technical problem
where we want to solve performance issues while keeping the same semantics,
in the second case we are actually implementing a part of the application&rsquo;s
<a href="/blog/2017/06/sql-and-business-logic/">Business Logic</a> as a scheduled job.</p>

<p>Today&rsquo;s article shows a modern technique to handle the scheduling of those
business oriented activities that are not tied to any user activity. When
thinking about it this way, you certainly don&rsquo;t want to implement the
backbone of your business logic in a <em>shell script</em> that&rsquo;s directly
maintained in the production environment, do you?</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/07/batch-updates-and-concurrency/">
                <h3 class="media-heading">Batch Updates and Concurrency</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>This article fits in the <a href="/tags/concurrency">PostgreSQL Concurrency</a> series,
where we installed a tweeter like application schema and had all the
characters from Shakespeare&rsquo;s <em>A Midsummer Night&rsquo;s Dream</em> tweet their own
lines in our database in <a href="/blog/2018/06/PostgreSQL-DML.md">PostgreSQL Concurrency: Data Modification
Language</a>.</p>

<p>A previous article in the series covered how to manage concurrent retweets
in an efficient way: <a href="/blog/2018/07/computing-and-caching/">Computing and
Caching</a>, where we learn how to
maintain a cache right in your PostgreSQL database, thanks for materialized
views. We even went as far as maintaining an <em>external</em> cache in another
application layer using PostgreSQL
<a href="https://www.postgresql.org/docs/current/static/sql-listen.html">LISTEN</a> and
<a href="https://www.postgresql.org/docs/current/static/sql-notify.html">NOTIFY</a>
features and a Golang application.</p>

<p>Today&rsquo;s article is going to address concurrency in the context of updating
data in a batch. This activity is quite common, as soon as your system is
connected to other systems either internally or with external providers.
While it&rsquo;s pretty easy to ingest new data, and easy enough to update data
from an external source when nothing happens in your database, doing the
operation safely with concurrent activity is more complex. Once more though,
PostgreSQL comes with all the tooling you need to handle that situation.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/07/postgresql-listen-notify/">
                <h3 class="media-heading">PostgreSQL LISTEN/NOTIFY</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>This article fits in the <a href="/tags/concurrency">PostgreSQL Concurrency</a> series,
where we installed a tweeter like application schema and had all the
characters from Shakespeare&rsquo;s <em>A Midsummer Night&rsquo;s Dream</em> tweet their own
lines in our database in <a href="/blog/2018/06/PostgreSQL-DML.md">PostgreSQL Concurrency: Data Modification
Language</a>.</p>

<p>A previous article in the series covered how to manage concurrent retweets
in an efficient way: <a href="/blog/2018/07/computing-and-caching/">Computing and
Caching</a>, where we learn how to
maintain a cache right in your PostgreSQL database, thanks for materialized
views.</p>

<p>Today&rsquo;s article shows how to maintain an <em>external</em> cache in another
application layer. In this article we are going to maintain an in-memory
cache in a Golang service, using PostgreSQL
<a href="https://www.postgresql.org/docs/current/static/sql-listen.html">LISTEN</a> and
<a href="https://www.postgresql.org/docs/current/static/sql-notify.html">NOTIFY</a>
features.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/07/postgresql-event-based-processing/">
                <h3 class="media-heading">PostgreSQL Event Based Processing</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>In the previous article of the series <a href="/blog/2018/07/modeling-for-concurrency/">Modeling for
Concurrency</a>, we saw how to model
your application for highly concurrent activity. It was a follow-up to the
article entitled <a href="/blog/2018/07/postgresql-concurrency-isolation-and-locking/">PostgreSQL Concurrency: Isolation and
Locking</a>, which
was a primer on PostgreSQL isolation and locking properties and behaviors.</p>

<p>Today&rsquo;s article takes us a step further and builds on what we did in the
previous articles in our series. After having had all the characters from
Shakespeare&rsquo;s <em>A Midsummer Night&rsquo;s Dream</em> tweet their own lines in our
database in <a href="/blog/2018/06/PostgreSQL-DML.md">PostgreSQL Concurrency: Data Modification
Language</a>, and having had them like and
retweet a lot in <a href="/blog/2018/07/postgresql-concurrency-isolation-and-locking/">PostgreSQL Concurrency: Isolation and
Locking</a>, we
saw how to manage concurrent retweets in an efficient way in <a href="/blog/2018/07/computing-and-caching/">Computing and
Caching</a>.</p>

<p>What we did implement in the previous article is a <em>cache</em> system, all with
its necessary <strong>cache invalidation policy</strong>. Sometimes though, the
processing of an <em>event</em> needs to happen within the same transaction where
the event is registered in your system. PostgreSQL makes it possible to
maintain a summary table transactionally thanks to its
<a href="https://www.postgresql.org/docs/current/static/sql-createtrigger.html">trigger</a>
support. Today, we&rsquo;re going to dive in how to maintain a summary table with
triggers, and its impact on concurrency.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/07/computing-and-caching/">
                <h3 class="media-heading">Computing and Caching</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Let&rsquo;s continue to dive in PostgreSQL Concurrency. In the previous article of
the series, <a href="/blog/2018/07/modeling-for-concurrency/">Modeling for
Concurrency</a>, we saw how to model
your application for highly concurrent activity. It was a follow-up to the
article entitled <a href="/blog/2018/07/postgresql-concurrency-isolation-and-locking/">PostgreSQL Concurrency: Isolation and
Locking</a>, which
was a primer on PostgreSQL isolation and locking properties and behaviors.</p>

<p>Today&rsquo;s article takes us a step further and builds on what we did in the
previous articles in our series. After having had all the characters from
Shakespeare&rsquo;s <em>A Midsummer Night&rsquo;s Dream</em> tweet their own lines in our
database in <a href="/blog/2018/06/PostgreSQL-DML.md">PostgreSQL Concurrency: Data Modification
Language</a>, and having had them like a
retweet a lot in <a href="/blog/2018/07/postgresql-concurrency-isolation-and-locking/">PostgreSQL Concurrency: Isolation and
Locking</a>, it&rsquo;s
time to think about how to display our counters in an efficient way.</p>

<p>In this article, we&rsquo;re going to think about when we should compute results
and when we should cache them for instant retrieval, all within the SQL
tooling. The SQL tooling for handling cache is a <a href="https://www.postgresql.org/docs/current/static/sql-creatematerializedview.html">MATERIALIZED
VIEW</a>,
and it comes with <strong>cache invalidation</strong> routines, of course.</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://tapoueh.org/blog/2018/07/modeling-for-concurrency/">
                <h3 class="media-heading">Modeling for Concurrency</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2018
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Let&rsquo;s continue to dive in PostgreSQL Concurrency. Last week&rsquo;s article
<a href="/blog/2018/07/postgresql-concurrency-isolation-and-locking/">PostgreSQL Concurrency: Isolation and
Locking</a> was a
primer on PostgreSQL isolation and locking properties and behaviors.</p>

<p>Today&rsquo;s article takes us a step further and builds on what we did last week,
in particular the database modeling for a <em>tweet</em> like application. After
having had all the characters from Shakespeare&rsquo;s <em>A Midsummer Night&rsquo;s Dream</em>
tweet their own lines in our database in <a href="/blog/2018/06/PostgreSQL-DML.md">PostgreSQL Concurrency: Data
Modification Language</a>, it&rsquo;s time for them
to do some actions on the tweets: likes and retweet.</p>

<p>Of course, we&rsquo;re going to put concurrency to the test, so we&rsquo;re going to
have to handle very very popular tweets from the play!</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
      </div>
    </div>
    <div class="modal-footer">
      <p class="results-count text-medium"
         data-message-zero=""
         data-message-one=""
         data-message-other="">
         284 posts found
      </p>
    </div>
  </div>
</div>
    
  
    
    <div id="cover" style="background-image:url('https://tapoueh.org/images/mayan-calendar.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="/js/script-qi9wbxp2ya2j6p7wx1i6tgavftewndznf4v0hy2gvivk1rxgc3lm7njqb6bz.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/tapoueh.org\/blog\/2018\/02\/find-the-number-of-the-longest-continuously-rising-days-for-a-stock\/';
          
            this.page.identifier = '\/blog\/2018\/02\/find-the-number-of-the-longest-continuously-rising-days-for-a-stock\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'tapoueh';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  



    
  </body>
</html>

