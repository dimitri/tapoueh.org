

  
    
  


  




  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.101.0">
    <meta name="theme" content="Tranquilpeak 0.3.1-BETA">
    <title>PostgreSQL Concurrency: Isolation and Locking</title>
    <meta name="author" content="Dimitri Fontaine">
    <meta name="keywords" content="">

    <link rel="icon" href="/favicon.ico">
    

    
    <meta name="description" content="PostgreSQL is a relational database management
system. It&rsquo;s even the world&rsquo;s most advanced open source one of them. As
such, as its core, Postgres solves concurrent access to a set of data and
maintains consistency while allowing concurrent operations.
This article is a primer on PostgreSQL Isolation and Locking properties and
behaviors. You might be interested into the previous article in the series:
PostgreSQL Concurrency: Data Modification
Language.">
    <meta property="og:description" content="PostgreSQL is a relational database management
system. It&rsquo;s even the world&rsquo;s most advanced open source one of them. As
such, as its core, Postgres solves concurrent access to a set of data and
maintains consistency while allowing concurrent operations.
This article is a primer on PostgreSQL Isolation and Locking properties and
behaviors. You might be interested into the previous article in the series:
PostgreSQL Concurrency: Data Modification
Language.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="PostgreSQL Concurrency: Isolation and Locking">
    <meta property="og:url" content="https://tapoueh.org/blog/2018/07/postgresql-concurrency-isolation-and-locking/">
    <meta property="og:site_name" content="The Art of PostgreSQL">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="PostgreSQL Concurrency: Isolation and Locking">
    <meta name="twitter:description" content="PostgreSQL is a relational database management
system. It&rsquo;s even the world&rsquo;s most advanced open source one of them. As
such, as its core, Postgres solves concurrent access to a set of data and
maintains consistency while allowing concurrent operations.
This article is a primer on PostgreSQL Isolation and Locking properties and
behaviors. You might be interested into the previous article in the series:
PostgreSQL Concurrency: Data Modification
Language.">
    
      <meta name="twitter:creator" content="@tapoueh">
    
    

    
    

    
      <meta property="og:image" content="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=640">
    

    
      <meta property="og:image" content="https://tapoueh.org/img/lock-logo.png">
    
    
      <meta property="og:image" content="https://tapoueh.org/img/lockout_tagout_device1.jpg">
    
    

    

    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" />
    
    
    <link rel="stylesheet" href="/css/style-jsjn0006wyhpyzivf6yceb31gvpjatbcs3qzjvlumobfnugccvobqwxnnaj8.min.css" />
    
    
      <link rel="stylesheet" href="https://tapoueh.org/css/dim.css">
    
      <link rel="stylesheet" href="https://tapoueh.org/css/nav.css">
    

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-47059482-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="navbar-collapse collapse header-title" id="navigation">
    <ul class="nav navbar-nav navbar-right">
      
      <li class="dropdown">
        
        <a style="color: black;" href="/" alt="blog"><i class="sidebar-button-icon fa fa-lg fa-home"></i></a>
        
      </li>
      
      <li class="dropdown">
        
        <a style="color: black;" href="/conf/" alt="talks"><i class="sidebar-button-icon fa fa-lg fa-microphone"></i></a>
        
      </li>
      
      <li class="dropdown">
        
        <a style="color: black;" href="https://twitter.com/tapoueh" alt="Twitter"><i class="sidebar-button-icon fa fa-lg fa-twitter"></i></a>
        
      </li>
      
      <li class="dropdown">
        
        <a style="color: black;" href="http://theartofpostgresql.com" alt="The Art Of PostgreSQL"><i class="sidebar-button-icon fa fa-lg fa-book"></i></a>
        
      </li>
      
    </ul>
  </div>

  
    
      <a class="header-right-icon "
         href="https://theartofpostgresql.com/" target="_blank">
    
    
      <i class="fa fa-lg fa-book"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about" aria-label="">
          <img class="sidebar-profile-picture" src="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=110" alt="" />
        </a>
        <h4 class="sidebar-profile-name">Dimitri Fontaine</h4>
        
          <h5 class="sidebar-profile-bio">PostgreSQL Major Contributor</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/" title="Blog">
    
      <i class="sidebar-button-icon fa fa-lg fa-pagelines"></i>
      
      <span class="sidebar-button-desc">Blog</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/about/" title="About">
    
      <i class="sidebar-button-icon fa fa-lg fa-beer"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories/yesql/" title="YeSQL">
    
      <i class="sidebar-button-icon fa fa-lg fa-database"></i>
      
      <span class="sidebar-button-desc">YeSQL</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://theartofpostgresql.com" target="_blank" rel="noopener" title="The Art of PostgreSQL">
    
      <i class="sidebar-button-icon fa fa-lg fa-book"></i>
      
      <span class="sidebar-button-desc">The Art of PostgreSQL</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/dimitri" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/tapoueh" target="_blank" rel="noopener" title="Twitter">
    
      <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories" title="Categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      
  <div class="post-header-cover
              text-left
              post-header-cover--partial"
       style="background-image:url('/img/lockout_tagout_device1.jpg')"
       data-behavior="5">
    
      <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      PostgreSQL Concurrency: Isolation and Locking
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2018-07-03T13:30:13&#43;02:00">
        <span style="float: left; width: 35%">
          <i class="fa fa-calendar"></i> 
  
  
  
  
    Tuesday 03 Jul 2018
  

        </span>
      </time>
    
    <span style="float: right; width: 65%">
      <i class="fa fa-clock-o"></i> 7 mins read
      
    </span>
    <span style="float: left; width: 35%">
      <i class="fa fa-bookmark"></i> 
  
  
    <span></span>
    
      <a class="category-link" href="/categories/postgresql">PostgreSQL</a>, 
    
      <a class="category-link" href="/categories/yesql">YeSQL</a>
    
  

    </span>
    <div>
      <p>
        
        
        
        
        
        
        <a href="/tags/concurrency/">
          <i class="fa fa-tag"></i> Concurrency
        </a>
        
        
        
        <a href="/tags/isolation/">
          <i class="fa fa-tag"></i> Isolation
        </a>
        
        
        
        <a href="/tags/locking/">
          <i class="fa fa-tag"></i> Locking
        </a>
        
        
      </p>
    </div>
  </div>


</div>
    
  </div>


      <div id="main" data-behavior="5"
        class="hasCover
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p><a href="https://www.postgresql.org">PostgreSQL</a> is a relational database management
system. It&rsquo;s even the world&rsquo;s most advanced open source one of them. As
such, as its core, Postgres solves concurrent access to a set of data and
maintains consistency while allowing concurrent operations.</p>
<p>This article is a primer on PostgreSQL Isolation and Locking properties and
behaviors. You might be interested into the previous article in the series:
<a href="/blog/2018/06/postgresql-concurrency-data-modification-language/">PostgreSQL Concurrency: Data Modification
Language</a>.</p>
 




<div class="table-of-contents toc bd-callout">
    
    <h4 class="text-muted">Table of Contents</h4>
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/07/postgresql-concurrency-isolation-and-locking/#isolation-and-locking">
                    Isolation and Locking
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/07/postgresql-concurrency-isolation-and-locking/#transactions-and-isolation">
                    Transactions and Isolation
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/07/postgresql-concurrency-isolation-and-locking/#about-ssi">
                    About SSI
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/07/postgresql-concurrency-isolation-and-locking/#concurrent-updates-and-isolation">
                    Concurrent Updates and Isolation
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                
                
                
                <li>
                  <a href="/blog/2018/07/postgresql-concurrency-isolation-and-locking/#conclusion">
                    Conclusion
                  </a>
                </li>
                
                
                    </ul>
                
            
        
    
</div>


<h2 id="isolation-and-locking">Isolation and Locking</h2>
<p>The main feature of any database system is its implementation of concurrency
and full respect of the system&rsquo;s constraints and properties when multiple
transactions are modifying the state of the system at the same time.</p>
<p>PostgreSQL is fully <em>ACID</em> compliant and implements <em>transactions isolation</em>
so that your application&rsquo;s concurrency can be dealt with gracefully.
Concurrency is a tricky and complex problem, and concurrency issues are
often hard to reproduce. That&rsquo;s why it&rsquo;s best to rely on existing solutions
for handling concurrency rather than rolling your own.</p>
<p>Dealing with concurrency issues in programming languages usually involves
proper declaration and use of <em>lock</em>, <em>mutex</em>, and <em>semaphore</em> facilities
which make a clever use of <em>atomic</em> operations as supported by your CPU, and
sometimes provided by the operating system. Some programming languages such
as Java offer <em>synchronized</em> blocks that in turn make use of previously
listed low-level features. Other programming languages such as Erlang only
implement <em>message passing</em> facilities, and handle concurrency internally
(in a <em>mailbox</em> system) so that you don&rsquo;t have to.</p>
<p>SQL is a declarative programming language, where our role as developers is
to declare our intention: the result we want to achieve. The implementation
is then tasked with implementing our command and making it right in every
detail, including concurrency behavior.</p>
<p>PostgreSQL implementation of the concurrency behavior is dependable and
allows some user control in terms of locking aspects of your queries.</p>
<hr />
<figure class="right"><a href="https://theartofpostgresql.com"><img src="/img/TAOP_Book_Cover_200x260.png"/></a>
</figure>

<p>This article is extracted from my book <a href="https://theartofpostgresql.com">The Art of
PostgreSQL</a>, which teaches SQL to developers
so that they may replace thousands of lines of code with very simple
queries. The book has a full chapter about <em>Data Manipulation and
Concurrency Control</em> in PostgreSQL, including caching with materialized
views, check it out!</p>
<hr />
<h2 id="transactions-and-isolation">Transactions and Isolation</h2>
<p>Given the <em>ACID</em> properties, a transaction must be <em>Isolated</em> from other
concurrent transactions running in the system. It is possible to choose the
level of isolation from the concurrent activity, depending on your use case.</p>
<p>A simple use case for isolation is <em>online backups</em>. The backup application
for PostgreSQL is <em>pg_dump</em>, and the role of this application is to take a
snapshot of your whole database and export it to a backup file. This
requires that <em>pg_dump</em> reads are completely isolated from any concurrent
write activity in the system, and this is obtained with the isolation level
<em>repeatable read</em> or <em>serializable</em> as described next.</p>
<p>From PostgreSQL version 9.1 onward, <em>pg_dump</em> uses the isolation level
<em>serializable</em>. It used to be <em>repeatable read</em> until SSI implementation…
more on that later.</p>
<p><a href="https://www.postgresql.org/docs/current/static/transaction-iso.html">Transaction
isolation</a>
is defined by the SQL standard and implemented in PostgreSQL:</p>
<blockquote>
<p>The SQL standard defines four levels of transaction isolation. The most
strict is Serializable, which is defined by the standard in a paragraph
which says that any concurrent execution of a set of Serializable
transactions is guaranteed to produce the same effect as running them one
at a time in some order. The other three levels are defined in terms of
phenomena, resulting from interaction between concurrent transactions,
which must not occur at each level. The standard notes that due to the
definition of Serializable, none of these phenomena are possible at that
level. (This is hardly surprising &ndash; if the effect of the transactions
must be consistent with having been run one at a time, how could you see
any phenomena caused by interactions?)</p>
</blockquote>
<p>Still quoting the PostgreSQL documentation, here are the phenomena which are
prohibited at various levels are:</p>
<ul>
<li>
<p>Dirty read</p>
<p>A transaction reads data written by a concurrent uncommitted
transaction.</p>
</li>
<li>
<p>Nonrepeatable read</p>
<p>A transaction re-reads data it has previously read and finds that data
has been modified by another transaction (that committed since the
initial read).</p>
</li>
<li>
<p>Phantom read</p>
<p>A transaction re-executes a query returning a set of rows that satisfy a
search condition and finds that the set of rows satisfying the condition
has changed due to another recently committed transaction.</p>
</li>
<li>
<p>Serialization anomaly</p>
<p>The result of successfully committing a group of transactions is
inconsistent with all possible orderings of running those transactions
one at a time.</p>
</li>
</ul>
<p>There are four isolation levels defined by the standard: <em>read uncommitted</em>,
<em>read committed</em>, <em>repeatable read</em>, and <em>serializable</em>. PostgreSQL doesn&rsquo;t
implement <em>read uncommitted</em>, which allows <em>dirty reads</em>, and instead
defaults to <em>read committed</em>.</p>
<p>The definition of those isolation levels says that <em>read committed</em>
disallows <em>dirty read</em> anomalies, <em>repeatable read</em> disallows <em>dirty read</em>
and <em>nonrepeatable read</em>, and <em>serializable</em> disallows all anomalies.</p>
<p>PostgreSQL also disallows <em>phantom read</em> from <em>repeatable read</em> isolation
level.</p>
<h2 id="about-ssi">About SSI</h2>
<p>PostgreSQL&rsquo;s implementation of <em>serializable</em> is an amazing work. It is
described in details at the PostgreSQL wiki page entitled
<a href="https://wiki.postgresql.org/wiki/Serializable">Serializable</a>, and the wiki
page <a href="https://wiki.postgresql.org/wiki/SSI">SSI</a> contains more details about
how to use it.</p>
<p>It took about 20 years for the research community to come up with a
satisfying mathematical model for implementing <em>serializable snapshot
isolation</em> in an efficient way, and then a single year for that major
progress to be included in PostgreSQL!</p>
<h2 id="concurrent-updates-and-isolation">Concurrent Updates and Isolation</h2>
<p>In our <em>tweet</em> model of an application, we can have a look at handling
<em>retweets</em>, which is a <em>counter</em> field in the <em>tweet.message</em> table.</p>
<div class="alert success ">
  <p>The application model for Tweeting is introduced in the first article of
this series:<a href="/blog/2018/06/postgresql-concurrency-data-modification-language/">PostgreSQL Concurrency: Data Modification
Language</a>.</p>
</div>
<p>Here&rsquo;s how to make a <em>retweet</em> in our model:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a">update</span><span style="color:#bbb"> </span>tweet.message<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">   </span><span style="color:#00a">set</span><span style="color:#bbb"> </span>rts<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>rts<span style="color:#bbb"> </span>+<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span><span style="color:#00a">where</span><span style="color:#bbb"> </span>messageid<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#099">1</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Now, what happens if two users are doing that at the same time?</p>
<p>To better understand what <em>at the same time</em> means here, we can write the
query extended with manual transaction control, as PostgreSQL will do when
sent a single command without an explicit transaction:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a">begin</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">   </span><span style="color:#00a">update</span><span style="color:#bbb"> </span>tweet.message<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#00a">set</span><span style="color:#bbb"> </span>rts<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>rts<span style="color:#bbb"> </span>+<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#00a">where</span><span style="color:#bbb"> </span>messageid<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#099">1</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>returning<span style="color:#bbb"> </span>messageid,<span style="color:#bbb"> </span>rts;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#00a">commit</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Now, rather than doing this query, we open a <em>psql</em> prompt and send in:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a">begin</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">   </span><span style="color:#00a">update</span><span style="color:#bbb"> </span>tweet.message<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#00a">set</span><span style="color:#bbb"> </span>rts<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>rts<span style="color:#bbb"> </span>+<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#00a">where</span><span style="color:#bbb"> </span>messageid<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>returning<span style="color:#bbb"> </span>messageid,<span style="color:#bbb"> </span>rts;<span style="color:#bbb">
</span></span></span></code></pre></div><p>We get the following result now:</p>
<pre tabindex="0"><code class="language-psql" data-lang="psql"> messageid │ rts 
═══════════╪═════
         1 │   2
(1 row)
</code></pre><p>The transaction remains open (it&rsquo;s <em>idle in transaction</em>) and waits for us
to do something else, or maybe <em>commit</em> or <em>rollback</em> the transaction.</p>
<p>Now, open a second <em>psql</em> prompt and send in the exact same query. This time
the <em>update</em> doesn&rsquo;t return. There&rsquo;s no way it could: the first transaction
is not done yet and is working on the row where <em>messageid = 1</em>. Until the
first transaction is done, no concurrent activity can take place on this
specific row.</p>
<p>So we go back to the first prompt and <em>commit</em>.</p>
<p>Then what happens depends on the <em>isolation level</em> required. Here we have
the default isolation level <em>read committed</em>, and at the second prompt the
<em>update</em> command is unlocked and proceeds to immediately return:</p>
<pre tabindex="0"><code class="language-psql" data-lang="psql"> messageid │ rts 
═══════════╪═════
         1 │   3
(1 row)
</code></pre><p>Now for the following examples, we need to review our <em>psql</em> setting for the
<em>ON_ERROR_ROLLBACK</em> feature. When set to <em>true</em> or <em>interactive</em>, then
<em>psql</em> issues
<a href="https://www.postgresql.org/docs/current/static/sql-rollback-to.html">savepoints</a>
to protect each outer transaction state, and that will hide what we&rsquo;re
showing next. Type the following command to momentarily disable this helpful
setting, so that we can see what really happens:</p>
<pre tabindex="0"><code>\set ON_ERROR_ROLLBACK off
</code></pre><p>If we pick the isolation level <em>repeatable read</em>, with the following syntax:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a">start</span><span style="color:#bbb"> </span><span style="color:#00a">transaction</span><span style="color:#bbb"> </span><span style="color:#00a">isolation</span><span style="color:#bbb"> </span><span style="color:#00a">level</span><span style="color:#bbb"> </span><span style="color:#00a">repeatable</span><span style="color:#bbb"> </span><span style="color:#00a">read</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">   </span><span style="color:#00a">update</span><span style="color:#bbb"> </span>tweet.message<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#00a">set</span><span style="color:#bbb"> </span>rts<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>rts<span style="color:#bbb"> </span>+<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#00a">where</span><span style="color:#bbb"> </span>messageid<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>returning<span style="color:#bbb"> </span>messageid,<span style="color:#bbb"> </span>rts;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Again, we leave the transaction open, switch to a second prompt and do the
same thing, and only then — while the second update is waiting for the first
transaction to finish — commit the first transactions. What we get this time
is this:</p>
<pre tabindex="0"><code class="language-psql" data-lang="psql">ERROR:  could not serialize access due to concurrent update

yesql!# commit;
ROLLBACK
</code></pre><p>Also notice that even if we ask for a <em>COMMIT</em>, what we get is a <em>ROLLBACK</em>.
Once an error occurs in a transaction, in PostgreSQL, the transaction can&rsquo;t
commit anymore.</p>
<p>When using the isolation level <em>serializable</em>, the same behavior as for
<em>repeatable read</em> is observed, with exactly the same error message exactly.</p>
<h2 id="conclusion">Conclusion</h2>
<p>PostgreSQL is an advanced RDBMS, with a solid foundation. The main service
PostgreSQL implements to its users is a correct handling of concurrent
operations. In the SQL model, that means handling both transactions and
isolation levels.</p>
<p>The next article in this series is going to show how to model your database
schema to make it a better fit for high concurrent updates, stay tuned!</p>
              


            </div>
          </div>
          





<div style="margin-top: 1em;">
 <script async src="//tinder.thrivecart.com/embed/v1/thrivecart.js"></script>
 <a data-thrivecart-account="theartofpostgresql" data-thrivecart-tpl="v2" data-thrivecart-product="18" class="thrivecart-button ">
  <img src="https://spark.thrivecart.com/0x0/https%3A%2F%2Fthrivecart.s3.amazonaws.com%2Fuser_assets%2FNABJ5K7H%2Fproducts%2F18%2Ftaopg-cta-1661268188.jpg"
       style="width:90%; height: auto; margin-left: 5%"/>
 </a>
</div>

          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small"></span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/postgresql/">PostgreSQL</a>

  <a class="tag tag--primary tag--small" href="/tags/yesql/">YeSQL</a>

  <a class="tag tag--primary tag--small" href="/tags/concurrency/">Concurrency</a>

  <a class="tag tag--primary tag--small" href="/tags/isolation/">Isolation</a>

  <a class="tag tag--primary tag--small" href="/tags/locking/">Locking</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
 <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2018/07/modeling-for-concurrency/" data-tooltip="Modeling for Concurrency">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml"></span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2018/06/postgresql-concurrency-data-modification-language/" data-tooltip="PostgreSQL Concurrency: Data Modification Language">
          
            <span class="hide-xs hide-sm text-small icon-mr"></span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f07%2fpostgresql-concurrency-isolation-and-locking%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f07%2fpostgresql-concurrency-isolation-and-locking%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=PostgreSQL%20Concurrency%3a%20Isolation%20and%20Locking with @tapoueh: https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f07%2fpostgresql-concurrency-isolation-and-locking%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#table-of-contents">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2022 Dimitri Fontaine. 
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        <div class="post-actions-wrap">
 <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2018/07/modeling-for-concurrency/" data-tooltip="Modeling for Concurrency">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml"></span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2018/06/postgresql-concurrency-data-modification-language/" data-tooltip="PostgreSQL Concurrency: Data Modification Language">
          
            <span class="hide-xs hide-sm text-small icon-mr"></span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f07%2fpostgresql-concurrency-isolation-and-locking%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f07%2fpostgresql-concurrency-isolation-and-locking%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=PostgreSQL%20Concurrency%3a%20Isolation%20and%20Locking with @tapoueh: https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f07%2fpostgresql-concurrency-isolation-and-locking%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#table-of-contents">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <ul class="share-options">
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f07%2fpostgresql-concurrency-isolation-and-locking%2f">
        <i class="fa fa-google-plus"></i><span></span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f07%2fpostgresql-concurrency-isolation-and-locking%2f">
        <i class="fa fa-facebook-official"></i><span></span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=PostgreSQL%20Concurrency%3a%20Isolation%20and%20Locking with @tapoueh: https%3a%2f%2ftapoueh.org%2fblog%2f2018%2f07%2fpostgresql-concurrency-isolation-and-locking%2f">
        <i class="fa fa-twitter"></i><span></span>
      </a>
    </li>
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=110" alt="" />
    
    <h4 id="about-card-name">Dimitri Fontaine</h4>
    
      <div id="about-card-bio">PostgreSQL Major Contributor</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Open Source Software Engineer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        France
      </div>
    
  </div>
</div>

    

    
  
    
      
      <div id="cover" style="background-image:url('https://tapoueh.org/images/mayan-calendar.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://tapoueh.org/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

