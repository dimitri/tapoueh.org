<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset=utf-8 /> 
    <meta name=viewport content="width=device-width" /> 
    <meta name="generator" content="Emacs Muse Blog" /> 
    <meta description="blog de Dimitri Fontaine, Expert PostgreSQL - 2ndQuadrant France" />
    <meta property="og:title" content="tapoueh.org"/>
    <meta property="og:type" content="non_profit"/>
    <meta property="og:url" content="http://tapoueh.org/blog/2011/05/04-tables-and-views-dependencies.html"/>
    <meta property="og:image" content="http://tapoueh.org/static/2ndQuadrant-cross.png"/>
    <meta property="og:site_name" content="Tapoueh"/>
    <meta property="fb:admins" content="545062436"/>

    <title>Expertise PostgreSQL</title>
    <link rel='stylesheet' type='text/css' media='all' href='../../../static/styles.css' />
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/bootstrap/css/bootstrap.min.css' />
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/FontAwesome/css/font-awesome.min.css' />

    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/highlight.js/styles/sunburst.css' />
    <script type='text/javascript' src='../../../static/highlight.js/highlight.pack.js'></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script type='text/javascript' src='../../../static/jquery-1.9.1.min.js'></script>
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/jqcloud.css' />
    <script type='text/javascript' src='../../../static/jqcloud-1.0.4.min.js'></script>

    <!-- <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/static/FontAwesome/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="/static/highlight.js/styles/sunburst.css">
    <script src="/static/highlight.js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script src="/static/jquery-1.9.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/jqcloud.css" />
    <script type="text/javascript" src="/static/jqcloud-1.0.4.min.js"></script>
    -->

    <script type="text/javascript" src="http://apis.google.com/js/plusone.js">{lang: 'fr'}</script>
    
  </head>
  <body>

   <div id="wrap">

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="nav-collapse collapse">
	<p class="pull-right">
	  <a href="http://2ndquadrant.com">
	    <img alt="logo" src="/static/2ndQuadrant-cross.png"
		 style="margin-right: 8px; margin-top: 4px; height: 32px;"/>
	  </a>
	</p>
	<div class="navbar-inner">
	 <a class="brand" style="margin-left: 0.2em; margin-top: -4px;"
	    href="http://expert-postgresql.fr/">
	  <img src="/static/expert-postgresql.png"></a>
	 <ul class="nav">
	   <li><a href="../../../blog/index.html">
               <i class="icon-book"></i> blog</a>
           </li>
	   <li><a href="../../../projects.html">
               <i class="icon-suitcase"></i> projects</a>
           </li>
	   <li><a href="../../../conferences.html">
               <i class="icon-plane"></i> confs</a>
           </li>
	   <li><a href="../../../about.html">
               <i class="icon-beer"></i> about</a>
           </li>
	   <li><a href="../../../rss/tapoueh.xml">
               <i class="icon-rss"></i> rss</a>
           </li>
	 </ul>
	</div>
      </div>
    </div>

    <div class="container">
      <div class="row">
	<div class="span4">
	  <div><ul class='breadcrumb'><li><span class='divider'><i class='icon-sitemap'></i></span></li><li><a href='../../../'>/dev/dim</a><span class='divider'>/</span></li><li><a href='../../../blog'>blog</a><span class='divider'>/</span></li><li><a href='../../../blog/2011'>2011</a><span class='divider'>/</span></li><li><a href='../../../blog/2011/05'>05</a></li></ul></div>
	  <div class='date'>Wednesday, May 04 2011 <i class='icon-calendar'></i></div>
	  <div style='text-align: right;'><span><a href='../../../tags/postgresql'>PostgreSQL</a>, <a href='../../../tags/catalogs'>catalogs</a>, <a href='../../../tags/yesql'>YeSQL</a></span> <i class='icon-tags'></i></div>
	  

	  <div style="margin-top: 1em;">
	    <div class='span2 pull-left'><a class='thumbnail' href='../../../tags/catalogs'><img class='img-polaroid' style='width: 160px; height: 120px;' src='../../../thumbnails/library-card-catalogs.small.jpg' /></a></div>
	    <div id='social' class='span1 pull-right social'><ul><li><g:plusone size='tall' href='http://tapoueh.org/blog/2011/05/04-tables-and-views-dependencies'></g:plusone></li><li><a href='http://twitter.com/share' class='twitter-share-button' data-via='tapoueh' data-count='vertical'>Tweet</a><script type='text/javascript' src='http://platform.twitter.com/widgets.js'></script></li></ul></div>
	  </div>

	  <div id="prevnext">
	    <h3 class='prevnext'>Recent Articles</h3>
	    <div><a class='previous' href='../../../blog/2011/05/02-extension-module_pathname-and-sqlin.html'>« Extension module_pathname and .sql.in</a></div>
	    <div><a class='next pull-right' href='../../../blog/2011/05/05-mailq-modeline-display.html'>Mailq modeline display »</a></div>
	  </div>
	  
	  <div>
	    <div id="left-tag-cloud" class="jqcloud"
		 style="width: 300px; height: 650px; position: absolute; top: 475px;">
	    </div>
            <script>
            var word_list;
            
            $.ajax({
                type: 'GET',
                url: '/cloud.json',
                dataType: 'json',
                success: function(response) { word_list = response; },
                data: {},
                async: false
            });
             
            $(document).ready(function() {
               $("#left-tag-cloud").jQCloud(word_list,
	                {shape: "rectangular",
	                 removeOverflowing: false});
            });
            </script>
	  </div>

	</div>

	<div id="title" class="span8">
	  <h1>Tables and Views dependencies</h1>
	</div>
	
	<div id="content" class="span8">
<p>Let's say you need to 
<code>ALTER TABLE foo ALTER COLUMN bar TYPE bigint;</code>, and
<a href='http://postgresql.org'>PostgreSQL</a> is helpfully telling you that no you can't because such and such
<em>views</em> depend on the column.  The basic way to deal with that is to copy
paste from the error message the names of the views involved, then prepare a
script wherein you first 
<code>DROP VIEW ...;</code> then 
<code>ALTER TABLE</code> and finally 
<code>CREATE
VIEW</code> again, all in the same transaction.
</p><center><img src='../../../images/stunning-view-table-mansion.jpg' /></center><center><em>A nice view from this table...</em></center><p>So you have to copy paste also the view definitions.  With large view
definitions, it quickly gets cumbersome to do so.  Well when you're working
on operations, you have to bear in mind that cumbersome is a synonym for
<em>error prone</em>, in fact — so you want another solution if possible.
</p><p>Oh, and the other drawback of this solution is that 
<code>ALTER TABLE</code> will first
take a 
<code>LOCK</code> on the table, locking out any activity.  And more than that, the
lock acquisition will queue behind current activity on the table, which
means waiting for a fairly long time and damaging the service quality on a
moderately loaded server.
</p><p>It's possible to abuse the 
<a href='http://www.postgresql.org/docs/current/static/catalogs.html'>system catalogs</a> in order to find all 
<em>views</em> that
depend on a given table, too.  For that, you have to play with 
<code>pg_depend</code> and
you have to know that internally, a 
<em>view</em> is in fact a 
<em>rewrite rule</em>.  Then
here's how to produce the two scripts that we need:
</p><pre><code>=# \t
Showing only tuples.

=# \o /tmp/drop.sql
=# select &#039;DROP VIEW &#039; || views || &#039;;&#039;
     from (select distinct(r.ev_class::regclass) as views
            from pg_depend d join pg_rewrite r on r.oid = d.objid 
           where refclassid = &#039;pg_class&#039;::regclass
             and refobjid = &#039;SCHEMA.TABLENAME&#039;::regclass
             and classid = &#039;pg_rewrite&#039;::regclass 
             and pg_get_viewdef(r.ev_class, true) ~ &#039;COLUMN_NAME&#039;) as x;

=# \o /tmp/create.sql
=# select &#039;CREATE VIEW &#039; || views || E&#039; AS \n&#039;
       || pg_get_viewdef(views, true) || &#039;;&#039; 
     from (select distinct(r.ev_class::regclass) as views 
          from pg_depend d join pg_rewrite r on r.oid = d.objid
         where refclassid = &#039;pg_class&#039;::regclass
           and refobjid = &#039;SCHEMA.TABLENAME&#039;::regclass
           and classid = &#039;pg_rewrite&#039;::regclass
           and pg_get_viewdef(r.ev_class, true) ~ &#039;COLUMN_NAME&#039;) as x;

=# \o
</code></pre><p>Replace 
<code>SCHEMA.TABLENAME</code> and 
<code>COLUMN_NAME</code> with your targets here and the
first query should give you one row per candidate view.  Well if you're not
using the 
<code>\o</code> trick, that is — if you do, check out the generated file
instead, with 
<code>\! cat /tmp/drop.sql</code> for example.
</p><p>Please note that this catalog query is not accurate, as it will select as a
candidate any view that will by chance both depend on the target table and
contain the 
<code>column_name</code> in its text definition.  So either filter out the
candidates properly (by proper proof reading then another 
<code>WHERE</code> clause), or
just accept that you might 
<code>DROP</code> then 
<code>CREATE</code> again more 
<em>views</em> than need be.
</p><p>If you need some more details about the 
<code>\t \o</code> sequence you might be
interested in this older article about 
<a href='http://tapoueh.org/articles/blog/_Resetting_sequences._All_of_them,_please!.html'>resetting sequences</a>.
</p>  </div>
  </div>
  </div>
  <div id="push"></div>
  </div>

<footer>
  <p>
    <small>Unless otherwise specified, the contents of
    <a href=../../../index.html>this website</a> are Copyright
    &#169;&#160; 2008-2013 <a href=/about>Dimitri Fontaine</a>, and are
    licensed for use under
    <a href=http://creativecommons.org/licenses/by-sa/3.0/
    rel=license><abbr title="Creative
    Commons">CC</abbr>&#160;<abbr title=Attribution>BY</abbr>-<abbr title=Share-Alike>SA</abbr>&#160;3.0</a>.</small>
  </p> 
</footer> 

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-47059482-1', 'tapoueh.org');
  ga('send', 'pageview');

</script>

</body>
</html>
