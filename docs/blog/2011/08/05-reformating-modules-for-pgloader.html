<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset=utf-8 /> 
    <meta name=viewport content="width=device-width" /> 
    <meta name="generator" content="Emacs Muse Blog" /> 
    <meta description="blog de Dimitri Fontaine, Expert PostgreSQL - 2ndQuadrant France" />
    <meta property="og:title" content="tapoueh.org"/>
    <meta property="og:type" content="non_profit"/>
    <meta property="og:url" content="http://tapoueh.org/blog/2011/08/05-reformating-modules-for-pgloader.html"/>
    <meta property="og:image" content="http://tapoueh.org/static/2ndQuadrant-cross.png"/>
    <meta property="og:site_name" content="Tapoueh"/>
    <meta property="fb:admins" content="545062436"/>

    <title>Expertise PostgreSQL</title>
    <link rel='stylesheet' type='text/css' media='all' href='../../../static/styles.css' />
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/bootstrap/css/bootstrap.min.css' />
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/FontAwesome/css/font-awesome.min.css' />

    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/highlight.js/styles/sunburst.css' />
    <script type='text/javascript' src='../../../static/highlight.js/highlight.pack.js'></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script type='text/javascript' src='../../../static/jquery-1.9.1.min.js'></script>
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/jqcloud.css' />
    <script type='text/javascript' src='../../../static/jqcloud-1.0.4.min.js'></script>

    <!-- <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/static/FontAwesome/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="/static/highlight.js/styles/sunburst.css">
    <script src="/static/highlight.js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script src="/static/jquery-1.9.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/jqcloud.css" />
    <script type="text/javascript" src="/static/jqcloud-1.0.4.min.js"></script>
    -->

    <script type="text/javascript" src="http://apis.google.com/js/plusone.js">{lang: 'fr'}</script>
    
  </head>
  <body>

   <div id="wrap">

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="nav-collapse collapse">
	<p class="pull-right">
	  <a href="http://2ndquadrant.com">
	    <img alt="logo" src="/static/2ndQuadrant-cross.png"
		 style="margin-right: 8px; margin-top: 4px; height: 32px;"/>
	  </a>
	</p>
	<div class="navbar-inner">
	 <a class="brand" style="margin-left: 0.2em; margin-top: -4px;"
	    href="http://expert-postgresql.fr/">
	  <img src="/static/expert-postgresql.png"></a>
	 <ul class="nav">
	   <li><a href="../../../blog/index.html">
               <i class="icon-book"></i> blog</a>
           </li>
	   <li><a href="../../../projects.html">
               <i class="icon-suitcase"></i> projects</a>
           </li>
	   <li><a href="../../../conferences.html">
               <i class="icon-plane"></i> confs</a>
           </li>
	   <li><a href="../../../about.html">
               <i class="icon-beer"></i> about</a>
           </li>
	   <li><a href="../../../rss/tapoueh.xml">
               <i class="icon-rss"></i> rss</a>
           </li>
	 </ul>
	</div>
      </div>
    </div>

    <div class="container">
      <div class="row">
	<div class="span4">
	  <div><ul class='breadcrumb'><li><span class='divider'><i class='icon-sitemap'></i></span></li><li><a href='../../../index.html'>/dev/dim</a><span class='divider'>/</span></li><li><a href='../../../blog/index.html'>blog</a><span class='divider'>/</span></li><li><a href='../../../blog/2011/index.html'>2011</a><span class='divider'>/</span></li><li><a href='../../../blog/2011/08/index.html'>08</a></li></ul></div>
	  <div class='date'>Friday, August 05 2011 <i class='icon-calendar'></i></div>
	  <div style='text-align: right;'><span><a href='../../../tags/postgresql'>PostgreSQL</a>, <a href='../../../tags/pgloader'>pgloader</a></span> <i class='icon-tags'></i></div>
	  

	  <div style="margin-top: 1em;">
	    <div class='span2 pull-left'><a class='thumbnail' href='../../../tags/pgloader.html'><img class='img-polaroid' style='width: 160px; height: 120px;' src='../../../thumbnails/toy-loader.320.jpg' /></a></div>
	    <div id='social' class='span1 pull-right social'><ul><li><g:plusone size='tall' href='http://tapoueh.org/blog/2011/08/05-reformating-modules-for-pgloader'></g:plusone></li><li><a href='http://twitter.com/share' class='twitter-share-button' data-via='tapoueh' data-count='vertical'>Tweet</a><script type='text/javascript' src='http://platform.twitter.com/widgets.js'></script></li></ul></div>
	  </div>

	  <div id="prevnext">
	    <h3 class='prevnext'>Recent Articles</h3>
	    <div><a class='previous' href='../../../blog/2011/08/05-reformater-avec-pgloader.html'>« Reformater avec pgloader</a></div>
	    <div><a class='next pull-right' href='../../../blog/2011/08/06-emacs-startup-notification.html'>Emacs Startup »</a></div>
	  </div>
	  
	  <div>
	    <div id="left-tag-cloud" class="jqcloud"
		 style="width: 300px; height: 650px; position: absolute; top: 475px;">
	    </div>
            <script>
            var word_list;
            
            $.ajax({
                type: 'GET',
                url: '/cloud.json',
                dataType: 'json',
                success: function(response) { word_list = response; },
                data: {},
                async: false
            });
             
            $(document).ready(function() {
               $("#left-tag-cloud").jQCloud(word_list,
	                {shape: "rectangular",
	                 removeOverflowing: false});
            });
            </script>
	  </div>

	</div>

	<div id="title" class="span8">
	  <h1>pgloader reformating</h1>
	</div>
	
	<div id="content" class="span8">
<p>Back to our series about 
<a href='../../../pgsql/pgloader.html'>pgloader</a>.  The previous articles detailed
<a href='http://tapoueh.org/blog/2011/07/22-how-to-use-pgloader.html'>How To Use PgLoader</a> then 
<a href='http://tapoueh.org/blog/2011/07/29-how-to-setup-pgloader.html'>How to Setup pgloader</a>, then what to expect from a
<a href='http://tapoueh.org/blog/2011/08/01-parallel-pgloader.html'>parallel pgloader</a> setup.  This article will detail how to 
<em>reformat</em> input
columns so that what 
<a href='http://www.postgresql.org/'>PostgreSQL</a> sees is not what's in the data file, but the
result of a 
<em>transformation</em> from this data into something acceptable as an
<em>input</em> for the target data type.
</p><p>Here's what the 
<a href='http://pgloader.projects.postgresql.org/'>pgloader documentation</a> has to say about this 
<em>reformat</em>
parameter: 
<em>The value of this option is a comma separated list of columns to
rewrite, which are a colon separated list of column name, reformat module
name, reformat function name</em>.
</p><p>And here's the 
<a href='https://github.com/dimitri/pgloader/blob/master/examples/pgloader.conf'>examples/pgloader.conf</a> section that deals with reformat:
</p><pre><code>[reformat]
table           = reformat
format          = text
filename        = reformat/reformat.data
field_sep       = |
columns         = id, timestamp
reformat        = timestamp:mysql:timestamp
</code></pre><p>The documentation says some more about it, so check it out.  Also, the
<code>reformat_path</code> option (set either on the command line or in the configuration
file) is used to find the python module implementing the reformat function.
Please refer to the manual as to how to set it.
</p><p>Now, obviously, for the 
<em>reformat</em> to happen we need to write some code.
That's the whole point of the option: you need something very specific, you
are in a position to write the 5 lines of code needed to make it happen,
<a href='http://tapoueh.org/pgsql/pgloader.html'>pgloader</a> allows you to just do that.  Of course, the code needs to be
written in python here, so that you can even benefit from the
<a href='http://tapoueh.org/blog/2011/08/01-parallel-pgloader.html'>parallel pgloader</a> settings.
</p><p>Let's see an reformat module exemple, as found in 
<a href='https://github.com/dimitri/pgloader/blob/master/reformat/mysql.py'>reformat/mysql.py</a> in the
<code>pgloader</code> sources:
</p><pre><code># Author: Dimitri Fontaine &lt;dim@tapoueh.org&gt;
#
# pgloader mysql reformating module
#

def timestamp(reject, input):
    &quot;&quot;&quot; Reformat str as a PostgreSQL timestamp

    MySQL timestamps are like:  20041002152952
    We want instead this input: 2004-10-02 15:29:52
    &quot;&quot;&quot;
    if len(input) != 14:
        e = &quot;MySQL timestamp reformat input too short: %s&quot; % input
        reject.log(e, input)
    
    year    = input[0:4]
    month   = input[4:6]
    day     = input[6:8]
    hour    = input[8:10]
    minute  = input[10:12]
    seconds = input[12:14]
    
    return &#039;%s-%s-%s %s:%s:%s&#039; % (year, month, day, hour, minute, seconds)
</code></pre><p>This reformat module will 
<em>transform</em> a 
<code>timestamp</code> representation as issued by
certain versions of MySQL into something that PostgreSQL is able to read as
a timestamp.
</p><p>If you're in the camp that wants to write as little code as possible rather
than easy to read and maintain code, I guess you could write it this way
instead:
</p><pre><code>import re
def timestamp(reject, input):
    &quot;&quot;&quot; 20041002152952 -&gt; 2004-10-02 15:29:52 &quot;&quot;&quot;
    g = re.match(r&quot;(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})&quot;, input)
    return &#039;%s-%s-%s %s:%s:%s&#039; % tuple([g.group(x+1) for x in range(6)])
</code></pre><p>Whenever you have an input file with data that PostgreSQL chokes upon, you
can solve this problem from 
<a href='http://tapoueh.org/pgsql/pgloader.html'>pgloader</a> itself: no need to resort to scripting
and a pipelines of 
<a href='http://www.gnu.org/software/gawk/manual/gawk.html'>awk</a> (which I use a lot in other cases, don't get me
wrong) or other tools.  See, you finally have an excuse to 
<a href='http://diveintopython.org/'>Dive into Python</a>!
</p>  </div>
  </div>
  </div>
  <div id="push"></div>
  </div>

<footer>
  <p>
    <small>Unless otherwise specified, the contents of
    <a href=../../../index.html>this website</a> are Copyright
    &#169;&#160; 2008-2013 <a href=/about>Dimitri Fontaine</a>, and are
    licensed for use under
    <a href=http://creativecommons.org/licenses/by-sa/3.0/
    rel=license><abbr title="Creative
    Commons">CC</abbr>&#160;<abbr title=Attribution>BY</abbr>-<abbr title=Share-Alike>SA</abbr>&#160;3.0</a>.</small>
  </p> 
</footer> 

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-47059482-1', 'tapoueh.org');
  ga('send', 'pageview');

</script>

</body>
</html>
