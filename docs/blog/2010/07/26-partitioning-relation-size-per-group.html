<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset=utf-8 /> 
    <meta name=viewport content="width=device-width" /> 
    <meta name="generator" content="Emacs Muse Blog" /> 
    <meta description="blog de Dimitri Fontaine, Expert PostgreSQL - 2ndQuadrant France" />
    <meta property="og:title" content="tapoueh.org"/>
    <meta property="og:type" content="non_profit"/>
    <meta property="og:url" content="http://tapoueh.org/blog/2010/07/26-partitioning-relation-size-per-group.html"/>
    <meta property="og:image" content="http://tapoueh.org/static/2ndQuadrant-cross.png"/>
    <meta property="og:site_name" content="Tapoueh"/>
    <meta property="fb:admins" content="545062436"/>

    <title>Expertise PostgreSQL</title>
    <link rel='stylesheet' type='text/css' media='all' href='../../../static/styles.css' />
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/bootstrap/css/bootstrap.min.css' />
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/FontAwesome/css/font-awesome.min.css' />

    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/highlight.js/styles/sunburst.css' />
    <script type='text/javascript' src='../../../static/highlight.js/highlight.pack.js'></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script type='text/javascript' src='../../../static/jquery-1.9.1.min.js'></script>
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/jqcloud.css' />
    <script type='text/javascript' src='../../../static/jqcloud-1.0.4.min.js'></script>

    <!-- <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/static/FontAwesome/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="/static/highlight.js/styles/sunburst.css">
    <script src="/static/highlight.js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script src="/static/jquery-1.9.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/jqcloud.css" />
    <script type="text/javascript" src="/static/jqcloud-1.0.4.min.js"></script>
    -->

    <script type="text/javascript" src="http://apis.google.com/js/plusone.js">{lang: 'fr'}</script>
    
  </head>
  <body>

   <div id="wrap">

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="nav-collapse collapse">
	<p class="pull-right">
	  <a href="http://2ndquadrant.com">
	    <img alt="logo" src="/static/2ndQuadrant-cross.png"
		 style="margin-right: 8px; margin-top: 4px; height: 32px;"/>
	  </a>
	</p>
	<div class="navbar-inner">
	 <a class="brand" style="margin-left: 0.2em; margin-top: -4px;"
	    href="http://expert-postgresql.fr/">
	  <img src="/static/expert-postgresql.png"></a>
	 <ul class="nav">
	   <li><a href="../../../blog/index.html">
               <i class="icon-book"></i> blog</a>
           </li>
	   <li><a href="../../../projects.html">
               <i class="icon-suitcase"></i> projects</a>
           </li>
	   <li><a href="../../../conferences.html">
               <i class="icon-plane"></i> confs</a>
           </li>
	   <li><a href="../../../about.html">
               <i class="icon-beer"></i> about</a>
           </li>
	   <li><a href="../../../rss/tapoueh.xml">
               <i class="icon-rss"></i> rss</a>
           </li>
	 </ul>
	</div>
      </div>
    </div>

    <div class="container">
      <div class="row">
	<div class="span4">
	  <div><ul class='breadcrumb'><li><span class='divider'><i class='icon-sitemap'></i></span></li><li><a href='../../../index.html'>/dev/dim</a><span class='divider'>/</span></li><li><a href='../../../blog/index.html'>blog</a><span class='divider'>/</span></li><li><a href='../../../blog/2010/index.html'>2010</a><span class='divider'>/</span></li><li><a href='../../../blog/2010/07/index.html'>07</a></li></ul></div>
	  <div class='date'>Monday, July 26 2010 <i class='icon-calendar'></i></div>
	  <div style='text-align: right;'><span><a href='../../../tags/postgresql'>PostgreSQL</a>, <a href='../../../tags/catalogs'>Catalogs</a>, <a href='../../../tags/yesql'>YeSQL</a></span> <i class='icon-tags'></i></div>
	  

	  <div style="margin-top: 1em;">
	    <div class='span2 pull-left'><a class='thumbnail' href='../../../tags/catalogs.html'><img class='img-polaroid' style='width: 160px; height: 120px;' src='../../../thumbnails/library-card-catalogs.small.jpg' /></a></div>
	    <div id='social' class='span1 pull-right social'><ul><li><g:plusone size='tall' href='http://tapoueh.org/blog/2010/07/26-partitioning-relation-size-per-group'></g:plusone></li><li><a href='http://twitter.com/share' class='twitter-share-button' data-via='tapoueh' data-count='vertical'>Tweet</a><script type='text/javascript' src='http://platform.twitter.com/widgets.js'></script></li></ul></div>
	  </div>

	  <div id="prevnext">
	    <h3 class='prevnext'>Recent Articles</h3>
	    <div><a class='previous' href='../../../blog/2010/07/26-dim-switch-windowel-fixes.html'>« dim-switch-window.el: fixes</a></div>
	    <div><a class='next pull-right' href='../../../blog/2010/08/03-database-virtual-machines.html'>Database Virtual Machines »</a></div>
	  </div>
	  
	  <div>
	    <div id="left-tag-cloud" class="jqcloud"
		 style="width: 300px; height: 650px; position: absolute; top: 475px;">
	    </div>
            <script>
            var word_list;
            
            $.ajax({
                type: 'GET',
                url: '/cloud.json',
                dataType: 'json',
                success: function(response) { word_list = response; },
                data: {},
                async: false
            });
             
            $(document).ready(function() {
               $("#left-tag-cloud").jQCloud(word_list,
	                {shape: "rectangular",
	                 removeOverflowing: false});
            });
            </script>
	  </div>

	</div>

	<div id="title" class="span8">
	  <h1>Partitioning: relation size per “group”</h1>
	</div>
	
	<div id="content" class="span8">
<p>This time, we are trying to figure out where is the bulk of the data on
disk. The trick is that we're using 
<a href='http://www.postgresql.org/docs/current/static/ddl-partitioning.html'>DDL partitioning</a>, but we want a “nice”
view of size per 
<em>partition set</em>. Meaning that if you have for example a
parent table 
<code>foo</code> with partitions 
<code>foo_201006</code> and 
<code>foo_201007</code>, you would want
to see a single category 
<code>foo</code> containing the accumulated size of all the
partitions underneath 
<code>foo</code>.
</p><center><img src='../../../images/repart-shapeopt.png' /></center><p>Here we go:
</p><pre><code>select groupe, pg_size_pretty(sum(bytes)::bigint) as size, sum(bytes)
  from (
select relkind as k, nspname, relname, tablename, bytes,
         case when relkind = &#039;r&#039; and relname ~ &#039;[0-9]{6}$&#039;
              then substring(relname from 1 for length(relname)-7)

	      when relkind = &#039;i&#039; and  tablename ~ &#039;[0-9]{6}$&#039;
              then substring(tablename from 1 for length(tablename)-7)

              else &#039;core&#039; 
          end as groupe
  from (
  select nspname, relname,
         case when relkind = &#039;i&#039;
              then (select relname
                      from pg_index x 
                           join pg_class xc on x.indrelid = xc.oid
                           join pg_namespace xn on xc.relnamespace = xn.oid
                     where x.indexrelid = c.oid
                    )
              else null
           end as tablename,
         pg_size_pretty(pg_relation_size(c.oid)) as relation,
         pg_total_relation_size(c.oid) as bytes,
	 relkind
    from pg_class c join pg_namespace n on c.relnamespace = n.oid 
   where c.relkind in (&#039;r&#039;, &#039;i&#039;) 
         and nspname in (&#039;public&#039;, &#039;archive&#039;)
         and pg_total_relation_size(c.oid) &gt; 32 * 1024
order by 5 desc
       ) as s
       ) as t
group by 1
order by 3 desc;
</code></pre><p>Note that by simply removing those last two lines here, you will get a
detailed view of the 
<em>indexes</em> and 
<em>tables</em> that are taking the most volume on
disk at your place.
</p><p>Now, what about using 
<a href='http://www.postgresql.org/docs/8.4/static/functions-window.html'>window functions</a> here so that we get some better
detailed view of historic changes on each partition? With some evolution
figure in percentage from the previous partition of the same year,
accumulated size per partition and per year, yearly sum, you name it. Here's
another one you might want to try, ready for some tuning (schema name, table
name, etc):
</p><pre><code>WITH s AS (
  select relname, 
         pg_relation_size(c.oid) as size,
         pg_total_relation_size(c.oid) as tsize,
         substring(substring(relname from &#039;[0-9]{6}$&#039;) for 4)::bigint as year
    from pg_class c 
         join pg_namespace n on n.oid = c.relnamespace 
   where c.relkind = &#039;r&#039;
     -- and n.nspname = &#039;public&#039;
     -- and c.relname ~ &#039;stats&#039; 
     and substring(substring(relname from &#039;[0-9]{6}$&#039;) for 4)::bigint &gt;= 2008
order by relname
),
     sy AS (
  select relname, 
         size,
	 tsize,
         year,
         (sum(size) over w_year)::bigint as ysize,
         (sum(size) over w_month)::bigint as cumul,
	 (lag(size) over (order by relname))::bigint as previous 
    from s
  window w_year  as (partition by year),
         w_month as (partition by year order by relname)
),
     syp AS (
  select relname, 
         size, 
	 tsize,
	 rank() over (partition by year order by size desc) as rank,
         case when ysize = 0 then ysize 
	      else round(size / ysize::numeric * 100, 2) end as yp, 
         case when previous = 0 then previous
	      else round((size / previous::numeric - 1.0) * 100, 2) end as evol, 
         cumul, 
         year, 
         ysize
    from sy
)
  SELECT relname, 
         pg_size_pretty(size) as size,
         pg_size_pretty(tsize) as &quot;+indexes&quot;,
         evol, yp as &quot;% annuel&quot;, rank,
         pg_size_pretty(cumul) as cumul, year,
         pg_size_pretty(ysize) as &quot;yearly sum&quot;, 
         pg_size_pretty((sum(size) over())::bigint) as total
    FROM syp
ORDER BY relname;
</code></pre><p>Hope you'll find it useful, I certainly do!
</p>  </div>
  </div>
  </div>
  <div id="push"></div>
  </div>

<footer>
  <p>
    <small>Unless otherwise specified, the contents of
    <a href=../../../index.html>this website</a> are Copyright
    &#169;&#160; 2008-2013 <a href=/about>Dimitri Fontaine</a>, and are
    licensed for use under
    <a href=http://creativecommons.org/licenses/by-sa/3.0/
    rel=license><abbr title="Creative
    Commons">CC</abbr>&#160;<abbr title=Attribution>BY</abbr>-<abbr title=Share-Alike>SA</abbr>&#160;3.0</a>.</small>
  </p> 
</footer> 

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-47059482-1', 'tapoueh.org');
  ga('send', 'pageview');

</script>

</body>
</html>
