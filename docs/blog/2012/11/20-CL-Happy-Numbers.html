<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset=utf-8 /> 
    <meta name=viewport content="width=device-width" /> 
    <meta name="generator" content="Emacs Muse Blog" /> 
    <meta description="blog de Dimitri Fontaine, Expert PostgreSQL - 2ndQuadrant France" />
    <meta property="og:title" content="tapoueh.org"/>
    <meta property="og:type" content="non_profit"/>
    <meta property="og:url" content="http://tapoueh.org/blog/2012/11/20-CL-Happy-Numbers.html"/>
    <meta property="og:image" content="http://tapoueh.org/static/2ndQuadrant-cross.png"/>
    <meta property="og:site_name" content="Tapoueh"/>
    <meta property="fb:admins" content="545062436"/>

    <title>Expertise PostgreSQL</title>
    <link rel='stylesheet' type='text/css' media='all' href='../../../static/styles.css' />
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/bootstrap/css/bootstrap.min.css' />
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/FontAwesome/css/font-awesome.min.css' />

    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/highlight.js/styles/sunburst.css' />
    <script type='text/javascript' src='../../../static/highlight.js/highlight.pack.js'></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script type='text/javascript' src='../../../static/jquery-1.9.1.min.js'></script>
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/jqcloud.css' />
    <script type='text/javascript' src='../../../static/jqcloud-1.0.4.min.js'></script>

    <!-- <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/static/FontAwesome/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="/static/highlight.js/styles/sunburst.css">
    <script src="/static/highlight.js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script src="/static/jquery-1.9.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/jqcloud.css" />
    <script type="text/javascript" src="/static/jqcloud-1.0.4.min.js"></script>
    -->

    <script type="text/javascript" src="http://apis.google.com/js/plusone.js">{lang: 'fr'}</script>
    
  </head>
  <body>

   <div id="wrap">

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="nav-collapse collapse">
	<p class="pull-right">
	  <a href="http://2ndquadrant.com">
	    <img alt="logo" src="/static/2ndQuadrant-cross.png"
		 style="margin-right: 8px; margin-top: 4px; height: 32px;"/>
	  </a>
	</p>
	<div class="navbar-inner">
	 <a class="brand" style="margin-left: 0.2em; margin-top: -4px;"
	    href="http://expert-postgresql.fr/">
	  <img src="/static/expert-postgresql.png"></a>
	 <ul class="nav">
	   <li><a href="../../../blog/index.html">
               <i class="icon-book"></i> blog</a>
           </li>
	   <li><a href="../../../projects.html">
               <i class="icon-suitcase"></i> projects</a>
           </li>
	   <li><a href="../../../conferences.html">
               <i class="icon-plane"></i> confs</a>
           </li>
	   <li><a href="../../../about.html">
               <i class="icon-beer"></i> about</a>
           </li>
	   <li><a href="../../../rss/tapoueh.xml">
               <i class="icon-rss"></i> rss</a>
           </li>
	 </ul>
	</div>
      </div>
    </div>

    <div class="container">
      <div class="row">
	<div class="span4">
	  <div><ul class='breadcrumb'><li><span class='divider'><i class='icon-sitemap'></i></span></li><li><a href='../../../index.html'>/dev/dim</a><span class='divider'>/</span></li><li><a href='../../../blog/index.html'>blog</a><span class='divider'>/</span></li><li><a href='../../../blog/2012/index.html'>2012</a><span class='divider'>/</span></li><li><a href='../../../blog/2012/11/index.html'>11</a></li></ul></div>
	  <div class='date'>Tuesday, November 20 2012 <i class='icon-calendar'></i></div>
	  <div style='text-align: right;'><span><a href='../../../tags/common-lisp'>Common-Lisp</a></span> <i class='icon-tags'></i></div>
	  

	  <div style="margin-top: 1em;">
	    <div class='span2 pull-left'><a class='thumbnail' href='../../../tags/common-lisp.html'><img class='img-polaroid' style='width: 160px; height: 120px;' src='../../../thumbnails/made-with-lisp.png' /></a></div>
	    <div id='social' class='span1 pull-right social'><ul><li><g:plusone size='tall' href='http://tapoueh.org/blog/2012/11/20-CL-Happy-Numbers'></g:plusone></li><li><a href='http://twitter.com/share' class='twitter-share-button' data-via='tapoueh' data-count='vertical'>Tweet</a><script type='text/javascript' src='http://platform.twitter.com/widgets.js'></script></li></ul></div>
	  </div>

	  <div id="prevnext">
	    <h3 class='prevnext'>Recent Articles</h3>
	    <div><a class='previous' href='../../../blog/2012/11/06-About-vimgolf.html'>« About Vimgolf</a></div>
	    <div><a class='next pull-right' href='../../../blog/2012/11/22-Emacs-Ack-Mode.html'>M-x ack »</a></div>
	  </div>
	  
	  <div>
	    <div id="left-tag-cloud" class="jqcloud"
		 style="width: 300px; height: 650px; position: absolute; top: 475px;">
	    </div>
            <script>
            var word_list;
            
            $.ajax({
                type: 'GET',
                url: '/cloud.json',
                dataType: 'json',
                success: function(response) { word_list = response; },
                data: {},
                async: false
            });
             
            $(document).ready(function() {
               $("#left-tag-cloud").jQCloud(word_list,
	                {shape: "rectangular",
	                 removeOverflowing: false});
            });
            </script>
	  </div>

	</div>

	<div id="title" class="span8">
	  <h1>CL Happy Numbers</h1>
	</div>
	
	<div id="content" class="span8">
<p>A while ago I stumbled upon 
<a href='http://tapoueh.org/blog/2010/08/30-happy-numbers.html'>Happy Numbers</a> as explained in
<a href='http://programmingpraxis.com/2010/07/23/happy-numbers/'>programming praxis</a>, and offered an implementation of them in 
<code>SQL</code> and in
<code>Emacs Lisp</code>. Yeah, I know. Why not, though?
</p><center><img src='../../../images/happy-numbers.png' /></center><p>Today I'm back on that topic and as I'm toying with 
<em>Common Lisp</em> I though it
would be a good excuse to learn me some new tricks. As you can see from the
earlier blog entry, last time I did attack the 
<em>digits</em> problem quite lightly.
Let's try a better approach now.
</p><pre><code>(defun digits (n)
  &quot;return the list of the digits of N&quot;
  (nreverse
   (loop for x = n then r
      for (r d) = (multiple-value-list (truncate x 10))
      collect d
      until (zerop r))))
</code></pre><p>As you can see I wanted to use that facility I like very much, the 
<code>for
x = n then r</code> way to handle first loop iteration differently from the
next ones. But I've been hinted on 
<code>#lisp</code> that there's a much better way to
write same code:
</p><pre><code>(defun integer-digits (integer)
  &quot;stassats version&quot;
  (nreverse
   (loop with remainder
      do (setf (values integer remainder) (truncate integer 10))
      collect remainder
      until (zerop integer))))
</code></pre><p>That code runs about twice as fast as the previous one and is easier to
reason about. It's using 
<code>setf</code> and the form 
<a href='http://www.lispworks.com/documentation/lw51/CLHS/Body/f_values.htm'>setf values</a>, something nice to
discover as it seems to be quite powerful. Let's see how to use it, even if
it's really simple:
</p><pre><code>CL-USER&gt; (integer-digits 12304501)
(1 2 3 0 4 5 0 1)
</code></pre><p>Let's move on to solving the 
<em>Happy Numbers</em> problem though:
</p><pre><code>(defun sum-of-squares-of-digits (integer)
  (loop with remainder
     do (setf (values integer remainder) (truncate integer 10))
     sum (* remainder remainder)
     until (zerop integer)))

(defun happy? (n &amp;optional seen)
  &quot;return true when n is a happy number&quot;
  (let* ((happiness (sum-of-squares-of-digits n)))
    (cond ((eq 1 happiness)      t)
	  ((memq happiness seen) nil)
	  (t
	   (happy? happiness (push happiness seen))))))

(defun find-happy-numbers (limit)
  &quot;find all happy numbers from 1 to limit&quot;
  (loop for n from 1 to limit when (happy? n) collect n))
</code></pre><p>And here's how it goes:
</p><pre><code>CL-USER&gt; (find-happy-numbers 100)
(1 7 10 13 19 23 28 31 32 44 49 68 70 79 82 86 91 94 97 100)

CL-USER&gt; (time (length (find-happy-numbers 1000000)))
(LENGTH (FIND-HAPPY-NUMBERS 1000000))
took 1,621,413 microseconds (1.621413 seconds) to run.
       116,474 microseconds (0.116474 seconds, 7.18%) of which was spent in GC.
During that period, and with 4 available CPU cores,
     1,431,332 microseconds (1.431332 seconds) were spent in user mode
       145,941 microseconds (0.145941 seconds) were spent in system mode
 185,438,208 bytes of memory allocated.
 1 minor page faults, 0 major page faults, 0 swaps.
143071
</code></pre><p>Of course that code is much faster than the one I wrote before both in 
<code>SQL</code>
and 
<em>Emacs Lisp</em>, the reason being that instead of writing the number into a
<em>string</em> with 
<code>(format t &quot;~d&quot; number)</code> then 
<a href='http://www.lispworks.com/documentation/HyperSpec/Body/f_subseq.htm'>subseq</a> to get them one after the
other, we're now using 
<a href='http://www.lispworks.com/documentation/HyperSpec/Body/f_floorc.htm'>truncate</a>.
</p><p>Happy hacking!
</p><h2>Update</h2><p>It turns out that to solve math related problem, some maths hindsight is
helping. Who would have believed that? So if you want to easily get some
more performances out of the previous code, just try that solution:
</p><pre><code>(defvar *depressed-squares* &#039;(0 4 16 20 37 42 58 89 145)
  &quot;see http://oeis.org/A039943&quot;)

(defun undepressed? (n)
  &quot;same as happy?, using a static list of unhappy sums&quot;
  (cond ((eq 1 n) t)
	((member n *depressed-squares*) nil)
	(t
	 (let ((h (sum-of-squares-of-digits n)))
	   (undepressed? h)))))

(defun find-undepressed-numbers (limit)
  &quot;find all happy numbers from 1 to limit&quot;
  (loop for n from 1 to limit when (undepressed? n) collect n))
</code></pre><p>Time to compare:
</p><pre><code>CL-USER&gt; (time (length (find-happy-numbers 1000000)))
(LENGTH (FIND-HAPPY-NUMBERS 1000000))
took 1,938,048 microseconds (1.938048 seconds) to run.
       290,902 microseconds (0.290902 seconds, 15.01%) of which was spent in GC.
During that period, and with 4 available CPU cores,
     1,778,021 microseconds (1.778021 seconds) were spent in user mode
       140,862 microseconds (0.140862 seconds) were spent in system mode
 185,438,208 bytes of memory allocated.
 3,320 minor page faults, 0 major page faults, 0 swaps.
143071

CL-USER&gt; (time (length (find-undepressed-numbers 1000000)))
(LENGTH (FIND-UNDEPRESSED-NUMBERS 1000000))
took 1,036,847 microseconds (1.036847 seconds) to run.
         5,372 microseconds (0.005372 seconds, 0.52%) of which was spent in GC.
During that period, and with 4 available CPU cores,
     1,018,708 microseconds (1.018708 seconds) were spent in user mode
        16,982 microseconds (0.016982 seconds) were spent in system mode
 2,289,152 bytes of memory allocated.
143071
CL-USER&gt; 
</code></pre>  </div>
  </div>
  </div>
  <div id="push"></div>
  </div>

<footer>
  <p>
    <small>Unless otherwise specified, the contents of
    <a href=../../../index.html>this website</a> are Copyright
    &#169;&#160; 2008-2013 <a href=/about>Dimitri Fontaine</a>, and are
    licensed for use under
    <a href=http://creativecommons.org/licenses/by-sa/3.0/
    rel=license><abbr title="Creative
    Commons">CC</abbr>&#160;<abbr title=Attribution>BY</abbr>-<abbr title=Share-Alike>SA</abbr>&#160;3.0</a>.</small>
  </p> 
</footer> 

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-47059482-1', 'tapoueh.org');
  ga('send', 'pageview');

</script>

</body>
</html>
