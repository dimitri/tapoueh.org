

  
    
  


  




  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.85.0">
    <meta name="theme" content="Tranquilpeak 0.3.1-BETA">
    <title>Fast and stupid?</title>
    <meta name="author" content="Dimitri Fontaine">
    <meta name="keywords" content="">

    <link rel="icon" href="/favicon.ico">
    

    
    <meta name="description" content="I stumbled onto an interesting article about performance when using python, called Python performance the easy(ish) way, where the author tries to get the bet available performances out of the dumbiest possible python code, trying to solve a very simple and stupid problem.
With so many smart qualifiers you can only guess that I did love the challenge. The idea is to write the simplest code possible and see how smarter you need to be when you need perfs.">
    <meta property="og:description" content="I stumbled onto an interesting article about performance when using python, called Python performance the easy(ish) way, where the author tries to get the bet available performances out of the dumbiest possible python code, trying to solve a very simple and stupid problem.
With so many smart qualifiers you can only guess that I did love the challenge. The idea is to write the simplest code possible and see how smarter you need to be when you need perfs.">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Fast and stupid?">
    <meta property="og:url" content="https://tapoueh.org/blog/2012/08/fast-and-stupid/">
    <meta property="og:site_name" content="The Art of PostgreSQL">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Fast and stupid?">
    <meta name="twitter:description" content="I stumbled onto an interesting article about performance when using python, called Python performance the easy(ish) way, where the author tries to get the bet available performances out of the dumbiest possible python code, trying to solve a very simple and stupid problem.
With so many smart qualifiers you can only guess that I did love the challenge. The idea is to write the simplest code possible and see how smarter you need to be when you need perfs.">
    
      <meta name="twitter:creator" content="@tapoueh">
    
    

    
    

    
      <meta property="og:image" content="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=640">
    

    
      <meta property="og:image" content="https://tapoueh.org/img/prog-lisp_icon-icons.png">
    
    
      <meta property="og:image" content="https://tapoueh.org/img/fast-stupid.jpg">
    
    

    

    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" />
    
    
    <link rel="stylesheet" href="/css/style-jsjn0006wyhpyzivf6yceb31gvpjatbcs3qzjvlumobfnugccvobqwxnnaj8.min.css" />
    
    
      <link rel="stylesheet" href="https://tapoueh.org/css/dim.css">
    
      <link rel="stylesheet" href="https://tapoueh.org/css/nav.css">
    

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-47059482-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="navbar-collapse collapse header-title" id="navigation">
    <ul class="nav navbar-nav navbar-right">
      
      <li class="dropdown">
        
        <a style="color: black;" href="/" alt="blog"><i class="sidebar-button-icon fa fa-lg fa-home"></i></a>
        
      </li>
      
      <li class="dropdown">
        
        <a style="color: black;" href="/conf/" alt="talks"><i class="sidebar-button-icon fa fa-lg fa-microphone"></i></a>
        
      </li>
      
      <li class="dropdown">
        
        <a style="color: black;" href="https://twitter.com/tapoueh" alt="Twitter"><i class="sidebar-button-icon fa fa-lg fa-twitter"></i></a>
        
      </li>
      
      <li class="dropdown">
        
        <a style="color: black;" href="http://theartofpostgresql.com" alt="The Art Of PostgreSQL"><i class="sidebar-button-icon fa fa-lg fa-book"></i></a>
        
      </li>
      
    </ul>
  </div>

  
    
      <a class="header-right-icon "
         href="https://theartofpostgresql.com/" target="_blank">
    
    
      <i class="fa fa-lg fa-book"></i>
    
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about">
          <img class="sidebar-profile-picture" src="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=110" alt="" />
        </a>
        <h4 class="sidebar-profile-name">Dimitri Fontaine</h4>
        
          <h5 class="sidebar-profile-bio">PostgreSQL Major Contributor</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/">
    
      <i class="sidebar-button-icon fa fa-lg fa-pagelines"></i>
      
      <span class="sidebar-button-desc">Blog</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/about/">
    
      <i class="sidebar-button-icon fa fa-lg fa-beer"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories/yesql/">
    
      <i class="sidebar-button-icon fa fa-lg fa-database"></i>
      
      <span class="sidebar-button-desc">YeSQL</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://theartofpostgresql.com" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-book"></i>
      
      <span class="sidebar-button-desc">The Art of PostgreSQL</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/dimitri" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/tapoueh" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      
  <div class="post-header-cover
              text-left
              post-header-cover--partial"
       style="background-image:url('/img/fast-stupid.jpg')"
       data-behavior="5">
    
      <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Fast and stupid?
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2012-08-22T16:05:00&#43;02:00">
        <span style="float: left; width: 35%">
          <i class="fa fa-calendar"></i> 
  
  
  
  
    Wednesday 22 Aug 2012
  

        </span>
      </time>
    
    <span style="float: right; width: 65%">
      <i class="fa fa-clock-o"></i> 6 mins read
      
    </span>
    <span style="float: left; width: 35%">
      <i class="fa fa-bookmark"></i> 
  
  
    <span></span>
    
      <a class="category-link" href="/categories/software-programming">Software Programming</a>, 
    
      <a class="category-link" href="/categories/common-lisp">Common Lisp</a>
    
  

    </span>
    <div>
      <p>
        
        
        <a href="/tags/common-lisp/">
          <i class="fa fa-tag"></i> Common-Lisp
        </a>
        
        
      </p>
    </div>
  </div>


</div>
    
  </div>


      <div id="main" data-behavior="5"
        class="hasCover
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              

<p>I stumbled onto an interesting article about performance when using python,
called
<a href="http://jiaaro.com/python-performance-the-easyish-way">Python performance the easy(ish) way</a>,
where the author tries to get the bet available performances out of the
dumbiest possible python code, trying to solve a very simple and stupid
problem.</p>

<p>With so many <em>smart</em> qualifiers you can only guess that I did love the
challenge. The idea is to write the simplest code possible and see how
smarter you need to be when you need perfs. Let&rsquo;s have a try!</p>

<h2 id="local-python-results">local python results</h2>

<p>Here&rsquo;s the code I did use to benchmark the python solution:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a">def</span> <span style="color:#0a0">sumrange</span>(arg):
    <span style="color:#00a">return</span> <span style="color:#0aa">sum</span>(xrange(arg))

<span style="color:#00a">def</span> <span style="color:#0a0">sumrange2</span>(arg):
    x = i = <span style="color:#099">0</span>
    <span style="color:#00a">while</span> i &lt; arg:
        x += i
        i += <span style="color:#099">1</span>
    <span style="color:#00a">return</span> x


<span style="color:#00a">import</span> <span style="color:#0aa;text-decoration:underline">ctypes</span>
ct_sumrange = ctypes.CDLL(<span style="color:#a50">&#39;/Users/dim/dev/CL/jiaroo/sumrange.so&#39;</span>)

<span style="color:#00a">def</span> <span style="color:#0a0">sumrange_ctypes</span>(arg):
    <span style="color:#00a">return</span> ct_sumrange.sumrange(arg)

<span style="color:#00a">if</span> __name__ == <span style="color:#a50">&#34;__main__&#34;</span>:
    <span style="color:#00a">import</span> <span style="color:#0aa;text-decoration:underline">timeit</span>
    t1 = timeit.Timer(<span style="color:#a50">&#39;import jiaroo; jiaroo.sumrange(10**10)&#39;</span>)
    t2 = timeit.Timer(<span style="color:#a50">&#39;import jiaroo; jiaroo.sumrange2(10**10)&#39;</span>)
    ct = timeit.Timer(<span style="color:#a50">&#39;import jiaroo; jiaroo.sumrange_ctypes(10**10)&#39;</span>)

    <span style="color:#0aa">print</span> <span style="color:#a50">&#39;timing python sumrange(10**10)&#39;</span>
    <span style="color:#0aa">print</span> <span style="color:#a50">&#39;xrange: </span><span style="color:#a50">%5f</span><span style="color:#a50">s&#39;</span> % t1.timeit(<span style="color:#099">1</span>)
    <span style="color:#0aa">print</span> <span style="color:#a50">&#39;while:  </span><span style="color:#a50">%5f</span><span style="color:#a50">s&#39;</span> % t2.timeit(<span style="color:#099">1</span>)
    <span style="color:#0aa">print</span> <span style="color:#a50">&#39;ctypes: </span><span style="color:#a50">%5f</span><span style="color:#a50">s&#39;</span> % ct.timeit(<span style="color:#099">1</span>)</code></pre></div>
<p>Oh. And the C code too, sorry about that.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#4c8317">#include</span> <span style="color:#4c8317">&lt;stdio.h&gt;</span><span style="color:#4c8317">
</span><span style="color:#4c8317"></span>
<span style="color:#0aa">int</span> <span style="color:#0a0">sumrange</span>(<span style="color:#0aa">int</span> arg)
{
    <span style="color:#0aa">int</span> i, x;
    x = <span style="color:#099">0</span>;

    <span style="color:#00a">for</span> (i = <span style="color:#099">0</span>; i &lt; arg; i++) {
        x = x + i;
    }
    <span style="color:#00a">return</span> x;
}</code></pre></div>
<p>And here&rsquo;s how I did compile it. The author of the inspiring article
insisted on stupid optimisation targets, I did follow him:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gcc -shared -Wl,-install_name,sumrange.so -o sumrange.so -fPIC sumrange.c -O0</code></pre></div>
<p>And here&rsquo;s the result I did get out of it:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ python jiaroo.py
timing python sumrange(10**10)
xrange: 927.039917s
<span style="color:#00a">while</span>:  2377.291237s
ctypes: 5.297124s</code></pre></div>
<p>Let&rsquo;s be fair, with <code>-O2</code> we get much better results:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">timing python sumrange(10**10)
ctypes: 1.065684s</code></pre></div>
<h2 id="common-lisp-to-the-rescue">Common Lisp to the rescue</h2>

<p>So let&rsquo;s have a try in Common Lisp, will you ask me, right?</p>

<p>Here&rsquo;s the code I did use, you can see three different tries:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="color:#aaa;font-style:italic">;;;; jiaroo.lisp</span>
<span style="color:#aaa;font-style:italic">;;;</span>
<span style="color:#aaa;font-style:italic">;;; See http://jiaaro.com/python-performance-the-easyish-way</span>
<span style="color:#aaa;font-style:italic">;;;</span>
<span style="color:#aaa;font-style:italic">;;; The goal here is to find out if CL needs to resort to C for very simple</span>
<span style="color:#aaa;font-style:italic">;;; optimisation tricks like python apparently needs too, unless using pypy</span>
<span style="color:#aaa;font-style:italic">;;; (to some extend).</span>

(<span style="color:#0aa">in-package</span> <span style="color:#00a">#:jiaroo</span>)

<span style="color:#aaa;font-style:italic">;;; &#34;jiaroo&#34; goes here. Hacks and glory await!</span>

(<span style="color:#0aa">defun</span> <span style="color:#a00">sumrange-loop</span> (<span style="color:#0a0">max</span>)
  <span style="color:#a50">&#34;return the sum of numbers from 1 to MAX&#34;</span>
  (<span style="color:#00a">let</span> ((<span style="color:#a00">sum</span> <span style="color:#099">0</span>))
    (<span style="color:#00a">declare</span> (<span style="color:#00a">type</span> (<span style="color:#0aa">and</span> <span style="color:#0aa">unsigned-byte</span> <span style="color:#0aa">fixnum</span>) <span style="color:#0a0">max</span> <span style="color:#a00">sum</span>)
	     (<span style="color:#00a">optimize</span> <span style="color:#a00">speed</span>))
    (<span style="color:#0aa">loop</span> <span style="color:#a00">for</span> <span style="color:#a00">i</span> <span style="color:#0aa">fixnum</span> <span style="color:#a00">from</span> <span style="color:#099">1</span> <span style="color:#a00">to</span> <span style="color:#0a0">max</span> <span style="color:#0aa">do</span> (<span style="color:#0aa">incf</span> <span style="color:#a00">sum</span> <span style="color:#a00">i</span>))))

(<span style="color:#0aa">defun</span> <span style="color:#a00">sumrange-dotimes</span> (<span style="color:#0a0">max</span>)
  <span style="color:#a50">&#34;return the sum of numbers from 1 to MAX&#34;</span>
  (<span style="color:#00a">let</span> ((<span style="color:#a00">sum</span> <span style="color:#099">0</span>))
    (<span style="color:#00a">declare</span> (<span style="color:#00a">type</span> (<span style="color:#0aa">and</span> <span style="color:#0aa">unsigned-byte</span> <span style="color:#0aa">fixnum</span>) <span style="color:#0a0">max</span> <span style="color:#a00">sum</span>)
	     (<span style="color:#00a">optimize</span> <span style="color:#a00">speed</span>))
    (<span style="color:#0aa">dotimes</span> (<span style="color:#a00">i</span> <span style="color:#0a0">max</span> <span style="color:#a00">sum</span>)
      (<span style="color:#0aa">incf</span> <span style="color:#a00">sum</span> <span style="color:#a00">i</span>))))

(<span style="color:#0aa">defun</span> <span style="color:#a00">pk-sumrange</span> (<span style="color:#0a0">max</span>)
  (<span style="color:#00a">declare</span> (<span style="color:#00a">type</span> (<span style="color:#0aa">and</span> <span style="color:#0aa">unsigned-byte</span> <span style="color:#0aa">fixnum</span>) <span style="color:#0a0">max</span>)
	   (<span style="color:#00a">optimize</span> <span style="color:#a00">speed</span>))
  (<span style="color:#00a">let</span> ((<span style="color:#a00">sum</span> <span style="color:#099">0</span>))
    (<span style="color:#00a">declare</span> (<span style="color:#00a">type</span> (<span style="color:#0aa">and</span> <span style="color:#0aa">fixnum</span> <span style="color:#0aa">unsigned-byte</span>) <span style="color:#a00">sum</span>))
    (<span style="color:#0aa">dotimes</span> (<span style="color:#a00">i</span> <span style="color:#0a0">max</span> <span style="color:#a00">sum</span>)
      (<span style="color:#0aa">setf</span> <span style="color:#a00">sum</span> (<span style="color:#0a0">logand</span> (<span style="color:#0a0">+</span> <span style="color:#a00">sum</span> <span style="color:#a00">i</span>) <span style="color:#a00">most-positive-fixnum</span>)))))

(<span style="color:#0aa">defmacro</span> <span style="color:#a00">timing</span> (<span style="color:#00a">&amp;body</span> <span style="color:#a00">forms</span>)
  <span style="color:#a50">&#34;return both how much real time was spend in body and its result&#34;</span>
  (<span style="color:#00a">let</span> ((<span style="color:#a00">start</span> (<span style="color:#0a0">gensym</span>))
	(<span style="color:#a00">end</span> (<span style="color:#0a0">gensym</span>))
	(<span style="color:#a00">result</span> (<span style="color:#0a0">gensym</span>)))
    `(<span style="color:#00a">let*</span> ((,<span style="color:#a00">start</span> (<span style="color:#0a0">get-internal-real-time</span>))
	    (,<span style="color:#a00">result</span> (<span style="color:#00a">progn</span> ,@<span style="color:#a00">forms</span>))
	    (,<span style="color:#a00">end</span> (<span style="color:#0a0">get-internal-real-time</span>)))
       (<span style="color:#0a0">values</span> ,<span style="color:#a00">result</span> (<span style="color:#0a0">/</span> (<span style="color:#0a0">-</span> ,<span style="color:#a00">end</span> ,<span style="color:#a00">start</span>) <span style="color:#a00">internal-time-units-per-second</span>)))))

(<span style="color:#0aa">defun</span> <span style="color:#a00">bench-sumrange</span> (<span style="color:#a00">power</span>)
  <span style="color:#a50">&#34;print execution time of both the previous functions&#34;</span>
  (<span style="color:#00a">let*</span> ((<span style="color:#0a0">max</span> (<span style="color:#0a0">expt</span> <span style="color:#099">10</span> <span style="color:#a00">power</span>))
	 (<span style="color:#a00">lp-time</span> (<span style="color:#0aa">multiple-value-bind</span> (<span style="color:#a00">r</span> <span style="color:#a00">s</span>) (<span style="color:#a00">timing</span> (<span style="color:#a00">sumrange-loop</span> <span style="color:#0a0">max</span>)) <span style="color:#a00">s</span>))
	 (<span style="color:#a00">dt-time</span> (<span style="color:#0aa">multiple-value-bind</span> (<span style="color:#a00">r</span> <span style="color:#a00">s</span>) (<span style="color:#a00">timing</span> (<span style="color:#a00">sumrange-dotimes</span> <span style="color:#0a0">max</span>)) <span style="color:#a00">s</span>))
	 (<span style="color:#a00">pk-time</span> (<span style="color:#0aa">multiple-value-bind</span> (<span style="color:#a00">r</span> <span style="color:#a00">s</span>) (<span style="color:#a00">timing</span> (<span style="color:#a00">pk-sumrange</span> <span style="color:#0a0">max</span>)) <span style="color:#a00">s</span>)))
    (<span style="color:#0a0">format</span> <span style="color:#a00">t</span> <span style="color:#a50">&#34;timing common lisp sumrange 10**~d~%&#34;</span> <span style="color:#a00">power</span>)
    (<span style="color:#0a0">format</span> <span style="color:#a00">t</span> <span style="color:#a50">&#34;loop:       ~2,3fs ~%&#34;</span> <span style="color:#a00">lp-time</span>)
    (<span style="color:#0a0">format</span> <span style="color:#a00">t</span> <span style="color:#a50">&#34;dotimes:    ~2,3fs ~%&#34;</span> <span style="color:#a00">dt-time</span>)
    (<span style="color:#0a0">format</span> <span style="color:#a00">t</span> <span style="color:#a50">&#34;pk dotimes: ~2,3fs ~%&#34;</span> <span style="color:#a00">pk-time</span>)))</code></pre></div>
<p>And here&rsquo;s the results:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="color:#a00">CL-USER&gt;</span> (<span style="color:#a00">bench-sumrange</span> <span style="color:#099">10</span>)
<span style="color:#a00">timing</span> <span style="color:#a00">common</span> <span style="color:#a00">lisp</span> <span style="color:#a00">sumrange</span> <span style="color:#a00">10**10</span>
<span style="color:#a00">loop:</span>       <span style="color:#a00">11.213s</span> 
<span style="color:#a00">dotimes:</span>    <span style="color:#a00">7.642s</span> 
<span style="color:#a00">pk</span> <span style="color:#a00">dotimes:</span> <span style="color:#a00">22.185s</span> 
<span style="color:#a00">NIL</span></code></pre></div>
<h2 id="discussion">Discussion</h2>

<p>So python is very slow. C is pretty fast. And Common Lisp just in the
middle. Honnestly I expected better performances from my beloved Common Lisp
here, but I didn&rsquo;t try very hard, by
using <a href="http://ccl.clozure.com/">Clozure Common Lisp</a> which is not the
quicker Common Lisp implementation around. For this very benchmark, if
you&rsquo;re seeking speed use either <a href="http://sbcl.org/">Steel Bank Common Lisp</a>
or <a href="http://www.clisp.org/">CLISP</a> which is known to have a pretty fast
bignums implementation (which you don&rsquo;t need in 64 bits in that game).</p>

<p>On the other hand, I think that having to go write a C plugin and deal with
how to compile and deploy it in the middle of a python script is something
to avoid. When using Common Lisp you don&rsquo;t need to resort to that for the
<em>runtime</em> to get down from python <em>xrange</em> implementation at <code>927.039917s</code>
down to the <em>dotimes</em> implementation taking <code>7.642s</code>. That&rsquo;s about <code>121</code>
times faster.</p>

<p>So while <code>C</code> is even better, and while I would like a Common Lisp guru to
show me how to get a better speed here, I still very much appreciate the
solution here.</p>

<p>Let&rsquo;s see the winning source code in <em>python</em> and <em>common lisp</em> to compare
the programmer side of things: how hard was it really to get <code>121</code> times
faster?</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a">def</span> <span style="color:#0a0">sumrange</span>(arg):
    <span style="color:#00a">return</span> <span style="color:#0aa">sum</span>(xrange(arg))</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#0aa">defun</span> <span style="color:#a00">sumrange-dotimes</span> (<span style="color:#0a0">max</span>)
  <span style="color:#a50">&#34;return the sum of numbers from 1 to MAX&#34;</span>
  (<span style="color:#00a">let</span> ((<span style="color:#a00">sum</span> <span style="color:#099">0</span>))
    (<span style="color:#00a">declare</span> (<span style="color:#00a">type</span> (<span style="color:#0aa">and</span> <span style="color:#0aa">unsigned-byte</span> <span style="color:#0aa">fixnum</span>) <span style="color:#0a0">max</span> <span style="color:#a00">sum</span>)
	     (<span style="color:#00a">optimize</span> <span style="color:#a00">speed</span>))
    (<span style="color:#0aa">dotimes</span> (<span style="color:#a00">i</span> <span style="color:#0a0">max</span> <span style="color:#a00">sum</span>)
      (<span style="color:#0aa">incf</span> <span style="color:#a00">sum</span> <span style="color:#a00">i</span>))))</code></pre></div>
<p>That&rsquo;s about it. Yes we can see some <em>manual</em> optimisation directives here,
which are optimisation <em>extra complexity</em>. Not to the same level as bringing
a compiled artifact that you need to build and deploy, though. Remember that
you will need to know the full path where to find the <code>sumrange.so</code> file on
the production system, in the optimised <em>python</em> case, so that&rsquo;s what we are
comparing against.</p>

<p>Here&rsquo;s what happens without the optimisation, and with a smaller target:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="color:#a00">CL-USER&gt;</span> (<span style="color:#0aa">time</span> (<span style="color:#a00">jiaroo:sumrange-dotimes</span> (<span style="color:#0a0">expt</span> <span style="color:#099">10</span> <span style="color:#099">9</span>)))
(<span style="color:#a00">JIAROO:SUMRANGE-DOTIMES</span> (<span style="color:#a00">EXPT</span> <span style="color:#099">10</span> <span style="color:#099">9</span>))
<span style="color:#a00">took</span> <span style="color:#099">722</span>,<span style="color:#099">592</span> <span style="color:#a00">microseconds</span> (<span style="color:#099">0.722592</span> <span style="color:#a00">seconds</span>) <span style="color:#a00">to</span> <span style="color:#a00">run.</span>
<span style="color:#a00">During</span> <span style="color:#a00">that</span> <span style="color:#a00">period,</span> <span style="color:#0aa">and</span> <span style="color:#a00">with</span> <span style="color:#099">2</span> <span style="color:#a00">available</span> <span style="color:#a00">CPU</span> <span style="color:#a00">cores,</span>
     <span style="color:#099">714</span>,<span style="color:#099">709</span> <span style="color:#a00">microseconds</span> (<span style="color:#099">0.714709</span> <span style="color:#a00">seconds</span>) <span style="color:#a00">were</span> <span style="color:#a00">spent</span> <span style="color:#a00">in</span> <span style="color:#a00">user</span> <span style="color:#a00">mode</span>
       <span style="color:#099">1</span>,<span style="color:#099">183</span> <span style="color:#a00">microseconds</span> (<span style="color:#099">0.001183</span> <span style="color:#a00">seconds</span>) <span style="color:#a00">were</span> <span style="color:#a00">spent</span> <span style="color:#a00">in</span> <span style="color:#a00">system</span> <span style="color:#a00">mode</span>
<span style="color:#099">499999999500000000</span>

<span style="color:#a00">CL-USER&gt;</span> (<span style="color:#0aa">time</span> (<span style="color:#00a">let</span> ((<span style="color:#a00">sum</span> <span style="color:#099">0</span>)) (<span style="color:#0aa">dotimes</span> (<span style="color:#a00">i</span> (<span style="color:#0a0">expt</span> <span style="color:#099">10</span> <span style="color:#099">9</span>) <span style="color:#a00">sum</span>) (<span style="color:#0aa">incf</span> <span style="color:#a00">sum</span> <span style="color:#a00">i</span>))))
(<span style="color:#a00">LET</span> ((<span style="color:#a00">SUM</span> <span style="color:#099">0</span>)) (<span style="color:#a00">DOTIMES</span> (<span style="color:#a00">I</span> (<span style="color:#a00">EXPT</span> <span style="color:#099">10</span> <span style="color:#099">9</span>) <span style="color:#a00">SUM</span>) (<span style="color:#a00">INCF</span> <span style="color:#a00">SUM</span> <span style="color:#a00">I</span>)))
<span style="color:#a00">took</span> <span style="color:#099">2</span>,<span style="color:#099">174</span>,<span style="color:#099">767</span> <span style="color:#a00">microseconds</span> (<span style="color:#099">2.174767</span> <span style="color:#a00">seconds</span>) <span style="color:#a00">to</span> <span style="color:#a00">run.</span>
<span style="color:#a00">During</span> <span style="color:#a00">that</span> <span style="color:#a00">period,</span> <span style="color:#0aa">and</span> <span style="color:#a00">with</span> <span style="color:#099">2</span> <span style="color:#a00">available</span> <span style="color:#a00">CPU</span> <span style="color:#a00">cores,</span>
     <span style="color:#099">2</span>,<span style="color:#099">156</span>,<span style="color:#099">549</span> <span style="color:#a00">microseconds</span> (<span style="color:#099">2.156549</span> <span style="color:#a00">seconds</span>) <span style="color:#a00">were</span> <span style="color:#a00">spent</span> <span style="color:#a00">in</span> <span style="color:#a00">user</span> <span style="color:#a00">mode</span>
        <span style="color:#099">10</span>,<span style="color:#099">225</span> <span style="color:#a00">microseconds</span> (<span style="color:#099">0.010225</span> <span style="color:#a00">seconds</span>) <span style="color:#a00">were</span> <span style="color:#a00">spent</span> <span style="color:#a00">in</span> <span style="color:#a00">system</span> <span style="color:#a00">mode</span>
<span style="color:#a00">499999999500000000</span></code></pre></div>
<p>We get a <code>3</code> times speed-up from those 2 lines of lisp optimisation
directives, which is pretty good. And it&rsquo;s exponential as I didn&rsquo;t have the
patience to actually wait until the non optimised <code>10^10</code> run finished, I
killed it.</p>

<h2 id="conclusion">Conclusion</h2>

<p>That&rsquo;s a case here where I don&rsquo;t know how to reach <code>C</code> level of performances
with Common Lisp, which could just be because I don&rsquo;t know yet how to do.</p>

<p>Still, getting a <code>121</code> times speedup when compared to the pure <em>python</em>
version of the code is pretty good and encourages me to continue diving into
Common Lisp.</p>

              
            </div>
          </div>
          <div style="margin-top: 1em;">
 <a href="https://theartofpostgresql.com" alt="The Art of PostgreSQL">
  <img src="/img/taopg-cta.jpg" style="width:90%; height: auto; margin-left: 5%">
 </a>
</div>

          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small"></span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/common-lisp/">Common-Lisp</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
 <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2012/08/el-get-4.1-is-out/" data-tooltip="El-Get 4.1 is out">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml"></span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2012/08/autumn-2012-conferences/" data-tooltip="Autumn 2012 Conferences">
          
            <span class="hide-xs hide-sm text-small icon-mr"></span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https%3a%2f%2ftapoueh.org%2fblog%2f2012%2f08%2ffast-and-stupid%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftapoueh.org%2fblog%2f2012%2f08%2ffast-and-stupid%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Fast%20and%20stupid%3f with @tapoueh: https%3a%2f%2ftapoueh.org%2fblog%2f2012%2f08%2ffast-and-stupid%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2021 Dimitri Fontaine. 
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        <div class="post-actions-wrap">
 <nav>
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2012/08/el-get-4.1-is-out/" data-tooltip="El-Get 4.1 is out">
          
            <i class="fa fa-angle-left"></i>
            <span class="hide-xs hide-sm text-small icon-ml"></span>
          </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/blog/2012/08/autumn-2012-conferences/" data-tooltip="Autumn 2012 Conferences">
          
            <span class="hide-xs hide-sm text-small icon-mr"></span>
            <i class="fa fa-angle-right"></i>
          </a>
        </li>
      
    </ul>
  </nav>
  <ul class="post-actions post-action-share">
    
      <li class="post-action hide-lg hide-md hide-sm">
        <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
          <i class="fa fa-share-alt"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https%3a%2f%2ftapoueh.org%2fblog%2f2012%2f08%2ffast-and-stupid%2f">
          <i class="fa fa-google-plus"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftapoueh.org%2fblog%2f2012%2f08%2ffast-and-stupid%2f">
          <i class="fa fa-facebook-official"></i>
        </a>
      </li>
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=Fast%20and%20stupid%3f with @tapoueh: https%3a%2f%2ftapoueh.org%2fblog%2f2012%2f08%2ffast-and-stupid%2f">
          <i class="fa fa-twitter"></i>
        </a>
      </li>
    
    
      <li class="post-action">
        <a class="post-action-btn btn btn--default" href="#disqus_thread">
          <i class="fa fa-comment-o"></i>
        </a>
      </li>
    
    <li class="post-action">
      
        <a class="post-action-btn btn btn--default" href="#">
      
        <i class="fa fa-list"></i>
      </a>
    </li>
  </ul>
</div>


      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <ul class="share-options">
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https%3a%2f%2ftapoueh.org%2fblog%2f2012%2f08%2ffast-and-stupid%2f">
        <i class="fa fa-google-plus"></i><span></span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftapoueh.org%2fblog%2f2012%2f08%2ffast-and-stupid%2f">
        <i class="fa fa-facebook-official"></i><span></span>
      </a>
    </li>
    <li class="share-option">
      <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=Fast%20and%20stupid%3f with @tapoueh: https%3a%2f%2ftapoueh.org%2fblog%2f2012%2f08%2ffast-and-stupid%2f">
        <i class="fa fa-twitter"></i><span></span>
      </a>
    </li>
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="//www.gravatar.com/avatar/7b615d104c506aa0a49e17151fa94d9f?s=110" alt="" />
    
    <h4 id="about-card-name">Dimitri Fontaine</h4>
    
      <div id="about-card-bio">PostgreSQL Major Contributor</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Open Source Software Engineer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        France
      </div>
    
  </div>
</div>

    

    
  
    
      
      <div id="cover" style="background-image:url('https://tapoueh.org/images/mayan-calendar.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js"></script>


<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/tapoueh.org\/blog\/2012\/08\/fast-and-stupid\/';
          
            this.page.identifier = '\/blog\/2012\/08\/fast-and-stupid\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'tapoueh';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  




    
  </body>
</html>

