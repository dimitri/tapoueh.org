<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset=utf-8 /> 
    <meta name=viewport content="width=device-width" /> 
    <meta name="generator" content="Emacs Muse Blog" /> 
    <meta description="blog de Dimitri Fontaine, Expert PostgreSQL - 2ndQuadrant France" />
    <meta property="og:title" content="tapoueh.org"/>
    <meta property="og:type" content="non_profit"/>
    <meta property="og:url" content="http://tapoueh.org/blog/2009/11/25-yet-another-postgresql-tool-hits-debian.html"/>
    <meta property="og:image" content="http://tapoueh.org/static/2ndQuadrant-cross.png"/>
    <meta property="og:site_name" content="Tapoueh"/>
    <meta property="fb:admins" content="545062436"/>

    <title>Expertise PostgreSQL</title>
    <link rel='stylesheet' type='text/css' media='all' href='../../../static/styles.css' />
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/bootstrap/css/bootstrap.min.css' />
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/FontAwesome/css/font-awesome.min.css' />

    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/highlight.js/styles/sunburst.css' />
    <script type='text/javascript' src='../../../static/highlight.js/highlight.pack.js'></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script type='text/javascript' src='../../../static/jquery-1.9.1.min.js'></script>
    <link rel='stylesheet' type='text/css' medial='all' href='../../../static/jqcloud.css' />
    <script type='text/javascript' src='../../../static/jqcloud-1.0.4.min.js'></script>

    <!-- <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/static/FontAwesome/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="/static/highlight.js/styles/sunburst.css">
    <script src="/static/highlight.js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script src="/static/jquery-1.9.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/jqcloud.css" />
    <script type="text/javascript" src="/static/jqcloud-1.0.4.min.js"></script>
    -->

    <script type="text/javascript" src="http://apis.google.com/js/plusone.js">{lang: 'fr'}</script>
    
  </head>
  <body>

   <div id="wrap">

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="nav-collapse collapse">
	<p class="pull-right">
	  <a href="http://2ndquadrant.com">
	    <img alt="logo" src="/static/2ndQuadrant-cross.png"
		 style="margin-right: 8px; margin-top: 4px; height: 32px;"/>
	  </a>
	</p>
	<div class="navbar-inner">
	 <a class="brand" style="margin-left: 0.2em; margin-top: -4px;"
	    href="http://expert-postgresql.fr/">
	  <img src="/static/expert-postgresql.png"></a>
	 <ul class="nav">
	   <li><a href="../../../blog/index.html">
               <i class="icon-book"></i> blog</a>
           </li>
	   <li><a href="../../../projects.html">
               <i class="icon-suitcase"></i> projects</a>
           </li>
	   <li><a href="../../../conferences.html">
               <i class="icon-plane"></i> confs</a>
           </li>
	   <li><a href="../../../about.html">
               <i class="icon-beer"></i> about</a>
           </li>
	   <li><a href="../../../rss/tapoueh.xml">
               <i class="icon-rss"></i> rss</a>
           </li>
	 </ul>
	</div>
      </div>
    </div>

    <div class="container">
      <div class="row">
	<div class="span4">
	  <div><ul class='breadcrumb'><li><span class='divider'><i class='icon-sitemap'></i></span></li><li><a href='../../../index.html'>/dev/dim</a><span class='divider'>/</span></li><li><a href='../../../blog/index.html'>blog</a><span class='divider'>/</span></li><li><a href='../../../blog/2009/index.html'>2009</a><span class='divider'>/</span></li><li><a href='../../../blog/2009/11/index.html'>11</a></li></ul></div>
	  <div class='date'>Wednesday, November 25 2009 <i class='icon-calendar'></i></div>
	  <div style='text-align: right;'><span><a href='../../../tags/debian'>debian</a>, <a href='../../../tags/release'>release</a>, <a href='../../../tags/backup'>backup</a>, <a href='../../../tags/restore'>restore</a>, <a href='../../../tags/pg_staging'>pg_staging</a>, <a href='../../../tags/9.1'>9.1</a></span> <i class='icon-tags'></i></div>
	  

	  <div style="margin-top: 1em;">
	    <div class='span2 pull-left'><a class='thumbnail' href='../../../tags/debian.html'><img class='img-polaroid' style='width: 160px; height: 120px;' src='../../../thumbnails/debian-logo.png' /></a></div>
	    <div id='social' class='span1 pull-right social'><ul><li><g:plusone size='tall' href='http://tapoueh.org/blog/2009/11/25-yet-another-postgresql-tool-hits-debian'></g:plusone></li><li><a href='http://twitter.com/share' class='twitter-share-button' data-via='tapoueh' data-count='vertical'>Tweet</a><script type='text/javascript' src='http://platform.twitter.com/widgets.js'></script></li></ul></div>
	  </div>

	  <div id="prevnext">
	    <h3 class='prevnext'>Recent Articles</h3>
	    <div><a class='previous' href='../../../blog/2009/11/09-pgdayeu-paris-it-was-awesome.html'>« PGDay.eu, Paris: it was awesome!</a></div>
	    <div><a class='next pull-right' href='../../../blog/2009/11/30-prefix-110.html'>prefix 1.1.0 »</a></div>
	  </div>
	  
	  <div>
	    <div id="left-tag-cloud" class="jqcloud"
		 style="width: 300px; height: 650px; position: absolute; top: 475px;">
	    </div>
            <script>
            var word_list;
            
            $.ajax({
                type: 'GET',
                url: '/cloud.json',
                dataType: 'json',
                success: function(response) { word_list = response; },
                data: {},
                async: false
            });
             
            $(document).ready(function() {
               $("#left-tag-cloud").jQCloud(word_list,
	                {shape: "rectangular",
	                 removeOverflowing: false});
            });
            </script>
	  </div>

	</div>

	<div id="title" class="span8">
	  <h1>Yet Another PostgreSQL tool hits debian</h1>
	</div>
	
	<div id="content" class="span8">
<p>So there it is, this newer contribution of mine that I presented at 
<a href='http://2009.pgday.eu'>PGDay</a> is
now in 
<code>debian NEW</code> queue. 
<a href='pgstaging.html'>pg_staging</a> will empower you with respect to what
you do about those nightly backups (
<code>pg_dump -Fc</code> or something).
</p><p>The tool provides a lot of commands to either 
<code>dump</code> or 
<code>restore</code> a database. It
comes with documentation covering about it all, except for the 
<em>londiste</em>
support part, which will be there in time for 
<code>1.0.0</code> release. The 
<a href='http://github.com/dimitri/pg_staging/blob/master/TODO'>Todo list</a>
is getting smaller and smaller, the version you'll soon find in 
<code>debian sid</code>
is already called 
<code>0.9</code>.
</p><p>So, how do you go about using this software, and what service it implements?
</p><h2>it's all about deriving a staging environment from your backups</h2><p>To validate backups, you want to restore them and check the database you get
from them. And your developers will want to sometime refresh the database
they're working with. And you could have both an integration environment and
a pre-live one: On the former, you develop new code atop a stable set of
data; while on the latter you test stable enough code (ready to go live) on
a set of data as near as live data as possible.
</p><p>And you want to be flexible about it, so that there's not a fulltime job to
handle retoring databases each and every days, for project A integration or
project B pre-live testing, or project C accounting snapshot. Or you name
it.
</p><p>And of course you want to have a single point of control of all your
databases. Let's call it the 
<em>controler</em>.
</p><h2>setting up pg_staging</h2><p>The 
<a href='pgstaging.html'>pg_staging</a> setup consists of one 
<code>pg_staging.ini</code> file wherein you
describe your different target databases (those 
<code>dev</code> and 
<code>prelive</code> ones), and
of course where to get the production backups from. Currently you have to
serve the backups file in a format suitable for 
<code>pg_restore</code> (that means you
use either 
<code>pg_dump -Ft</code> or 
<code>pg_dump -Fc</code>) on an 
<code>apache</code> folder. The produced
<code>HTML</code> will get parsed.
</p><p>So you setup the 
<code>DEFAULT</code> section with common settings, then one section per
target: the databases you want to restore. Tell 
<code>pg_staging</code> where they are
(
<code>host</code>), etc, and it'll be able to drive them.
</p><p>In order to being able to host more than a single restored dump on a staging
server, for the same database, we use 
<code>pgbouncer</code>:
</p><pre><code>pg_staging&gt; pgbouncer some_db.dev
              some_db      some_db_20091029 :5432
     some_db_20090717      some_db_20090717 :5432
     some_db_20091029      some_db_20091029 :5432
</code></pre><p>So as explained into the 
<code>pg_staging(1)</code> man page, you have to open
non-interactive 
<code>SSH</code> connection from the 
<em>controler</em> to the 
<em>hosts</em> where the
databases will get restored. Then you have to do a minimal setup pgbouncer
on the 
<em>hosts</em> with a 
<code>trust</code> connection. It'll get used from 
<code>pg_staging</code> for
adding newly restored database and have them accessible. Then you can also
<code>switch</code> the new database to being the virtual 
<em>some_db</em> so that you avoid
editing any connection string on your softwares.
</p><p>Also, install the 
<code>pgstaging-client</code> package on every host you target. The
client is a simple shell script that must run as root (
<code>sudo</code> is used) in
order to replace your 
<code>pgbouncer</code> setup or manage your 
<code>londiste</code> services.
</p><p>See 
<code>man 5 pg_staging</code> for available options, including 
<em>schemas</em> to filter out
either completely or just skipping data restoring in those.
</p><h2>pg_staging usage</h2><p>Now you're all setup, you can begin to enjoy using 
<code>pgstaging</code>. Enter the
console and see what you have in there.
</p><pre><code>$ pg_staging 
Welcome to pg_staging 0.9.
pg_staging&gt; databases
...
pg_staging&gt; restore some_db.dev
...
pg_staging&gt; pgbouncer some_db.dev
...
pg_staging&gt; dbsizes --all some_db.dev
...
pg_staging&gt; psql some_db.dev
some_db_20091125=# 
</code></pre><p>And as you can see in 
<code>man pg_staging</code> there are a lot of commands
already. You can for example obtain a new 
<em>pg_restore catalog</em> from a dump
file, with some 
<em>schemas</em> commented out. It will even comment out 
<code>triggers</code>
that are using a 
<code>function</code> which is defined in a filtered out 
<code>schema</code>, for
example a 
<code>PGQ</code> trigger. And much much more.
</p><p><a href='pgstaging.html'>pg_staging</a> will even allow you to 
<code>dump</code> your production databases, but
consider installing a separate instance of it on the machine serving the
backups to your local network thanks to an 
<code>apache</code> directory listing!
</p><h2>Roadmap to <code>1.0.0</code></h2><p>What's remain to be done is testing and having 
<code>PITR</code> based restoring to work,
and adding some documentation (tutorial, which this blog post about is; and
<em>londiste</em> support). At this point, unless some reader here asks for a new
feature (set), I'll consider 
<code>pg_staging</code> ready for 
<code>1.0.0</code>. After all, we're
using it about daily here :)
</p><p>Consider commenting, you should be able to easily spot my private mail
address...
</p>  </div>
  </div>
  </div>
  <div id="push"></div>
  </div>

<footer>
  <p>
    <small>Unless otherwise specified, the contents of
    <a href=../../../index.html>this website</a> are Copyright
    &#169;&#160; 2008-2013 <a href=/about>Dimitri Fontaine</a>, and are
    licensed for use under
    <a href=http://creativecommons.org/licenses/by-sa/3.0/
    rel=license><abbr title="Creative
    Commons">CC</abbr>&#160;<abbr title=Attribution>BY</abbr>-<abbr title=Share-Alike>SA</abbr>&#160;3.0</a>.</small>
  </p> 
</footer> 

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-47059482-1', 'tapoueh.org');
  ga('send', 'pageview');

</script>

</body>
</html>
