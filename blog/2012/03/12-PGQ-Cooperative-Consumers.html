<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset=utf-8 /> 
    <meta name=viewport content="width=device-width" /> 
    <meta name="generator" content="Emacs Muse Blog" /> 
    <meta description="blog de Dimitri Fontaine, Expert PostgreSQL - 2ndQuadrant France" />
    <meta property="og:title" content="tapoueh.org"/>
    <meta property="og:type" content="non_profit"/>
    <meta property="og:url" content="http://tapoueh.org/blog/2012/03/12-PGQ-Cooperative-Consumers"/>
    <meta property="og:image" content="http://tapoueh.org/static/2ndQuadrant-cross.png"/>
    <meta property="og:site_name" content="Tapoueh"/>
    <meta property="fb:admins" content="545062436"/>

    <title>Expertise PostgreSQL</title>
    <link rel='stylesheet' type='text/css' media='all' href='/static/styles.css' />

    <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/static/FontAwesome/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="/static/highlight.js/styles/sunburst.css">
    <script src="/static/highlight.js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script src="/static/jquery-1.9.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/jqcloud.css" />
    <script type="text/javascript" src="/static/jqcloud-1.0.4.min.js"></script>

    <script type="text/javascript" src="http://apis.google.com/js/plusone.js">{lang: 'fr'}</script>
    
  </head>
  <body>

   <div id="wrap">

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="nav-collapse collapse">
	<p class="pull-right">
	  <a href="http://2ndquadrant.com">
	    <img alt="logo" src="/static/2ndQuadrant-cross.png"
		 style="margin-right: 8px; margin-top: 4px; height: 32px;"/>
	  </a>
	</p>
	<div class="navbar-inner">
	 <a class="brand" style="margin-left: 0.2em; margin-top: -4px;"
	    href="http://expert-postgresql.fr/">
	  <img src="/static/expert-postgresql.png"></a>
	 <ul class="nav">
	  <li><a href="/blog"><i class="icon-book"></i> blog</a></li>
	  <li><a href="/projects"><i class="icon-suitcase"></i> projects</a></li>
	  <li><a href="/conferences"><i class="icon-plane"></i> confs</a></li>
	  <li><a href="/about"><i class="icon-beer"></i> about</a></li>
	  <li><a href="/rss/tapoueh.xml"><i class="icon-rss"></i> rss</a></li>
	 </ul>
	</div>
      </div>
    </div>

    <div class="container">
      <div class="row">
	<div class="span4">
	  <div><ul class='breadcrumb'><li><span class='divider'><i class='icon-sitemap'></i></span></li><li><a href='/'>/dev/dim</a><span class='divider'>/</span></li><li><a href='/blog'>blog</a><span class='divider'>/</span></li><li><a href='/blog/2012'>2012</a><span class='divider'>/</span></li><li><a href='/blog/2012/03'>03</a></li></ul></div>
	  <div class='date'>Monday, March 12 2012 <i class='icon-calendar'></i></div>
	  <div style='text-align: right;'><span><a href='/tags/postgresql'>PostgreSQL</a>, <a href='/tags/pgq'>PGQ</a></span> <i class='icon-tags'></i></div>
	  

	  <div style="margin-top: 1em;">
	    <div class='span2 pull-left'><a class='thumbnail' href='/tags/postgresql'><img class='img-polaroid' style='width: 160px; height: 120px;' src='/thumbnails/postgresql-elephant.small.png' /></a></div>
	    <div id='social' class='span1 pull-right social'><ul><li><g:plusone size='tall' href='http://tapoueh.org/blog/2012/03/12-PGQ-Cooperative-Consumers'></g:plusone></li><li><a href='http://twitter.com/share' class='twitter-share-button' data-via='tapoueh' data-count='vertical'>Tweet</a><script type='text/javascript' src='http://platform.twitter.com/widgets.js'></script></li></ul></div>
	  </div>

	  <div id="prevnext">
	    <h3 class='prevnext'>Recent Articles</h3>
	    <div><a class='previous' href='/blog/2012/03/08-extension-white-listing'>« Extension White Listing</a></div>
	    <div><a class='next pull-right' href='/blog/2012/04/26-unregister-subconsumers'>Clean PGQ Subconsumers »</a></div>
	  </div>
	  
	  <div>
	    <div id="left-tag-cloud" class="jqcloud"
		 style="width: 300px; height: 650px; position: absolute; top: 475px;">
	    </div>
            <script>
            var word_list;
            
            $.ajax({
                type: 'GET',
                url: '/cloud.json',
                dataType: 'json',
                success: function(response) { word_list = response; },
                data: {},
                async: false
            });
             
            $(document).ready(function() {
               $("#left-tag-cloud").jQCloud(word_list,
	                {shape: "rectangular",
	                 removeOverflowing: false});
            });
            </script>
	  </div>

	</div>

	<div id="title" class="span8">
	  <h1>PGQ Coop Consumers</h1>
	</div>
	
	<div id="content" class="span8">
<p>While working a new 
<a href='http://www.postgresql.org/'>PostgreSQL</a> architecture for an high scale project that
used to be in the top 10 of internet popular web sites (in terms of
visitors), I needed to be able to off load some processing from the main
path: that's called a 
<em>batch job</em>. This needs to be 
<em>transactional</em>: don't run
the job if we did 
<code>rollback;</code> the transaction, process all 
<em>events</em> that were
part of the same transaction in the same transaction, etc.
</p><center><img src='../../../images/workers.jpg' /></center><p>That calls for using 
<a href='http://wiki.postgresql.org/wiki/PGQ_Tutorial'>PGQ</a>, the 
<em>jobs queue</em> solution from 
<a href='http://wiki.postgresql.org/wiki/Skytools'>Skytools</a>, the power
horse for 
<a href='http://wiki.postgresql.org/wiki/Londiste_Tutorial'>Londiste</a>. If 
<code>PGQ</code> is good enough to build a full trigger-based
replication solution on top of it, certainly it's good enough for our custom
processing, right? Well, you still need to check that your expectations are
met, and that was happily the case in my implementation. It's a very common
problem, and 
<code>PGQ</code> very often is a great solution to it.
</p><p>As this implementation is 
<code>PHP</code> centric, we've been using 
<a href='https://github.com/dimitri/libphp-pgq'>libphp-pgq</a> to drive
our background workers. Using 
<code>PGQ</code> in 
<code>PHP</code> has been very easy to setup, the
only trap being not to forget about running the 
<em>ticker</em> process.
</p><p>It got interesting because of two elements. First, we're nor running a
single database instance here but a bunch of them... make it 
<em>256 databases</em>.
Each of them having 
<code>5</code> queues to consume, that would be about 
<code>1280</code> consumer
processes, distributed on 
<code>16</code> servers that's still 
<code>80</code> per server, so way too
many. What we did instead is reuse the 
<a href='https://github.com/markokr/skytools/blob/master/scripts/queue_mover.py'>queue mover</a> script found in the
Skytools distribution and adapt it to 
<em>forward</em> the event of the 1280 source
queues to only 5 destination queues. We then process the events from this
single location.
</p><p>Now it's easier to deal with, but we're not still exactly there. Of course,
with so many sources, concentrating them all into the same place means that
a single consumer is not able to process the events as fast as they are
produced. That's where the 
<em>cooperative consuming</em> shines, it's very easy to
turn your 
<em>consumer</em> into a 
<em>cooperative</em> one even on an existing and running
queue, and that's what we did. So now we can choose how many 
<em>workers</em> we want
per queue: one of them has 4 workers, another one see not so much activity
and 1 worker still fits.
</p><center><img src='../../../images/coop-workers.jpeg' /></center><p>The queue mover script that knows how to subscribe to many queues from the
same process is going to be contributed to Skytools proper, of course.
</p>  </div>
  </div>
  </div>
  <div id="push"></div>
  </div>

<footer>
  <p>
    <small>Unless otherwise specified, the contents of
    <a href=/index.html>this website</a> are Copyright
    &#169;&#160; 2008-2013 <a href=/about>Dimitri Fontaine</a>, and are
    licensed for use under
    <a href=http://creativecommons.org/licenses/by-sa/3.0/
    rel=license><abbr title="Creative
    Commons">CC</abbr>&#160;<abbr title=Attribution>BY</abbr>-<abbr title=Share-Alike>SA</abbr>&#160;3.0</a>.</small>
  </p> 
</footer> 

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-47059482-1', 'tapoueh.org');
  ga('send', 'pageview');

</script>

</body>
</html>
